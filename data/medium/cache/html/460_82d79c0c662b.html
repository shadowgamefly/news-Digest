<!DOCTYPE html><html xmlns:cc="http://creativecommons.org/ns#"><head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# medium-com: http://ogp.me/ns/fb/medium-com#"><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Designing post request on Android – Harshit Bangar – Medium</title><link rel="canonical" href="https://medium.com/@harshitbangar/designing-post-request-on-android-82d79c0c662b"><meta name="title" content="Designing post request on Android – Harshit Bangar – Medium"><meta name="referrer" content="unsafe-url"><meta name="description" content="Recently I was writing an image/video upload/download task. Turns out it is much harder than expected. As a naive developer I started with an anonymous AsyncTask. Looks perfect, huh. Not exactly, a…"><meta property="og:title" content="Designing post request on Android – Harshit Bangar – Medium"><meta property="og:url" content="https://medium.com/@harshitbangar/designing-post-request-on-android-82d79c0c662b"><meta property="fb:app_id" content="542599432471018"><meta property="og:description" content="Recently I was writing an image/video upload/download task. Turns out it is much harder than expected. As a naive developer I started with…"><meta name="twitter:description" content="Recently I was writing an image/video upload/download task. Turns out it is much harder than expected. As a naive developer I started with…"><link rel="publisher" href="https://plus.google.com/103654360130207659246"><link rel="author" href="https://medium.com/@harshitbangar"><meta property="author" content="Harshit Bangar"><meta property="og:type" content="article"><meta name="twitter:card" content="summary"><meta property="article:publisher" content="https://www.facebook.com/medium"><meta property="article:author" content="https://medium.com/@harshitbangar"><meta property="fb:smart_publish:robots" content="noauto"><meta name="robots" content="index, follow"><meta property="article:published_time" content="2016-01-15T17:56:31.073Z"><meta name="twitter:site" content="@Medium"><meta property="og:site_name" content="Medium"><meta name="twitter:label1" value="Reading time"><meta name="twitter:data1" value="6 min read"><script type="application/ld+json">{"@context":"http://schema.org","@type":"NewsArticle","image":{"@type":"ImageObject","width":1920,"height":534,"url":"https://cdn-images-1.medium.com/max/1920/1*5ztbgEt4NqpVaxTc64C-XA.png"},"datePublished":"2016-01-15T17:56:31.073Z","dateModified":"2016-11-15T18:36:58.087Z","headline":"Designing post request on Android","name":"Designing post request on Android","keywords":["Android","Android App Development","Rest Api"],"author":{"@type":"Person","name":"Harshit Bangar","url":"https://medium.com/@harshitbangar"},"creator":["Harshit Bangar"],"mainEntityOfPage":"https://medium.com/@harshitbangar/designing-post-request-on-android-82d79c0c662b"}</script><meta name="twitter:app:name:iphone" content="Medium"><meta name="twitter:app:id:iphone" content="828256236"><meta name="twitter:app:url:iphone" content="medium://p/82d79c0c662b"><meta property="al:ios:app_name" content="Medium"><meta property="al:ios:app_store_id" content="828256236"><meta property="al:android:package" content="com.medium.reader"><meta property="al:android:app_name" content="Medium"><meta property="al:ios:url" content="medium://p/82d79c0c662b"><meta property="al:android:url" content="medium://p/82d79c0c662b"><meta property="al:web:url" content="https://medium.com/@harshitbangar/designing-post-request-on-android-82d79c0c662b"><link rel="search" type="application/opensearchdescription+xml" title="Medium" href="/osd.xml" /><link rel="alternate" href="android-app://com.medium.reader/https/medium.com/p/82d79c0c662b" /><meta name="theme-color" content="#000000"><link rel="stylesheet" href="https://cdn-static-1.medium.com/_/fp/css/main-base.g2e09PlZK_j3Lw2AgNmbfQ.css"><script>if (window.top !== window.self) window.top.location = window.self.location.href;var OB_startTime = new Date().getTime(); var OB_loadErrors = []; function _onerror(e) { OB_loadErrors.push(e) }; if (document.addEventListener) document.addEventListener("error", _onerror, true); else if (document.attachEvent) document.attachEvent("onerror", _onerror); function _asyncScript(u) {var d = document, f = d.getElementsByTagName("script")[0], s = d.createElement("script"); s.type = "text/javascript"; s.async = true; s.src = u; f.parentNode.insertBefore(s, f);}function _asyncStyles(u) {var d = document, f = d.getElementsByTagName("script")[0], s = d.createElement("link"); s.rel = "stylesheet"; s.href = u; f.parentNode.insertBefore(s, f); return s}var _gaq = _gaq || [];_gaq.push(["_setAccount", "UA-24232453-2"]); _gaq.push(["_setDomainName", window.location.hostname]); _gaq.push(["_setAllowLinker", true]); _gaq.push(["_trackPageview"]);_asyncScript(("https:" == document.location.protocol ? "https://ssl" : "http://www") + ".google-analytics.com/ga.js");(new Image()).src = "/_/stat?event=pixel.load&origin=" + encodeURIComponent(location.origin);</script><script>(function () {var height = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight; var width = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth; document.write("<style>section.section-image--fullBleed.is-backgrounded {padding-top: " + Math.round(1.1 * height) + "px;}section.section-image--fullScreen.is-backgrounded, section.section-image--coverFade.is-backgrounded {min-height: " + height + "px; padding-top: " + Math.round(0.5 * height) + "px;}.u-sizeViewHeight100 {height: " + height + "px !important;}.u-sizeViewHeight110 {height: " + Math.round(1.1 * height) + "px !important;}.u-sizeViewHeightMin100 {min-height: " + height + "px !important;}.u-sizeViewHeightMax100 {max-height: " + height + "px !important;}section.section-image--coverFade {height: " + height + "px;}.section-aspectRatioViewportPlaceholder, .section-aspectRatioViewportCropPlaceholder {max-height: " + height + "px;}.section-aspectRatioViewportBottomSpacer, .section-aspectRatioViewportBottomPlaceholder {max-height: " + Math.round(0.5 * height) + "px;}.zoomable:before {top: " + (-1 * height) + "px; left: " + (-1 * width) + "px; padding: " + height + "px " + width + "px;}</style>");})()</script><!--[if lt IE 9]><script charset="UTF-8" src="https://cdn-static-1.medium.com/_/fp/js/shiv.RI2ePTZ5gFmMgLzG5bEVAA.js"></script><![endif]--><link rel="icon" href="https://cdn-static-1.medium.com/_/fp/icons/favicon-medium.TAS6uQ-Y7kcKgi0xjcYHXw.ico" class="js-favicon"><link rel="apple-touch-icon" sizes="152x152" href="https://cdn-images-1.medium.com/fit/c/152/152/1*W0nmth_X8nFKjn6BZ388UQ.png"><link rel="apple-touch-icon" sizes="120x120" href="https://cdn-images-1.medium.com/fit/c/120/120/1*W0nmth_X8nFKjn6BZ388UQ.png"><link rel="apple-touch-icon" sizes="76x76" href="https://cdn-images-1.medium.com/fit/c/76/76/1*W0nmth_X8nFKjn6BZ388UQ.png"><link rel="apple-touch-icon" sizes="60x60" href="https://cdn-images-1.medium.com/fit/c/60/60/1*W0nmth_X8nFKjn6BZ388UQ.png"><link rel="mask-icon" href="https://cdn-static-1.medium.com/_/fp/icons/favicon.KjTfUJo7yJH_fCoUzzH3cg.svg" color="#171717"></head><body itemscope class=" postShowScreen is-noJs"><script>document.body.className = document.body.className.replace(/(^|\s)is-noJs(\s|$)/, "$1is-js$2")</script><div class="site-main" id="container"><div class="butterBar butterBar--error"></div><div class="surface"><div id="prerendered" class="screenContent"><canvas class="canvas-renderer"></canvas><div class="container u-maxWidth740 u-xs-margin0 notesPositionContainer js-notesPositionContainer"></div><div class="metabar u-clearfix js-metabar"><div class="metabar-inner u-marginAuto u-maxWidth1000 u-paddingLeft20 u-paddingRight20 js-metabarMiddle"><div class="metabar-block metabar-block--left u-floatLeft u-height65 u-xs-height56"><a href="https://medium.com/" class="siteNav-logo" data-log-event="home"><span class="svgIcon svgIcon--logoNew svgIcon--45px is-flushLeft"><svg class="svgIcon-use" width="45" height="45"  viewBox="-17 18 45 45" data-multipart="true"><path d="M11.525 28.078c-.472-.225-.858.002-.858.506v20.044l8.616 4.113c.948.46 1.717.14 1.717-.7v-19.3a.22.22 0 0 0-.124-.19l-9.35-4.46v-.01z"/><path d="M.333 43.696l9.83-15.247c.278-.43.89-.6 1.36-.38l9.364 4.47c.06.03.082.1.047.15L10.666 48.63.333 43.698v-.002z"/><path d="M-8.57 28.35c-.786-.375-1.053-.096-.592.62L.333 43.696l10.333 4.932L.356 32.635a.156.156 0 0 0-.06-.054l-8.866-4.23z"/><path d="M.333 52.033c0 .84-.643 1.22-1.43.844l-8.045-3.84c-.472-.224-.858-.82-.858-1.325V28.89c0-.672.515-.976 1.145-.675l9.133 4.36a.092.092 0 0 1 .055.084v19.37z"/></svg></span><span class="u-textScreenReader">Homepage</span></a></div><div class="metabar-block u-floatRight u-xs-absolute u-xs-textAlignRight u-xs-right0 u-xs-marginRight20 u-height65 u-xs-height56"><div class="buttonSet"><a class="button button--primary button--chromeless u-accentColor--buttonNormal is-inSiteNavBar u-lineHeight30 u-height32"  href="https://medium.com/m/signin?redirect=https%3A%2F%2Fmedium.com%2F%40harshitbangar%2Fdesigning-post-request-on-android-82d79c0c662b" data-action="sign-in-prompt" data-redirect="https://medium.com/@harshitbangar/designing-post-request-on-android-82d79c0c662b" data-action-source="nav_signup">Sign in / Sign up</a></div></div></div></div><div class="metabar metabar--spacer js-metabarSpacer u-height65 u-xs-height56"></div><main role="main"><article class=" u-sizeViewHeightMin100 u-overflowHidden postArticle postArticle--full u-marginBottom40"  lang="en"><header class="container u-maxWidth740"><div class="postMetaHeader u-paddingBottom10 row"><div class="col u-size12of12 js-postMetaLockup"><div class="postMetaLockup postMetaLockup--authorWithBio u-flex js-postMetaLockup"><div class="u-flex0"><a class="link avatar u-baseColor--link"  href="https://medium.com/@harshitbangar?source=post_header_lockup" data-action="show-user-card" data-action-source="post_header_lockup" data-action-value="1dffe67e8a90" data-action-type="hover" data-user-id="1dffe67e8a90" dir="auto"><img  src="https://cdn-images-1.medium.com/fit/c/40/40/0*MdSbGPtrzTSdC0yV.jpg" class="avatar-image avatar-image--smaller" alt="Go to the profile of Harshit Bangar"></a></div><div class="u-flex1 u-paddingLeft15 u-overflowHidden"><a class="link link link--darken link--darker u-baseColor--link"  href="https://medium.com/@harshitbangar?source=post_header_lockup" data-action="show-user-card" data-action-source="post_header_lockup" data-action-value="1dffe67e8a90" data-action-type="hover" data-user-id="1dffe67e8a90" dir="auto">Harshit Bangar</a><span class="followState js-followState buttonSet-inner" data-user-id="1dffe67e8a90"><button class="button u-paddingLeft10 u-paddingRight10 u-height19 u-lineHeight13 u-verticalAlignMiddle u-fontSize12 u-uiTextMedium u-noUserSelect button--withChrome u-baseColor--buttonNormal button--withHover button--unblock js-unblockButton u-marginLeft10 u-marginTopNegative2 u-xs-hide"  data-action="sign-in-prompt" data-sign-in-action="toggle-block-user" data-requires-token="true" data-action-source="post_header_lockup"><span class="button-label  button-defaultState">Blocked</span><span class="button-label button-hoverState">Unblock</span></button><button class="button button--primary u-paddingLeft10 u-paddingRight10 u-height19 u-lineHeight13 u-verticalAlignMiddle u-fontSize12 u-uiTextMedium u-noUserSelect button--withChrome u-accentColor--buttonNormal button--follow js-followButton u-marginLeft10 u-marginTopNegative2 u-xs-hide"  data-action="sign-in-prompt" data-sign-in-action="toggle-subscribe-user" data-requires-token="true" data-redirect="https://medium.com/_/subscribe/user/1dffe67e8a90" data-action-source="post_header_lockup_follow"><span class="button-label  button-defaultState js-buttonLabel">Follow</span><span class="button-label button-activeState">Following</span></button></span><div class="postMetaInline js-testPostMetaInlineSupplemental"><time datetime="2016-01-15T17:56:31.073Z">Jan 15, 2016</time><span class="middotDivider u-fontSize12"></span><span class="readingTime" title="6 min read"></span></div></div></div></div></div></header><div class="postArticle-content js-postField js-notesSource js-trackedPost"  data-post-id="82d79c0c662b" data-source="post_page" data-tracking-context="postPage"><section name="fbf2" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h1 name="4d75" id="4d75" class="graf graf--h3 graf--leading graf--title">Designing post request on Android</h1><p name="0e47" id="0e47" class="graf graf--p graf-after--h3">Recently I was writing an image/video upload/download task. Turns out it is much harder than expected. As a naive developer I started with an anonymous <strong class="markup--strong markup--p-strong">AsyncTask.</strong></p><pre name="ccdd" id="ccdd" class="graf graf--pre graf-after--p">public class MyActivity extends Activity {<br> (new AsyncTask &lt; ImageView, Integer, String &gt; () {<br> <a href="http://twitter.com/Override" data-href="http://twitter.com/Override" class="markup--anchor markup--pre-anchor" title="Twitter profile for @Override" rel="nofollow noopener" target="_blank">@Override</a><br> protected String doInBackground(ImageView…params) {<br> // Rest-Api call goes here</pre><pre name="7de9" id="7de9" class="graf graf--pre graf-after--pre">}.execute(myImageView);</pre><pre name="6de4" id="6de4" class="graf graf--pre graf-after--pre">}</pre><p name="3bed" id="3bed" class="graf graf--p graf-after--pre">Looks perfect, huh. Not exactly, a big issue is that the inner class contains the reference to it’s parent. If the inner class lives long enough it can lead to a potential memory leaks.</p><p name="9a4a" id="9a4a" class="graf graf--p graf-after--p">Solutions: Either cancel the AsnycTask(s) or make it a static inner/outer class and use the application context. Neither of two are foolproof and ugly. Image, 10 async tasks for downloading images and in on pause iterating over each of them to cancel. <strong class="markup--strong markup--p-strong">Ugly!! </strong>Pros - None (or simple) Cons - Everything else.</p><p name="5f1e" id="5f1e" class="graf graf--p graf-after--p">Moving away to something more sensible - <strong class="markup--strong markup--p-strong">Services. </strong>Using an intent service to upload task and notifying the activity using event bus or listeners. Pros- Separated your tasks from activity thus not interrupted by lifecycle. There are few more but we are going to unwrap them later. Cons - Single threaded. Imagining 100 images, download on slow network.</p><p name="fce5" id="fce5" class="graf graf--p graf-after--p">Solution - Making it multithreaded. Taking the approach from - <a href="https://github.com/alexbbb/android-upload-service" data-href="https://github.com/alexbbb/android-upload-service" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">https://github.com/alexbbb/android-upload-service</a> , here is my service. Using a threadpool executor with hashmap of task-id vs task, we can easily create a multithreaded service.</p><pre name="03c7" id="03c7" class="graf graf--pre graf-after--p">package com.alexbbb.uploadservice;<br><br>import android.app.Notification;<br>import android.app.Service;<br>import android.content.Intent;<br>import android.os.IBinder;<br>import android.os.PowerManager;<br>import android.util.Log;<br><br>import java.util.Iterator;<br>import java.util.Map;<br>import java.util.concurrent.BlockingQueue;<br>import java.util.concurrent.ConcurrentHashMap;<br>import java.util.concurrent.LinkedBlockingQueue;<br>import java.util.concurrent.ThreadPoolExecutor;<br>import java.util.concurrent.TimeUnit;<br><br>/**<br> * Service to upload files in background using HTTP POST with notification center progress<br> * display.<br> *<br> * @author alexbbb (Aleksandar Gotev)<br> * @author eliasnaur<br> * @author cankov<br> * @author mabdurrahman<br> */<br>public class UploadService extends Service {<br><br>    private static final String TAG = UploadService.class.getSimpleName();<br><br>    // configurable values<br>    /**<br>     * Sets how many threads to use to handle concurrent uploads.<br>     */<br>    public static int UPLOAD_POOL_SIZE = Runtime.getRuntime().availableProcessors();<br><br>    /**<br>     * When the number of threads is greater than UPLOAD_POOL_SIZE, this is the maximum time that<br>     * excess idle threads will wait for new tasks before terminating.<br>     */<br>    public static int KEEP_ALIVE_TIME_IN_SECONDS = 1;<br><br>    /**<br>     * If set to true, the service will go in foreground mode when doing uploads,<br>     * lowering the probability of being killed by the system on low memory.<br>     * This setting is used only when your uploads have a notification configuration.<br>     * It&#39;s not possible to run in foreground without notifications, as per Android policy<br>     * constraints, so if you set this to true, but you do upload tasks without a<br>     * notification configuration, the service will simply run in background mode.<br>     */<br>    public static boolean EXECUTE_IN_FOREGROUND = true;<br><br>    /**<br>     * Sets the namespace used to broadcast events. Set this to your app namespace to avoid<br>     * conflicts and unexpected behaviours.<br>     */<br>    public static String NAMESPACE = &quot;com.alexbbb&quot;;<br>    // end configurable values<br><br>    protected static final int UPLOAD_NOTIFICATION_BASE_ID = 1234; // Something unique<br><br>    private static final String ACTION_UPLOAD_SUFFIX = &quot;.uploadservice.action.upload&quot;;<br>    protected static final String PARAM_NOTIFICATION_CONFIG = &quot;notificationConfig&quot;;<br>    protected static final String PARAM_ID = &quot;id&quot;;<br>    protected static final String PARAM_URL = &quot;url&quot;;<br>    protected static final String PARAM_METHOD = &quot;method&quot;;<br>    protected static final String PARAM_FILES = &quot;files&quot;;<br>    protected static final String PARAM_FILE = &quot;file&quot;;<br>    protected static final String PARAM_TYPE = &quot;uploadType&quot;;<br><br>    protected static final String PARAM_REQUEST_HEADERS = &quot;requestHeaders&quot;;<br>    protected static final String PARAM_REQUEST_PARAMETERS = &quot;requestParameters&quot;;<br>    protected static final String PARAM_CUSTOM_USER_AGENT = &quot;customUserAgent&quot;;<br>    protected static final String PARAM_MAX_RETRIES = &quot;maxRetries&quot;;<br><br>    /**<br>     * The minimum interval between progress reports in milliseconds.<br>     * If the upload Tasks report more frequently, we will throttle notifications.<br>     * We aim for 6 updates per second.<br>     */<br>    protected static final long PROGRESS_REPORT_INTERVAL = 166;<br><br>    private static final String BROADCAST_ACTION_SUFFIX = &quot;.uploadservice.broadcast.status&quot;;<br>    public static final String UPLOAD_ID = &quot;id&quot;;<br>    public static final String STATUS = &quot;status&quot;;<br>    public static final int STATUS_IN_PROGRESS = 1;<br>    public static final int STATUS_COMPLETED = 2;<br>    public static final int STATUS_ERROR = 3;<br>    public static final int STATUS_CANCELLED = 4;<br>    public static final String PROGRESS = &quot;progress&quot;;<br>    public static final String PROGRESS_UPLOADED_BYTES = &quot;progressUploadedBytes&quot;;<br>    public static final String PROGRESS_TOTAL_BYTES = &quot;progressTotalBytes&quot;;<br>    public static final String ERROR_EXCEPTION = &quot;errorException&quot;;<br>    public static final String SERVER_RESPONSE_CODE = &quot;serverResponseCode&quot;;<br>    public static final String SERVER_RESPONSE_MESSAGE = &quot;serverResponseMessage&quot;;<br><br>    private PowerManager.WakeLock wakeLock;<br>    private int notificationIncrementalId = 0;<br>    private static final Map&lt;String, HttpUploadTask&gt; uploadTasksMap = new ConcurrentHashMap&lt;&gt;();<br>    private final BlockingQueue&lt;Runnable&gt; uploadTasksQueue = new LinkedBlockingQueue&lt;&gt;();<br>    private static volatile String foregroundUploadId = null;<br>    private ThreadPoolExecutor uploadThreadPool;<br><br>    protected static String getActionUpload() {<br>        return NAMESPACE + ACTION_UPLOAD_SUFFIX;<br>    }<br><br>    protected static String getActionBroadcast() {<br>        return NAMESPACE + BROADCAST_ACTION_SUFFIX;<br>    }<br><br>    /**<br>     * Stops the upload task with the given uploadId.<br>     * @param uploadId The unique upload id<br>     */<br>    public static synchronized void stopUpload(final String uploadId) {<br>        HttpUploadTask removedTask = uploadTasksMap.get(uploadId);<br>        if (removedTask != null) {<br>            removedTask.cancel();<br>        }<br>    }<br><br>    /**<br>     * Stop all the active uploads.<br>     */<br>    public static synchronized void stopAllUploads() {<br>        if (uploadTasksMap.isEmpty()) {<br>            return;<br>        }<br><br>        // using iterator instead for each loop, because it&#39;s faster on Android<br>        Iterator&lt;String&gt; iterator = uploadTasksMap.keySet().iterator();<br><br>        while (iterator.hasNext()) {<br>            HttpUploadTask taskToCancel = uploadTasksMap.get(iterator.next());<br>            taskToCancel.cancel();<br>        }<br>    }<br><br>    @Override<br>    public void onCreate() {<br>        super.onCreate();<br><br>        PowerManager pm = (PowerManager) getSystemService(POWER_SERVICE);<br>        wakeLock = pm.newWakeLock(PowerManager.PARTIAL_WAKE_LOCK, TAG);<br><br>        if (UPLOAD_POOL_SIZE &lt;= 0) {<br>            UPLOAD_POOL_SIZE = Runtime.getRuntime().availableProcessors();<br>        }<br><br>        // Creates a thread pool manager<br>        uploadThreadPool = new ThreadPoolExecutor(<br>                UPLOAD_POOL_SIZE,       // Initial pool size<br>                UPLOAD_POOL_SIZE,       // Max pool size<br>                KEEP_ALIVE_TIME_IN_SECONDS,<br>                TimeUnit.SECONDS,<br>                uploadTasksQueue);<br>    }<br><br>    @Override<br>    public IBinder onBind(Intent intent) {<br>        return null;<br>    }<br><br>    @Override<br>    public int onStartCommand(Intent intent, int flags, int startId) {<br>        if (intent == null || !getActionUpload().equals(intent.getAction())) {<br>            return START_STICKY;<br>        }<br><br>        HttpUploadTask currentTask = getTask(intent);<br><br>        if (currentTask == null) {<br>            return START_STICKY;<br>        }<br><br>        // increment by 2 because the notificationIncrementalId + 1 is used internally<br>        // in each HttpUploadTask. Check its sources for more info about this.<br>        notificationIncrementalId += 2;<br>        currentTask.setLastProgressNotificationTime(0)<br>                   .setNotificationId(UPLOAD_NOTIFICATION_BASE_ID + notificationIncrementalId);<br><br>        wakeLock.acquire();<br><br>        uploadTasksMap.put(currentTask.uploadId, currentTask);<br>        uploadThreadPool.execute(currentTask);<br><br>        return START_STICKY;<br>    }<br><br>    @Override<br>    public void onDestroy() {<br>        super.onDestroy();<br><br>        stopAllUploads();<br>        uploadThreadPool.shutdown();<br><br>        if (EXECUTE_IN_FOREGROUND) {<br>            stopForeground(true);<br>        }<br><br>        Log.d(TAG, &quot;UploadService destroyed&quot;);<br>    }<br><br>    /**<br>     * Creates a new task instance based on the requested task type in the intent.<br>     * @param intent<br>     * @return task instance or null if the type is not supported or invalid<br>     */<br>    HttpUploadTask getTask(Intent intent) {<br>        String type = intent.getStringExtra(PARAM_TYPE);<br><br>        if (MultipartUploadRequest.NAME.equals(type)) {<br>            return new MultipartUploadTask(this, intent);<br>        }<br><br>        if (BinaryUploadRequest.NAME.equals(type)) {<br>            return new BinaryUploadTask(this, intent);<br>        }<br><br>        return null;<br>    }<br><br>    /**<br>     * Check if the task is currently the one shown in the foreground notification.<br>     * @param uploadId ID of the upload<br>     * @return true if the current upload task holds the foreground notification, otherwise false<br>     */<br>    protected synchronized boolean holdForegroundNotification(String uploadId, Notification notification) {<br>        if (!EXECUTE_IN_FOREGROUND) return false;<br><br>        if (foregroundUploadId == null) {<br>            foregroundUploadId = uploadId;<br>            Log.d(TAG, uploadId + &quot; now holds the foreground notification&quot;);<br>        }<br><br>        if (uploadId.equals(foregroundUploadId)) {<br>            startForeground(UPLOAD_NOTIFICATION_BASE_ID, notification);<br>            return true;<br>        }<br><br>        return false;<br>    }<br><br>    /**<br>     * Called by each task when it is completed (either successfully, with an error or due to<br>     * user cancellation).<br>     * @param uploadId the uploadID of the finished task<br>     */<br>    protected synchronized void taskCompleted(String uploadId) {<br>        HttpUploadTask task = uploadTasksMap.remove(uploadId);<br><br>        // un-hold foreground upload ID if it&#39;s been hold<br>        if (EXECUTE_IN_FOREGROUND &amp;&amp; task != null &amp;&amp; task.uploadId.equals(foregroundUploadId)) {<br>            Log.d(TAG, uploadId + &quot; now un-holded the foreground notification&quot;);<br>            foregroundUploadId = null;<br>        }<br><br>        // when all the upload tasks are completed, release the wake lock and shut down the service<br>        if (uploadTasksMap.isEmpty()) {<br>            Log.d(TAG, &quot;All tasks finished. UploadService is about to shutdown...&quot;);<br>            wakeLock.release();<br>            stopSelf();<br>        }<br>    }<br>}</pre><p name="23d5" id="23d5" class="graf graf--p graf-after--pre">Now we have a slick api to add tasks (I want to fetch an image), cancel a task(I no longer need that image), and cancel all tasks(Oh, it seems I am offline).</p><p name="2ace" id="2ace" class="graf graf--p graf-after--p graf--trailing"><strong class="markup--strong markup--p-strong">Edit</strong> — I no longer recommend using a service for simple network calls. Use <a href="https://github.com/square/tape" data-href="https://github.com/square/tape" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">tape</a> or any other persistent queue for eventually consistent request. For any other request use <a href="https://github.com/ReactiveX/RxJava" data-href="https://github.com/ReactiveX/RxJava" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">RX-Java</a>. Even if not using any of these libraries, make your network calls in application scope instead of using service to achieve much finer control. Use service only for bigger tasks like image upload (combine it with persistent queue).</p></div></div></section></div><footer class="u-paddingTop10"><div class="container u-maxWidth740"><div class="row"><div class="col u-size12of12"></div></div><div class="row"><div class="col u-size12of12 js-postTags"><div class="u-paddingBottom10"><ul class="tags tags--postTags tags--borderless"><li><a class="link u-baseColor--link"  href="https://medium.com/tag/android?source=post" data-action-source="post">Android</a></li><li><a class="link u-baseColor--link"  href="https://medium.com/tag/android-app-development?source=post" data-action-source="post">Android App Development</a></li><li><a class="link u-baseColor--link"  href="https://medium.com/tag/rest-api?source=post" data-action-source="post">Rest Api</a></li></ul></div></div></div><div class="row js-postActionsFooter"><div class="postActions col u-size12of12"><div class="u-floatLeft buttonSet buttonSet--withLabels"><div class="buttonSet-inner"><div class="js-actionRecommend" data-post-id="82d79c0c662b" data-is-icon-29px="true" data-has-recommend-list="true" data-source="post_actions_footer"><button class="button button--primary button--large button--chromeless is-touchIconFadeInPulse u-accentColor--buttonNormal button--withIcon button--withSvgIcon u-accentColor--iconLight js-actionRecommendButton"  title="Recommend to share this article with your followers and let the author know you liked it" aria-label="Recommend to share this article with your followers and let the author know you liked it" data-action="sign-in-prompt" data-sign-in-action="upvote" data-requires-token="true" data-redirect="https://medium.com/_/vote/p/82d79c0c662b" data-action-source="post_actions_footer"><span class="button-defaultState"><span class="svgIcon svgIcon--heart svgIcon--29px"><svg class="svgIcon-use" width="29" height="29" viewBox="0 0 29 29" ><path d="M16.215 23.716c-.348.288-.984.826-1.376 1.158a.526.526 0 0 1-.68 0c-.36-.307-.92-.78-1.22-1.03C9.22 20.734 3 15.527 3 10.734 3 7.02 5.916 4 9.5 4c1.948 0 3.77.898 5 2.434C15.73 4.898 17.552 4 19.5 4c3.584 0 6.5 3.02 6.5 6.734 0 4.9-6.125 9.96-9.785 12.982zM19.5 5.2c-1.774 0-3.423.923-4.41 2.468a.699.699 0 0 1-.59.323.706.706 0 0 1-.59-.32c-.988-1.54-2.637-2.47-4.41-2.47-2.922 0-5.3 2.49-5.3 5.54 0 4.23 6.19 9.41 9.517 12.19.217.18.566.48.783.66l.952-.79c3.496-2.88 9.348-7.72 9.348-12.05 0-3.05-2.378-5.53-5.3-5.53z"/></svg></span></span><span class="button-activeState"><span class="svgIcon svgIcon--heartFilled svgIcon--29px"><svg class="svgIcon-use" width="29" height="29" viewBox="0 0 29 29" ><path d="M19.5 4c-1.948 0-3.77.898-5 2.434C13.27 4.898 11.448 4 9.5 4 5.916 4 3 7.02 3 10.734c0 4.793 6.227 10 9.95 13.11.296.25.853.723 1.212 1.03.196.166.48.166.677 0 .39-.332 1.02-.87 1.37-1.158 3.66-3.022 9.79-8.08 9.79-12.982C26 7.02 23.08 4 19.5 4z" fill-rule="evenodd"/></svg></span></span></button><button class="button button--chromeless u-baseColor--buttonNormal"  data-action="show-recommends" data-action-value="82d79c0c662b">3</button></div></div><div class="buttonSet-inner"><button class="button button--large button--dark button--chromeless is-touchIconBlackPulse u-baseColor--buttonDark button--withIcon button--withSvgIcon"  data-action="scroll-to-responses" data-action-source="post_actions_footer"><span class="svgIcon svgIcon--response svgIcon--29px"><svg class="svgIcon-use" width="29" height="29" viewBox="0 0 29 29" ><path d="M21.27 20.058c1.89-1.826 2.754-4.17 2.754-6.674C24.024 8.21 19.67 4 14.1 4 8.53 4 4 8.21 4 13.384c0 5.175 4.53 9.385 10.1 9.385 1.007 0 2-.14 2.95-.41.285.25.592.49.918.7 1.306.87 2.716 1.31 4.19 1.31.276-.01.494-.14.6-.36a.625.625 0 0 0-.052-.65c-.61-.84-1.042-1.71-1.282-2.58a5.417 5.417 0 0 1-.154-.75zm-3.85 1.324l-.083-.28-.388.12a9.72 9.72 0 0 1-2.85.424c-4.96 0-8.99-3.706-8.99-8.262 0-4.556 4.03-8.263 8.99-8.263 4.95 0 8.77 3.71 8.77 8.27 0 2.25-.75 4.35-2.5 5.92l-.24.21v.32c0 .07 0 .19.02.37.03.29.1.6.19.92.19.7.49 1.4.89 2.08-.93-.14-1.83-.49-2.67-1.06-.34-.22-.88-.48-1.16-.74z"/></svg></span></button></div></div><div class="u-floatRight buttonSet buttonSet--narrow"><button class="button button--large button--dark button--chromeless is-touchIconBlackPulse u-baseColor--buttonDark button--withIcon button--withSvgIcon"  title="Share on Twitter" aria-label="Share on Twitter" data-action="share-on-twitter" data-action-source="post_actions_footer"><span class="svgIcon svgIcon--twitter svgIcon--29px"><svg class="svgIcon-use" width="29" height="29" viewBox="0 0 29 29" ><path d="M21.967 11.8c.018 5.93-4.607 11.18-11.177 11.18-2.172 0-4.25-.62-6.047-1.76l-.268.422-.038.5.186.013.168.012c.3.02.44.032.6.046 2.06-.026 3.95-.686 5.49-1.86l1.12-.85-1.4-.048c-1.57-.055-2.92-1.08-3.36-2.51l-.48.146-.05.5c.22.03.48.05.75.08.48-.02.87-.07 1.25-.15l2.33-.49-2.32-.49c-1.68-.35-2.91-1.83-2.91-3.55 0-.05 0-.01-.01.03l-.49-.1-.25.44c.63.36 1.35.57 2.07.58l1.7.04L7.4 13c-.978-.662-1.59-1.79-1.618-3.047a4.08 4.08 0 0 1 .524-1.8l-.825.07a12.188 12.188 0 0 0 8.81 4.515l.59.033-.06-.59v-.02c-.05-.43-.06-.63-.06-.87a3.617 3.617 0 0 1 6.27-2.45l.2.21.28-.06c1.01-.22 1.94-.59 2.73-1.09l-.75-.56c-.1.36-.04.89.12 1.36.23.68.58 1.13 1.17.85l-.21-.45-.42-.27c-.52.8-1.17 1.48-1.92 2L22 11l.016.28c.013.2.014.35 0 .52v.04zm.998.038c.018-.22.017-.417 0-.66l-.498.034.284.41a8.183 8.183 0 0 0 2.2-2.267l.97-1.48-1.6.755c.17-.08.3-.02.34.03a.914.914 0 0 1-.13-.292c-.1-.297-.13-.64-.1-.766l.36-1.254-1.1.695c-.69.438-1.51.764-2.41.963l.48.15a4.574 4.574 0 0 0-3.38-1.484 4.616 4.616 0 0 0-4.61 4.613c0 .29.02.51.08.984l.01.02.5-.06.03-.5c-3.17-.18-6.1-1.7-8.08-4.15l-.48-.56-.36.64c-.39.69-.62 1.48-.65 2.28.04 1.61.81 3.04 2.06 3.88l.3-.92c-.55-.02-1.11-.17-1.6-.45l-.59-.34-.14.67c-.02.08-.02.16 0 .24-.01 2.12 1.55 4.01 3.69 4.46l.1-.49-.1-.49c-.33.07-.67.12-1.03.14-.18-.02-.43-.05-.64-.07l-.76-.09.23.73c.57 1.84 2.29 3.14 4.28 3.21l-.28-.89a8.252 8.252 0 0 1-4.85 1.66c-.12-.01-.26-.02-.56-.05l-.17-.01-.18-.01L2.53 21l1.694 1.07a12.233 12.233 0 0 0 6.58 1.917c7.156 0 12.2-5.73 12.18-12.18l-.002.04z"/></svg></span></button><button class="button button--large button--dark button--chromeless is-touchIconBlackPulse u-baseColor--buttonDark button--withIcon button--withSvgIcon"  title="Share on Facebook" aria-label="Share on Facebook" data-action="share-on-facebook" data-action-source="post_actions_footer"><span class="svgIcon svgIcon--facebook svgIcon--29px"><svg class="svgIcon-use" width="29" height="29" viewBox="0 0 29 29" ><path d="M16.39 23.61v-5.808h1.846a.55.55 0 0 0 .546-.48l.36-2.797a.551.551 0 0 0-.547-.62H16.39V12.67c0-.67.12-.813.828-.813h1.474a.55.55 0 0 0 .55-.55V8.803a.55.55 0 0 0-.477-.545c-.436-.06-1.36-.116-2.22-.116-2.5 0-4.13 1.62-4.13 4.248v1.513H10.56a.551.551 0 0 0-.55.55v2.797c0 .304.248.55.55.55h1.855v5.76c-4.172-.96-7.215-4.7-7.215-9.1 0-5.17 4.17-9.36 9.31-9.36 5.14 0 9.31 4.19 9.31 9.36 0 4.48-3.155 8.27-7.43 9.15M14.51 4C8.76 4 4.1 8.684 4.1 14.46c0 5.162 3.75 9.523 8.778 10.32a.55.55 0 0 0 .637-.543v-6.985a.551.551 0 0 0-.55-.55H11.11v-1.697h1.855a.55.55 0 0 0 .55-.55v-2.063c0-2.02 1.136-3.148 3.03-3.148.567 0 1.156.027 1.597.06v1.453h-.924c-1.363 0-1.93.675-1.93 1.912v1.78c0 .3.247.55.55.55h2.132l-.218 1.69H15.84c-.305 0-.55.24-.55.55v7.02c0 .33.293.59.623.54 5.135-.7 9.007-5.11 9.007-10.36C24.92 8.68 20.26 4 14.51 4"/></svg></span></button></div></div></div></div><div class="js-postPromotionWrapper postPromotionWrapper" data-location-id="footer_above_post_attribution"></div><div class="container u-maxWidth740 js-postAttributionFooterContainer u-paddingTop20 u-paddingBottom20 u-marginTop10 u-borderTopLightest u-xs-paddingTop10 u-xs-paddingBottom10"><div class="row js-postFooterInfo"><div class="col u-size12of12"><li class="u-block u-paddingBottom18 js-cardUser"><div class="u-marginLeft20 u-floatRight"><span class="followState js-followState buttonSet-inner" data-user-id="1dffe67e8a90"><button class="button button--small u-noUserSelect button--withChrome u-baseColor--buttonNormal button--withHover button--unblock js-unblockButton"  data-action="sign-in-prompt" data-sign-in-action="toggle-block-user" data-requires-token="true" data-action-source="footer_card"><span class="button-label  button-defaultState">Blocked</span><span class="button-label button-hoverState">Unblock</span></button><button class="button button--primary button--small u-noUserSelect button--withChrome u-accentColor--buttonNormal button--follow js-followButton"  data-action="sign-in-prompt" data-sign-in-action="toggle-subscribe-user" data-requires-token="true" data-redirect="https://medium.com/_/subscribe/user/1dffe67e8a90" data-action-source="footer_card_follow"><span class="button-label  button-defaultState js-buttonLabel">Follow</span><span class="button-label button-activeState">Following</span></button></span></div><div class="u-tableCell "><a class="link avatar u-baseColor--link"  href="https://medium.com/@harshitbangar?source=footer_card" title="Go to the profile of Harshit Bangar" aria-label="Go to the profile of Harshit Bangar" data-action-source="footer_card" data-user-id="1dffe67e8a90" dir="auto"><img  src="https://cdn-images-1.medium.com/fit/c/60/60/0*MdSbGPtrzTSdC0yV.jpg" class="avatar-image avatar-image--small" alt="Go to the profile of Harshit Bangar"></a></div><div class="u-tableCell u-verticalAlignMiddle u-breakWord u-paddingLeft15"><h3 class="u-fontSize18 u-lineHeightTighter u-marginBottom4"><a class="link link--primary u-accentColor--hoverTextNormal"  href="https://medium.com/@harshitbangar" property="cc:attributionName" title="Go to the profile of Harshit Bangar" aria-label="Go to the profile of Harshit Bangar" rel="author cc:attributionUrl" data-user-id="1dffe67e8a90" dir="auto">Harshit Bangar</a></h3></div></li></div></div></div><div class="js-postFooterPlacements"></div><div class="u-padding0 u-clearfix u-backgroundGrayLightest u-print-hide supplementalPostContent js-responsesWrapper"></div><div class="supplementalPostContent js-readNext"></div><div class="supplementalPostContent js-heroPromo"></div></footer></article></main><div class="u-marginAuto u-maxWidth1000"><div class="js-postShareWidget u-foreground u-sm-hide u-transition--fadeOut300 u-fixed"><ul><li class="u-uiTextSemibold u-textAlignCenter u-textColorNormal u-fontSize12 u-textUppercase">Share</li><li class="u-textAlignCenter"><div class="js-actionRecommend" data-post-id="82d79c0c662b" data-is-icon-29px="true" data-is-vertical="true" data-has-recommend-list="true" data-source="post_share_widget"><button class="button button--primary button--large button--chromeless is-touchIconFadeInPulse u-accentColor--buttonNormal button--withIcon button--withSvgIcon u-accentColor--iconLight js-actionRecommendButton"  title="Recommend to share this article with your followers and let the author know you liked it" aria-label="Recommend to share this article with your followers and let the author know you liked it" data-action="sign-in-prompt" data-sign-in-action="upvote" data-requires-token="true" data-redirect="https://medium.com/_/vote/p/82d79c0c662b" data-action-source="post_share_widget"><span class="button-defaultState"><span class="svgIcon svgIcon--heart svgIcon--29px"><svg class="svgIcon-use" width="29" height="29" viewBox="0 0 29 29" ><path d="M16.215 23.716c-.348.288-.984.826-1.376 1.158a.526.526 0 0 1-.68 0c-.36-.307-.92-.78-1.22-1.03C9.22 20.734 3 15.527 3 10.734 3 7.02 5.916 4 9.5 4c1.948 0 3.77.898 5 2.434C15.73 4.898 17.552 4 19.5 4c3.584 0 6.5 3.02 6.5 6.734 0 4.9-6.125 9.96-9.785 12.982zM19.5 5.2c-1.774 0-3.423.923-4.41 2.468a.699.699 0 0 1-.59.323.706.706 0 0 1-.59-.32c-.988-1.54-2.637-2.47-4.41-2.47-2.922 0-5.3 2.49-5.3 5.54 0 4.23 6.19 9.41 9.517 12.19.217.18.566.48.783.66l.952-.79c3.496-2.88 9.348-7.72 9.348-12.05 0-3.05-2.378-5.53-5.3-5.53z"/></svg></span></span><span class="button-activeState"><span class="svgIcon svgIcon--heartFilled svgIcon--29px"><svg class="svgIcon-use" width="29" height="29" viewBox="0 0 29 29" ><path d="M19.5 4c-1.948 0-3.77.898-5 2.434C13.27 4.898 11.448 4 9.5 4 5.916 4 3 7.02 3 10.734c0 4.793 6.227 10 9.95 13.11.296.25.853.723 1.212 1.03.196.166.48.166.677 0 .39-.332 1.02-.87 1.37-1.158 3.66-3.022 9.79-8.08 9.79-12.982C26 7.02 23.08 4 19.5 4z" fill-rule="evenodd"/></svg></span></span></button><button class="button button--chromeless u-baseColor--buttonNormal  u-block u-marginAuto u-marginTopNegative5"  data-action="show-recommends" data-action-value="82d79c0c662b">3</button></div></li><li class="u-textAlignCenter"><button class="button button--large button--dark button--chromeless is-touchIconBlackPulse u-baseColor--buttonDark button--withIcon button--withSvgIcon"  title="Share on Twitter" aria-label="Share on Twitter" data-action="share-on-twitter" data-action-source="post_share_widget"><span class="svgIcon svgIcon--twitter svgIcon--29px"><svg class="svgIcon-use" width="29" height="29" viewBox="0 0 29 29" ><path d="M21.967 11.8c.018 5.93-4.607 11.18-11.177 11.18-2.172 0-4.25-.62-6.047-1.76l-.268.422-.038.5.186.013.168.012c.3.02.44.032.6.046 2.06-.026 3.95-.686 5.49-1.86l1.12-.85-1.4-.048c-1.57-.055-2.92-1.08-3.36-2.51l-.48.146-.05.5c.22.03.48.05.75.08.48-.02.87-.07 1.25-.15l2.33-.49-2.32-.49c-1.68-.35-2.91-1.83-2.91-3.55 0-.05 0-.01-.01.03l-.49-.1-.25.44c.63.36 1.35.57 2.07.58l1.7.04L7.4 13c-.978-.662-1.59-1.79-1.618-3.047a4.08 4.08 0 0 1 .524-1.8l-.825.07a12.188 12.188 0 0 0 8.81 4.515l.59.033-.06-.59v-.02c-.05-.43-.06-.63-.06-.87a3.617 3.617 0 0 1 6.27-2.45l.2.21.28-.06c1.01-.22 1.94-.59 2.73-1.09l-.75-.56c-.1.36-.04.89.12 1.36.23.68.58 1.13 1.17.85l-.21-.45-.42-.27c-.52.8-1.17 1.48-1.92 2L22 11l.016.28c.013.2.014.35 0 .52v.04zm.998.038c.018-.22.017-.417 0-.66l-.498.034.284.41a8.183 8.183 0 0 0 2.2-2.267l.97-1.48-1.6.755c.17-.08.3-.02.34.03a.914.914 0 0 1-.13-.292c-.1-.297-.13-.64-.1-.766l.36-1.254-1.1.695c-.69.438-1.51.764-2.41.963l.48.15a4.574 4.574 0 0 0-3.38-1.484 4.616 4.616 0 0 0-4.61 4.613c0 .29.02.51.08.984l.01.02.5-.06.03-.5c-3.17-.18-6.1-1.7-8.08-4.15l-.48-.56-.36.64c-.39.69-.62 1.48-.65 2.28.04 1.61.81 3.04 2.06 3.88l.3-.92c-.55-.02-1.11-.17-1.6-.45l-.59-.34-.14.67c-.02.08-.02.16 0 .24-.01 2.12 1.55 4.01 3.69 4.46l.1-.49-.1-.49c-.33.07-.67.12-1.03.14-.18-.02-.43-.05-.64-.07l-.76-.09.23.73c.57 1.84 2.29 3.14 4.28 3.21l-.28-.89a8.252 8.252 0 0 1-4.85 1.66c-.12-.01-.26-.02-.56-.05l-.17-.01-.18-.01L2.53 21l1.694 1.07a12.233 12.233 0 0 0 6.58 1.917c7.156 0 12.2-5.73 12.18-12.18l-.002.04z"/></svg></span></button></li><li class="u-textAlignCenter"><button class="button button--large button--dark button--chromeless is-touchIconBlackPulse u-baseColor--buttonDark button--withIcon button--withSvgIcon"  title="Share on Facebook" aria-label="Share on Facebook" data-action="share-on-facebook" data-action-source="post_share_widget"><span class="svgIcon svgIcon--facebook svgIcon--29px"><svg class="svgIcon-use" width="29" height="29" viewBox="0 0 29 29" ><path d="M16.39 23.61v-5.808h1.846a.55.55 0 0 0 .546-.48l.36-2.797a.551.551 0 0 0-.547-.62H16.39V12.67c0-.67.12-.813.828-.813h1.474a.55.55 0 0 0 .55-.55V8.803a.55.55 0 0 0-.477-.545c-.436-.06-1.36-.116-2.22-.116-2.5 0-4.13 1.62-4.13 4.248v1.513H10.56a.551.551 0 0 0-.55.55v2.797c0 .304.248.55.55.55h1.855v5.76c-4.172-.96-7.215-4.7-7.215-9.1 0-5.17 4.17-9.36 9.31-9.36 5.14 0 9.31 4.19 9.31 9.36 0 4.48-3.155 8.27-7.43 9.15M14.51 4C8.76 4 4.1 8.684 4.1 14.46c0 5.162 3.75 9.523 8.778 10.32a.55.55 0 0 0 .637-.543v-6.985a.551.551 0 0 0-.55-.55H11.11v-1.697h1.855a.55.55 0 0 0 .55-.55v-2.063c0-2.02 1.136-3.148 3.03-3.148.567 0 1.156.027 1.597.06v1.453h-.924c-1.363 0-1.93.675-1.93 1.912v1.78c0 .3.247.55.55.55h2.132l-.218 1.69H15.84c-.305 0-.55.24-.55.55v7.02c0 .33.293.59.623.54 5.135-.7 9.007-5.11 9.007-10.36C24.92 8.68 20.26 4 14.51 4"/></svg></span></button></li><li class="u-textAlignCenter"><button class="button button--large button--dark button--chromeless is-touchIconFadeInPulse u-baseColor--buttonDark button--withIcon button--withSvgIcon button--bookmark js-bookmarkButton"  title="Bookmark this story to read later" aria-label="Bookmark this story to read later" data-action="sign-in-prompt" data-sign-in-action="add-to-bookmarks" data-requires-token="true" data-redirect="https://medium.com/_/bookmark/p/82d79c0c662b"><span class="button-defaultState"><span class="svgIcon svgIcon--bookmark svgIcon--29px"><svg class="svgIcon-use" width="29" height="29" viewBox="0 0 29 29" ><path d="M19.385 4h-9.77A2.623 2.623 0 0 0 7 6.615V23.01a1.022 1.022 0 0 0 1.595.847l5.905-4.004 5.905 4.004A1.022 1.022 0 0 0 22 23.011V6.62A2.625 2.625 0 0 0 19.385 4zM21 23l-5.91-3.955-.148-.107a.751.751 0 0 0-.884 0l-.147.107L8 23V6.615C8 5.725 8.725 5 9.615 5h9.77C20.275 5 21 5.725 21 6.615V23z" fill-rule="evenodd"/></svg></span></span><span class="button-activeState"><span class="svgIcon svgIcon--bookmarkFilled svgIcon--29px"><svg class="svgIcon-use" width="29" height="29" viewBox="0 0 29 29" ><path d="M19.385 4h-9.77A2.623 2.623 0 0 0 7 6.615V23.01a1.022 1.022 0 0 0 1.595.847l5.905-4.004 5.905 4.004A1.022 1.022 0 0 0 22 23.011V6.62A2.625 2.625 0 0 0 19.385 4z" fill-rule="evenodd"/></svg></span></span></button></li></ul></div></div><div class="u-fixed u-bottom0 u-sizeFullWidth u-backgroundWhite u-boxShadowTop u-borderBox u-paddingTop10 u-paddingBottom10 u-zIndexMetabar u-xs-paddingLeft10 u-xs-paddingRight10 js-stickyFooter"><div class="u-maxWidth700 u-marginAuto u-flexCenter"><div class="u-fontSize16 u-flex1 u-flexCenter"><div class="u-flex0 u-inlineBlock u-paddingRight20 u-xs-paddingRight10"><a class="link avatar u-inline u-baseColor--link"  href="https://medium.com/@harshitbangar" data-action="show-user-card" data-action-value="1dffe67e8a90" data-action-type="hover" data-user-id="1dffe67e8a90" dir="auto"><img  src="https://cdn-images-1.medium.com/fit/c/40/40/0*MdSbGPtrzTSdC0yV.jpg" class="avatar-image avatar-image--smaller" alt="Go to the profile of Harshit Bangar"></a></div><div class="u-flex1 u-inlineBlock"><div class="u-xs-hide">Never miss a story from<strong> Harshit Bangar</strong>, when you sign up for Medium. <a class="link link--accent u-accentColor--textNormal u-accentColor--textDarken u-baseColor--link"  href="https://medium.com/@Medium/personalize-your-medium-experience-with-users-publications-tags-26a41ab1ee0c#.hx4zuv3mg" data-action-source="sticky_footer">Learn more</a></div><div class="u-xs-show">Never miss a story from<strong> Harshit Bangar</strong></div></div></div><div class="u-marginLeft50 u-xs-marginAuto"><span class="followState js-followState buttonSet-inner" data-user-id="1dffe67e8a90"><button class="button u-noUserSelect button--withChrome u-baseColor--buttonNormal button--withHover button--unblock js-unblockButton u-uiTextSemibold u-textUppercase u-fontSize12"  data-action="sign-in-prompt" data-sign-in-action="toggle-block-user" data-requires-token="true" data-action-source="sticky_footer"><span class="button-label  button-defaultState">Blocked</span><span class="button-label button-hoverState">Unblock</span></button><button class="button button--primary is-active u-noUserSelect button--withChrome u-accentColor--buttonNormal button--follow js-followButton u-uiTextSemibold u-textUppercase u-fontSize12"  data-action="sign-in-prompt" data-sign-in-action="toggle-subscribe-user" data-requires-token="true" data-redirect="https://medium.com/_/subscribe/user/1dffe67e8a90" data-action-source="sticky_footer_follow"><span class="button-label  button-defaultState js-buttonLabel">Follow</span><span class="button-label button-activeState">Get updates</span></button></span></div></div></div></div></div></div><div class="loadingBar"></div><script>// <![CDATA[
window["obvInit"] = function (opt_embedded) {window["obvInit"]["embedded"] = opt_embedded; window["obvInit"]["ready"] = true;}
// ]]></script><script>// <![CDATA[
var GLOBALS = {"audioUrl":"https://d1fcbxp97j4nb2.cloudfront.net","baseUrl":"https://medium.com","buildLabel":"28586-6143d83","currentUser":{"userId":"lo_44e236928361","isVerified":false,"subscriberEmail":""},"currentUserHasUnverifiedEmail":false,"isAuthenticated":false,"isCurrentUserVerified":false,"mediumTwitterScreenName":"medium","miroUrl":"https://cdn-images-1.medium.com","moduleUrls":{"base":"https://cdn-static-1.medium.com/_/fp/gen-js/main-base.bundle.2nXtJ8XknWJqOjh2ZNHRVw.js","notes":"https://cdn-static-1.medium.com/_/fp/gen-js/main-notes.bundle.AouowiblLn4SBKZF6cWDtA.js","posters":"https://cdn-static-1.medium.com/_/fp/gen-js/main-posters.bundle.4rYp3nph7xNXmlmak5XWxQ.js","common-async":"https://cdn-static-1.medium.com/_/fp/gen-js/main-common-async.bundle.R35emyz9xZL7YdHbIl-SvQ.js","stats":"https://cdn-static-1.medium.com/_/fp/gen-js/main-stats.bundle.XUyD-cfC9DG2nc9iq5x7GA.js","home-screens":"https://cdn-static-1.medium.com/_/fp/gen-js/main-home-screens.bundle.0oM8iNH9LgWeJY00O_ao2Q.js","misc-screens":"https://cdn-static-1.medium.com/_/fp/gen-js/main-misc-screens.bundle.caQfKUCZ18Wg2IbFBoaXiA.js"},"previewConfig":{"weightThreshold":1,"weightImageParagraph":0.51,"weightIframeParagraph":0.8,"weightTextParagraph":0.08,"weightEmptyParagraph":0,"weightP":0.003,"weightH":0.005,"weightBq":0.003,"minPTextLength":60,"truncateBoundaryChars":20,"detectTitle":true,"detectTitleLevThreshold":0.15},"productName":"Medium","supportsEdit":false,"termsUrl":"//medium.com/policy/9db0094a1e0f","textshotHost":"textshot.medium.com","transactionId":"1492151097296:a2e349a6a990","useragent":{"browser":"python requests","family":"","os":"","version":2.2,"supportsDesktopEdit":false,"supportsInteract":false,"supportsView":true,"isMobile":false,"isTablet":false,"isNative":false,"supportsFileAPI":false,"isTier1":false,"clientVersion":"","unknownParagraphsBad":false,"clientChannel":"","supportsRealScrollEvents":false,"supportsVhUnits":false,"ruinsViewportSections":false,"supportsHtml5Video":false,"supportsMagicUnderlines":false,"isWebView":false,"isFacebookWebView":false,"supportsProgressiveMedia":false,"supportsPromotedPosts":true,"isBot":false,"isNativeIphone":false,"supportsCssVariables":false,"supportsScrollableMetabar":false},"variants":{"allow_access":true,"allow_signup":true,"allow_test_auth":"disallow","signin_services":"twitter,facebook,google,email,google-fastidv","signup_services":"twitter,facebook,google,email,google-fastidv","android_rating_prompt_recommend_threshold":5,"google_sign_in_android":true,"enable_onboarding":true,"ios_custom_miro_url":"https://cdn-images-1.medium.com","reengagement_notification_duration":3,"enable_adsnative_integration":true,"browsable_stream_config_bucket":"curated-topics","ios_small_post_preview_truncation_length":5.5,"ios_large_post_preview_truncation_length":5.5,"disable_ios_catalog_badging":true,"enable_series_creation":true,"enable_your_series_pages":true,"enable_productionized_series":true,"enable_dedicated_series_tab_api_ios":true,"enable_clap_milestone_notifications":true,"enable_series_stats_page":true,"enable_prepublish_share_settings":true,"enable_direct_auth_connect":true,"enable_post_import":true,"enable_sponsored_post_labelling":true,"enable_logged_in_follow_on_collection_post":true,"promoted_story_placement_locations":"POST_PAGE_FOOTER","show_topics":true,"enable_search_collection_by_tag_recency_filter":true,"search_collection_by_tag_filter_min_votes":10,"enable_sms_app_promo":true,"enable_export_members":true,"enable_series_card_background_creation":true,"can_see_subscription_branding":true,"enable_subscriptions_landing_page":true,"enable_partner_program_landing_page":true,"enable_hide_broken_links":true,"enable_pay_for_custom_domain":true,"enable_promos_from_dynamo":true,"enable_promos_in_placement":true,"enable_series_promo_in_email":true,"enable_sms":true,"enable_series_in_user_profiles":true,"enable_new_logged_out_bento_operation":true,"enable_topic_brief_relations":true},"xsrfToken":"","iosAppId":"828256236","supportEmail":"yourfriends@medium.com","teamName":"Team Medium","fp":{"/icons/favicon.svg":"https://cdn-static-1.medium.com/_/fp/icons/favicon.KjTfUJo7yJH_fCoUzzH3cg.svg","/icons/favicon-dev-editor.ico":"https://cdn-static-1.medium.com/_/fp/icons/favicon-dev-editor.YKKRxBO8EMvIqhyCwIiJeQ.ico","/icons/favicon-hatch-editor.ico":"https://cdn-static-1.medium.com/_/fp/icons/favicon-hatch-editor.BuEyHIqlyh2s_XEk4Rl32Q.ico","/icons/favicon-medium-editor.ico":"https://cdn-static-1.medium.com/_/fp/icons/favicon-medium-editor.PiakrZWB7Yb80quUVQWM6g.ico"},"authBaseUrl":"https://medium.com","imageUploadSizeMb":25,"isAuthDomainRequest":true,"algoliaApiEndpoint":"https://MQ57UUUQZ2-dsn.algolia.net","algoliaAppId":"MQ57UUUQZ2","algoliaSearchOnlyApiKey":"394474ced050e3911ae2249ecc774921","iosAppStoreUrl":"https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8","iosAppLinkBaseUrl":"medium:","algoliaIndexPrefix":"medium_","androidPlayStoreUrl":"https://play.google.com/store/apps/details?id=com.medium.reader","googleClientId":"216296035834-k1k6qe060s2tp2a2jam4ljdcms00sttg.apps.googleusercontent.com","androidPackage":"com.medium.reader","androidPlayStoreMarketScheme":"market://details?id=com.medium.reader","googleAuthUri":"https://accounts.google.com/o/oauth2/auth","androidScheme":"medium","layoutData":{"useDynamicScripts":false,"googleAnalyticsTrackingCode":"UA-24232453-2","jsShivUrl":"https://cdn-static-1.medium.com/_/fp/js/shiv.RI2ePTZ5gFmMgLzG5bEVAA.js","useDynamicCss":false,"faviconUrl":"https://cdn-static-1.medium.com/_/fp/icons/favicon-medium.TAS6uQ-Y7kcKgi0xjcYHXw.ico","faviconImageId":"1*W0nmth_X8nFKjn6BZ388UQ.png","fontSets":[{"id":1,"url":"https://cdn-static-1.medium.com/_/fp/css/fonts-base.by5Oi_VbnwEIvhnWIsuUjA.css"},{"id":4,"url":"https://cdn-static-1.medium.com/_/fp/css/fonts-lazy-base.g08Jj5TZPAiuPWj5YNUsSg.css"},{"id":6,"url":"https://cdn-static-1.medium.com/_/fp/css/fonts-latin-base.141WxxXgxGxNcfeza73H7Q.css"},{"id":7,"url":"https://cdn-static-1.medium.com/_/fp/css/fonts-lazy-latin-base.jMU532QDmysQMOINr-cr2A.css"}],"editorFaviconUrl":"https://cdn-static-1.medium.com/_/fp/icons/favicon-medium-editor.PiakrZWB7Yb80quUVQWM6g.ico"},"authBaseUrlRev":"moc.muidem//:sptth","isDnt":false,"stripePublishableKey":"pk_live_7FReX44VnNIInZwrIIx6ghjl","archiveUploadSizeMb":100,"paymentData":{"currencies":{"1":{"label":"US Dollar","external":"usd"}},"countries":{"1":{"label":"United States of America","external":"US"}},"accountTypes":{"1":{"label":"Individual","external":"individual"},"2":{"label":"Company","external":"company"}}},"previewConfig2":{"weightThreshold":1,"weightImageParagraph":0.05,"raiseImage":true,"enforceHeaderHierarchy":true,"isImageInsetRight":true},"isAmp":false,"iosScheme":"medium","isSwBoot":false,"lightstep":{"accessToken":"ce5be895bef60919541332990ac9fef2","carrier":"{\"ot-tracer-spanid\":\"2fe3f5bf2afe2b1a\",\"ot-tracer-traceid\":\"77c0033837660500\",\"ot-tracer-sampled\":\"true\"}","host":"collector-medium.lightstep.com"},"facebook":{"key":"542599432471018","secret":"c14df7146e9052a1131f3c900c1f0644","token":"542599432471018|1JqjIwxSfY9jOt_KwjWEl1R7T6I","namespace":"medium-com","scope":{"default":["public_profile","email","user_friends"],"connect":["public_profile","email","user_friends"],"login":["public_profile","email","user_friends"],"share":["public_profile","email","user_friends","publish_actions"]},"smartPublishWhitelistedPublications":["bcc38c8f6edf","f3726e2a5878","828a270689e","81c7d351c056","f30e42fd7ff8","8bf1d7d3081b","d16afa0ae7c","d8f3f6ad9c31","e74de0cedea9","15f753907972","c8c6a6b01ebd","3412b9729488","2ce4bbcf83bb","544c7006046e","7bfcdbc6b30a","a268fd916824","458a773bccd2"],"instantArticles":{"published":true,"developmentMode":false}},"mailingListArchiveUploadSizeMb":2,"availableMembershipPlans":[],"editorsPicksTopicId":"3985d2a191c5","popularOnMediumTopicId":"9d34e48ecf94","memberContentTopicId":"13d7efd82fb2","isDoNotAuth":false,"goldfinchUrl":"https://goldfinch.medium.com"}
// ]]></script><script charset="UTF-8" src="https://cdn-static-1.medium.com/_/fp/gen-js/main-base.bundle.2nXtJ8XknWJqOjh2ZNHRVw.js" async></script><script>// <![CDATA[
window["obvInit"]({"value":{"id":"82d79c0c662b","versionId":"db309666b261","creatorId":"1dffe67e8a90","creator":{"userId":"1dffe67e8a90","name":"Harshit Bangar","username":"harshitbangar","createdAt":1425802165545,"lastPostCreatedAt":1489472819726,"imageId":"0*MdSbGPtrzTSdC0yV.jpg","backgroundImageId":"","bio":"","twitterScreenName":"","socialStats":{"userId":"1dffe67e8a90","usersFollowedCount":57,"usersFollowedByCount":63,"type":"SocialStats"},"social":{"userId":"lo_ac0d6c09d536","targetUserId":"1dffe67e8a90","type":"Social"},"facebookAccountId":"1218967925","allowNotes":1,"type":"User"},"homeCollectionId":"","title":"Designing post request on Android","detectedLanguage":"en","latestVersion":"db309666b261","latestPublishedVersion":"db309666b261","hasUnpublishedEdits":false,"latestRev":310,"createdAt":1452879606786,"updatedAt":1479235018087,"acceptedAt":0,"firstPublishedAt":1452880591073,"latestPublishedAt":1479235017522,"vote":false,"experimentalCss":"","displayAuthor":"","content":{"subtitle":"Recently I was writing an image/video upload/download task. Turns out it is much harder than expected. As a naive developer I started with…","bodyModel":{"paragraphs":[{"name":"4d75","type":3,"text":"Designing post request on Android","markups":[]},{"name":"0e47","type":1,"text":"Recently I was writing an image/video upload/download task. Turns out it is much harder than expected. As a naive developer I started with an anonymous AsyncTask.","markups":[{"type":1,"start":152,"end":162}]},{"name":"ccdd","type":8,"text":"public class MyActivity extends Activity {\n (new AsyncTask \x3c ImageView, Integer, String \x3e () {\n @Override\n protected String doInBackground(ImageView…params) {\n // Rest-Api call goes here","markups":[{"type":3,"start":96,"end":105,"href":"http://twitter.com/Override","title":"Twitter profile for @Override","rel":"","anchorType":0}]},{"name":"7de9","type":8,"text":"}.execute(myImageView);","markups":[]},{"name":"6de4","type":8,"text":"}","markups":[]},{"name":"3bed","type":1,"text":"Looks perfect, huh. Not exactly, a big issue is that the inner class contains the reference to it’s parent. If the inner class lives long enough it can lead to a potential memory leaks.","markups":[]},{"name":"9a4a","type":1,"text":"Solutions: Either cancel the AsnycTask(s) or make it a static inner/outer class and use the application context. Neither of two are foolproof and ugly. Image, 10 async tasks for downloading images and in on pause iterating over each of them to cancel. Ugly!! Pros - None (or simple) Cons - Everything else.","markups":[{"type":1,"start":252,"end":259}]},{"name":"5f1e","type":1,"text":"Moving away to something more sensible - Services. Using an intent service to upload task and notifying the activity using event bus or listeners. Pros- Separated your tasks from activity thus not interrupted by lifecycle. There are few more but we are going to unwrap them later. Cons - Single threaded. Imagining 100 images, download on slow network.","markups":[{"type":1,"start":41,"end":51}]},{"name":"fce5","type":1,"text":"Solution - Making it multithreaded. Taking the approach from - https://github.com/alexbbb/android-upload-service , here is my service. Using a threadpool executor with hashmap of task-id vs task, we can easily create a multithreaded service.","markups":[{"type":3,"start":63,"end":112,"href":"https://github.com/alexbbb/android-upload-service","title":"","rel":"","anchorType":0}]},{"name":"03c7","type":8,"text":"package com.alexbbb.uploadservice;\n\nimport android.app.Notification;\nimport android.app.Service;\nimport android.content.Intent;\nimport android.os.IBinder;\nimport android.os.PowerManager;\nimport android.util.Log;\n\nimport java.util.Iterator;\nimport java.util.Map;\nimport java.util.concurrent.BlockingQueue;\nimport java.util.concurrent.ConcurrentHashMap;\nimport java.util.concurrent.LinkedBlockingQueue;\nimport java.util.concurrent.ThreadPoolExecutor;\nimport java.util.concurrent.TimeUnit;\n\n/**\n * Service to upload files in background using HTTP POST with notification center progress\n * display.\n *\n * @author alexbbb (Aleksandar Gotev)\n * @author eliasnaur\n * @author cankov\n * @author mabdurrahman\n */\npublic class UploadService extends Service {\n\n    private static final String TAG = UploadService.class.getSimpleName();\n\n    // configurable values\n    /**\n     * Sets how many threads to use to handle concurrent uploads.\n     */\n    public static int UPLOAD_POOL_SIZE = Runtime.getRuntime().availableProcessors();\n\n    /**\n     * When the number of threads is greater than UPLOAD_POOL_SIZE, this is the maximum time that\n     * excess idle threads will wait for new tasks before terminating.\n     */\n    public static int KEEP_ALIVE_TIME_IN_SECONDS = 1;\n\n    /**\n     * If set to true, the service will go in foreground mode when doing uploads,\n     * lowering the probability of being killed by the system on low memory.\n     * This setting is used only when your uploads have a notification configuration.\n     * It's not possible to run in foreground without notifications, as per Android policy\n     * constraints, so if you set this to true, but you do upload tasks without a\n     * notification configuration, the service will simply run in background mode.\n     */\n    public static boolean EXECUTE_IN_FOREGROUND = true;\n\n    /**\n     * Sets the namespace used to broadcast events. Set this to your app namespace to avoid\n     * conflicts and unexpected behaviours.\n     */\n    public static String NAMESPACE = \"com.alexbbb\";\n    // end configurable values\n\n    protected static final int UPLOAD_NOTIFICATION_BASE_ID = 1234; // Something unique\n\n    private static final String ACTION_UPLOAD_SUFFIX = \".uploadservice.action.upload\";\n    protected static final String PARAM_NOTIFICATION_CONFIG = \"notificationConfig\";\n    protected static final String PARAM_ID = \"id\";\n    protected static final String PARAM_URL = \"url\";\n    protected static final String PARAM_METHOD = \"method\";\n    protected static final String PARAM_FILES = \"files\";\n    protected static final String PARAM_FILE = \"file\";\n    protected static final String PARAM_TYPE = \"uploadType\";\n\n    protected static final String PARAM_REQUEST_HEADERS = \"requestHeaders\";\n    protected static final String PARAM_REQUEST_PARAMETERS = \"requestParameters\";\n    protected static final String PARAM_CUSTOM_USER_AGENT = \"customUserAgent\";\n    protected static final String PARAM_MAX_RETRIES = \"maxRetries\";\n\n    /**\n     * The minimum interval between progress reports in milliseconds.\n     * If the upload Tasks report more frequently, we will throttle notifications.\n     * We aim for 6 updates per second.\n     */\n    protected static final long PROGRESS_REPORT_INTERVAL = 166;\n\n    private static final String BROADCAST_ACTION_SUFFIX = \".uploadservice.broadcast.status\";\n    public static final String UPLOAD_ID = \"id\";\n    public static final String STATUS = \"status\";\n    public static final int STATUS_IN_PROGRESS = 1;\n    public static final int STATUS_COMPLETED = 2;\n    public static final int STATUS_ERROR = 3;\n    public static final int STATUS_CANCELLED = 4;\n    public static final String PROGRESS = \"progress\";\n    public static final String PROGRESS_UPLOADED_BYTES = \"progressUploadedBytes\";\n    public static final String PROGRESS_TOTAL_BYTES = \"progressTotalBytes\";\n    public static final String ERROR_EXCEPTION = \"errorException\";\n    public static final String SERVER_RESPONSE_CODE = \"serverResponseCode\";\n    public static final String SERVER_RESPONSE_MESSAGE = \"serverResponseMessage\";\n\n    private PowerManager.WakeLock wakeLock;\n    private int notificationIncrementalId = 0;\n    private static final Map\x3cString, HttpUploadTask\x3e uploadTasksMap = new ConcurrentHashMap\x3c\x3e();\n    private final BlockingQueue\x3cRunnable\x3e uploadTasksQueue = new LinkedBlockingQueue\x3c\x3e();\n    private static volatile String foregroundUploadId = null;\n    private ThreadPoolExecutor uploadThreadPool;\n\n    protected static String getActionUpload() {\n        return NAMESPACE + ACTION_UPLOAD_SUFFIX;\n    }\n\n    protected static String getActionBroadcast() {\n        return NAMESPACE + BROADCAST_ACTION_SUFFIX;\n    }\n\n    /**\n     * Stops the upload task with the given uploadId.\n     * @param uploadId The unique upload id\n     */\n    public static synchronized void stopUpload(final String uploadId) {\n        HttpUploadTask removedTask = uploadTasksMap.get(uploadId);\n        if (removedTask != null) {\n            removedTask.cancel();\n        }\n    }\n\n    /**\n     * Stop all the active uploads.\n     */\n    public static synchronized void stopAllUploads() {\n        if (uploadTasksMap.isEmpty()) {\n            return;\n        }\n\n        // using iterator instead for each loop, because it's faster on Android\n        Iterator\x3cString\x3e iterator = uploadTasksMap.keySet().iterator();\n\n        while (iterator.hasNext()) {\n            HttpUploadTask taskToCancel = uploadTasksMap.get(iterator.next());\n            taskToCancel.cancel();\n        }\n    }\n\n    @Override\n    public void onCreate() {\n        super.onCreate();\n\n        PowerManager pm = (PowerManager) getSystemService(POWER_SERVICE);\n        wakeLock = pm.newWakeLock(PowerManager.PARTIAL_WAKE_LOCK, TAG);\n\n        if (UPLOAD_POOL_SIZE \x3c= 0) {\n            UPLOAD_POOL_SIZE = Runtime.getRuntime().availableProcessors();\n        }\n\n        // Creates a thread pool manager\n        uploadThreadPool = new ThreadPoolExecutor(\n                UPLOAD_POOL_SIZE,       // Initial pool size\n                UPLOAD_POOL_SIZE,       // Max pool size\n                KEEP_ALIVE_TIME_IN_SECONDS,\n                TimeUnit.SECONDS,\n                uploadTasksQueue);\n    }\n\n    @Override\n    public IBinder onBind(Intent intent) {\n        return null;\n    }\n\n    @Override\n    public int onStartCommand(Intent intent, int flags, int startId) {\n        if (intent == null || !getActionUpload().equals(intent.getAction())) {\n            return START_STICKY;\n        }\n\n        HttpUploadTask currentTask = getTask(intent);\n\n        if (currentTask == null) {\n            return START_STICKY;\n        }\n\n        // increment by 2 because the notificationIncrementalId + 1 is used internally\n        // in each HttpUploadTask. Check its sources for more info about this.\n        notificationIncrementalId += 2;\n        currentTask.setLastProgressNotificationTime(0)\n                   .setNotificationId(UPLOAD_NOTIFICATION_BASE_ID + notificationIncrementalId);\n\n        wakeLock.acquire();\n\n        uploadTasksMap.put(currentTask.uploadId, currentTask);\n        uploadThreadPool.execute(currentTask);\n\n        return START_STICKY;\n    }\n\n    @Override\n    public void onDestroy() {\n        super.onDestroy();\n\n        stopAllUploads();\n        uploadThreadPool.shutdown();\n\n        if (EXECUTE_IN_FOREGROUND) {\n            stopForeground(true);\n        }\n\n        Log.d(TAG, \"UploadService destroyed\");\n    }\n\n    /**\n     * Creates a new task instance based on the requested task type in the intent.\n     * @param intent\n     * @return task instance or null if the type is not supported or invalid\n     */\n    HttpUploadTask getTask(Intent intent) {\n        String type = intent.getStringExtra(PARAM_TYPE);\n\n        if (MultipartUploadRequest.NAME.equals(type)) {\n            return new MultipartUploadTask(this, intent);\n        }\n\n        if (BinaryUploadRequest.NAME.equals(type)) {\n            return new BinaryUploadTask(this, intent);\n        }\n\n        return null;\n    }\n\n    /**\n     * Check if the task is currently the one shown in the foreground notification.\n     * @param uploadId ID of the upload\n     * @return true if the current upload task holds the foreground notification, otherwise false\n     */\n    protected synchronized boolean holdForegroundNotification(String uploadId, Notification notification) {\n        if (!EXECUTE_IN_FOREGROUND) return false;\n\n        if (foregroundUploadId == null) {\n            foregroundUploadId = uploadId;\n            Log.d(TAG, uploadId + \" now holds the foreground notification\");\n        }\n\n        if (uploadId.equals(foregroundUploadId)) {\n            startForeground(UPLOAD_NOTIFICATION_BASE_ID, notification);\n            return true;\n        }\n\n        return false;\n    }\n\n    /**\n     * Called by each task when it is completed (either successfully, with an error or due to\n     * user cancellation).\n     * @param uploadId the uploadID of the finished task\n     */\n    protected synchronized void taskCompleted(String uploadId) {\n        HttpUploadTask task = uploadTasksMap.remove(uploadId);\n\n        // un-hold foreground upload ID if it's been hold\n        if (EXECUTE_IN_FOREGROUND && task != null && task.uploadId.equals(foregroundUploadId)) {\n            Log.d(TAG, uploadId + \" now un-holded the foreground notification\");\n            foregroundUploadId = null;\n        }\n\n        // when all the upload tasks are completed, release the wake lock and shut down the service\n        if (uploadTasksMap.isEmpty()) {\n            Log.d(TAG, \"All tasks finished. UploadService is about to shutdown...\");\n            wakeLock.release();\n            stopSelf();\n        }\n    }\n}","markups":[]},{"name":"23d5","type":1,"text":"Now we have a slick api to add tasks (I want to fetch an image), cancel a task(I no longer need that image), and cancel all tasks(Oh, it seems I am offline).","markups":[]},{"name":"2ace","type":1,"text":"Edit — I no longer recommend using a service for simple network calls. Use tape or any other persistent queue for eventually consistent request. For any other request use RX-Java. Even if not using any of these libraries, make your network calls in application scope instead of using service to achieve much finer control. Use service only for bigger tasks like image upload (combine it with persistent queue).","markups":[{"type":3,"start":75,"end":79,"href":"https://github.com/square/tape","title":"","rel":"","anchorType":0},{"type":3,"start":171,"end":178,"href":"https://github.com/ReactiveX/RxJava","title":"","rel":"","anchorType":0},{"type":1,"start":0,"end":4}]}],"sections":[{"name":"fbf2","startIndex":0}]},"postDisplay":{"coverless":true}},"virtuals":{"allowNotes":true,"previewImage":{"imageId":"","filter":"","backgroundSize":"","originalWidth":0,"originalHeight":0,"strategy":"resample","height":0,"width":0},"wordCount":1339,"imageCount":0,"readingTime":5.052830188679246,"subtitle":"Recently I was writing an image/video upload/download task. Turns out it is much harder than expected. As a naive developer I started with…","usersBySocialRecommends":[],"recommends":3,"socialRecommends":[],"isBookmarked":false,"tags":[{"slug":"android","name":"Android","postCount":25545,"virtuals":{"isFollowing":false},"metadata":{"followerCount":15458,"postCount":25545,"coverImage":{"id":"1*J_o_TFh5ok-BT2CngqjoJg.png","originalWidth":2114,"originalHeight":1452}},"type":"Tag"},{"slug":"android-app-development","name":"Android App Development","postCount":8685,"virtuals":{"isFollowing":false},"metadata":{"followerCount":10510,"postCount":8685,"coverImage":{"id":"1*q_xZvFZYIreSBkVrUJWAVw.png","originalWidth":2538,"originalHeight":1090}},"type":"Tag"},{"slug":"rest-api","name":"Rest Api","postCount":305,"virtuals":{"isFollowing":false},"metadata":{"followerCount":170,"postCount":305,"coverImage":{"id":"1*5BWy2XR7BYLtfVvMuYkXyw.png","originalWidth":1026,"originalHeight":714}},"type":"Tag"}],"socialRecommendsCount":0,"responsesCreatedCount":0,"links":{"entries":[],"version":"0.3","generatedAt":1479235017956},"isLockedPreviewOnly":false,"takeoverId":"","metaDescription":"","totalClapCount":0},"coverless":true,"slug":"designing-post-request-on-android","translationSourcePostId":"","translationSourceCreatorId":"","isApprovedTranslation":false,"inResponseToPostId":"","inResponseToRemovedAt":0,"isTitleSynthesized":true,"allowResponses":true,"importedUrl":"","importedPublishedAt":0,"visibility":0,"uniqueSlug":"designing-post-request-on-android-82d79c0c662b","previewContent":{"bodyModel":{"paragraphs":[{"name":"4d75","type":3,"text":"Designing post request on Android","markups":[],"alignment":1},{"name":"0e47","type":1,"text":"Recently I was writing an image/video upload/download task. Turns out it is much harder than expected. As a naive developer I started with an anonymous AsyncTask.","markups":[{"type":1,"start":152,"end":162}],"alignment":1},{"name":"ccdd","type":8,"text":"public class MyActivity extends Activity {\n (new AsyncTask \x3c ImageView, Integer…","markups":[],"alignment":1}],"sections":[{"startIndex":0}]},"isFullContent":false},"license":0,"inResponseToMediaResourceId":"","canonicalUrl":"https://medium.com/@harshitbangar/designing-post-request-on-android-82d79c0c662b","approvedHomeCollectionId":"","newsletterId":"","webCanonicalUrl":"https://medium.com/@harshitbangar/designing-post-request-on-android-82d79c0c662b","mediumUrl":"https://medium.com/@harshitbangar/designing-post-request-on-android-82d79c0c662b","migrationId":"","notifyFollowers":true,"notifyTwitter":false,"isSponsored":false,"isRequestToPubDisabled":false,"notifyFacebook":false,"responseHiddenOnParentPostAt":0,"isSeries":false,"isSubscriptionLocked":false,"seriesLastAppendedAt":0,"type":"Post"},"mentionedUsers":[],"collaborators":[],"membershipPlans":[],"collectionUserRelations":[],"mode":null,"references":{"User":{"1dffe67e8a90":{"userId":"1dffe67e8a90","name":"Harshit Bangar","username":"harshitbangar","createdAt":1425802165545,"lastPostCreatedAt":1489472819726,"imageId":"0*MdSbGPtrzTSdC0yV.jpg","backgroundImageId":"","bio":"","twitterScreenName":"","socialStats":{"userId":"1dffe67e8a90","usersFollowedCount":57,"usersFollowedByCount":63,"type":"SocialStats"},"social":{"userId":"lo_ac0d6c09d536","targetUserId":"1dffe67e8a90","type":"Social"},"facebookAccountId":"1218967925","allowNotes":1,"type":"User"}},"Social":{"1dffe67e8a90":{"userId":"lo_ac0d6c09d536","targetUserId":"1dffe67e8a90","type":"Social"}},"SocialStats":{"1dffe67e8a90":{"userId":"1dffe67e8a90","usersFollowedCount":57,"usersFollowedByCount":63,"type":"SocialStats"}}}})
// ]]></script></body></html>