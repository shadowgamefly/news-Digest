<!DOCTYPE html><html xmlns:cc="http://creativecommons.org/ns#"><head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# medium-com: http://ogp.me/ns/fb/medium-com#"><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Twitter Lite and High Performance React Progressive Web Apps at Scale</title><link rel="canonical" href="https://medium.com/@paularmstrong/twitter-lite-and-high-performance-react-progressive-web-apps-at-scale-d28a00e780a3"><meta name="title" content="Twitter Lite and High Performance React Progressive Web Apps at Scale"><meta name="referrer" content="unsafe-url"><meta name="description" content="Creating a fast web application involves many cycles of measuring where time is wasted, understanding why it’s happening, and applying potential solutions. Unfortunately, there’s never just one quick…"><meta property="og:title" content="Twitter Lite and High Performance React Progressive Web Apps at Scale"><meta property="og:url" content="https://medium.com/@paularmstrong/twitter-lite-and-high-performance-react-progressive-web-apps-at-scale-d28a00e780a3"><meta property="og:image" content="https://cdn-images-1.medium.com/max/1200/1*6f1XFtCP9Ki04onTv-QEHw.png"><meta property="fb:app_id" content="542599432471018"><meta property="og:description" content="A look into removing common and uncommon performance bottlenecks in one of the worlds largest React.js PWAs, Twitter Lite."><meta name="twitter:description" content="A look into removing common and uncommon performance bottlenecks in one of the worlds largest React.js PWAs, Twitter Lite."><meta name="twitter:image:src" content="https://cdn-images-1.medium.com/max/1200/1*6f1XFtCP9Ki04onTv-QEHw.png"><link rel="publisher" href="https://plus.google.com/103654360130207659246"><link rel="author" href="https://medium.com/@paularmstrong"><meta property="author" content="Paul Armstrong"><meta property="og:type" content="article"><meta name="twitter:card" content="summary_large_image"><meta property="article:publisher" content="https://www.facebook.com/medium"><meta property="article:author" content="https://medium.com/@paularmstrong"><meta property="fb:smart_publish:robots" content="noauto"><meta name="robots" content="index, follow"><meta property="article:published_time" content="2017-04-11T15:11:09.313Z"><meta name="twitter:creator" content="@paularmstrong"><meta name="twitter:site" content="@Medium"><meta property="og:site_name" content="Medium"><meta name="twitter:label1" value="Reading time"><meta name="twitter:data1" value="13 min read"><script type="application/ld+json">{"@context":"http://schema.org","@type":"NewsArticle","image":{"@type":"ImageObject","width":1920,"height":493,"url":"https://cdn-images-1.medium.com/max/1920/1*6f1XFtCP9Ki04onTv-QEHw.png"},"datePublished":"2017-04-11T15:11:09.313Z","dateModified":"2017-04-13T16:25:39.383Z","headline":"Twitter Lite and High Performance React Progressive Web Apps at Scale","name":"Twitter Lite and High Performance React Progressive Web Apps at Scale","keywords":["JavaScript","Web Development","Reactjs","Twitter","Progressive Web App"],"author":{"@type":"Person","name":"Paul Armstrong","url":"https://medium.com/@paularmstrong"},"creator":["Paul Armstrong"],"mainEntityOfPage":"https://medium.com/@paularmstrong/twitter-lite-and-high-performance-react-progressive-web-apps-at-scale-d28a00e780a3"}</script><meta name="twitter:app:name:iphone" content="Medium"><meta name="twitter:app:id:iphone" content="828256236"><meta name="twitter:app:url:iphone" content="medium://p/d28a00e780a3"><meta property="al:ios:app_name" content="Medium"><meta property="al:ios:app_store_id" content="828256236"><meta property="al:android:package" content="com.medium.reader"><meta property="al:android:app_name" content="Medium"><meta property="al:ios:url" content="medium://p/d28a00e780a3"><meta property="al:android:url" content="medium://p/d28a00e780a3"><meta property="al:web:url" content="https://medium.com/@paularmstrong/twitter-lite-and-high-performance-react-progressive-web-apps-at-scale-d28a00e780a3"><link rel="search" type="application/opensearchdescription+xml" title="Medium" href="/osd.xml" /><link rel="alternate" href="android-app://com.medium.reader/https/medium.com/p/d28a00e780a3" /><meta name="theme-color" content="#000000"><link rel="stylesheet" href="https://cdn-static-1.medium.com/_/fp/css/main-base.g2e09PlZK_j3Lw2AgNmbfQ.css"><script>if (window.top !== window.self) window.top.location = window.self.location.href;var OB_startTime = new Date().getTime(); var OB_loadErrors = []; function _onerror(e) { OB_loadErrors.push(e) }; if (document.addEventListener) document.addEventListener("error", _onerror, true); else if (document.attachEvent) document.attachEvent("onerror", _onerror); function _asyncScript(u) {var d = document, f = d.getElementsByTagName("script")[0], s = d.createElement("script"); s.type = "text/javascript"; s.async = true; s.src = u; f.parentNode.insertBefore(s, f);}function _asyncStyles(u) {var d = document, f = d.getElementsByTagName("script")[0], s = d.createElement("link"); s.rel = "stylesheet"; s.href = u; f.parentNode.insertBefore(s, f); return s}var _gaq = _gaq || [];_gaq.push(["_setAccount", "UA-24232453-2"]); _gaq.push(["_setDomainName", window.location.hostname]); _gaq.push(["_setAllowLinker", true]); _gaq.push(["_trackPageview"]);_asyncScript(("https:" == document.location.protocol ? "https://ssl" : "http://www") + ".google-analytics.com/ga.js");(new Image()).src = "/_/stat?event=pixel.load&origin=" + encodeURIComponent(location.origin);</script><script>(function () {var height = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight; var width = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth; document.write("<style>section.section-image--fullBleed.is-backgrounded {padding-top: " + Math.round(1.1 * height) + "px;}section.section-image--fullScreen.is-backgrounded, section.section-image--coverFade.is-backgrounded {min-height: " + height + "px; padding-top: " + Math.round(0.5 * height) + "px;}.u-sizeViewHeight100 {height: " + height + "px !important;}.u-sizeViewHeight110 {height: " + Math.round(1.1 * height) + "px !important;}.u-sizeViewHeightMin100 {min-height: " + height + "px !important;}.u-sizeViewHeightMax100 {max-height: " + height + "px !important;}section.section-image--coverFade {height: " + height + "px;}.section-aspectRatioViewportPlaceholder, .section-aspectRatioViewportCropPlaceholder {max-height: " + height + "px;}.section-aspectRatioViewportBottomSpacer, .section-aspectRatioViewportBottomPlaceholder {max-height: " + Math.round(0.5 * height) + "px;}.zoomable:before {top: " + (-1 * height) + "px; left: " + (-1 * width) + "px; padding: " + height + "px " + width + "px;}</style>");})()</script><!--[if lt IE 9]><script charset="UTF-8" src="https://cdn-static-1.medium.com/_/fp/js/shiv.RI2ePTZ5gFmMgLzG5bEVAA.js"></script><![endif]--><link rel="icon" href="https://cdn-static-1.medium.com/_/fp/icons/favicon-medium.TAS6uQ-Y7kcKgi0xjcYHXw.ico" class="js-favicon"><link rel="apple-touch-icon" sizes="152x152" href="https://cdn-images-1.medium.com/fit/c/152/152/1*W0nmth_X8nFKjn6BZ388UQ.png"><link rel="apple-touch-icon" sizes="120x120" href="https://cdn-images-1.medium.com/fit/c/120/120/1*W0nmth_X8nFKjn6BZ388UQ.png"><link rel="apple-touch-icon" sizes="76x76" href="https://cdn-images-1.medium.com/fit/c/76/76/1*W0nmth_X8nFKjn6BZ388UQ.png"><link rel="apple-touch-icon" sizes="60x60" href="https://cdn-images-1.medium.com/fit/c/60/60/1*W0nmth_X8nFKjn6BZ388UQ.png"><link rel="mask-icon" href="https://cdn-static-1.medium.com/_/fp/icons/favicon.KjTfUJo7yJH_fCoUzzH3cg.svg" color="#171717"></head><body itemscope class=" postShowScreen is-noJs"><script>document.body.className = document.body.className.replace(/(^|\s)is-noJs(\s|$)/, "$1is-js$2")</script><div class="site-main" id="container"><div class="butterBar butterBar--error"></div><div class="surface"><div id="prerendered" class="screenContent"><canvas class="canvas-renderer"></canvas><div class="container u-maxWidth740 u-xs-margin0 notesPositionContainer js-notesPositionContainer"></div><div class="metabar u-clearfix js-metabar"><div class="metabar-inner u-marginAuto u-maxWidth1000 u-paddingLeft20 u-paddingRight20 js-metabarMiddle"><div class="metabar-block metabar-block--left u-floatLeft u-height65 u-xs-height56"><a href="https://medium.com/" class="siteNav-logo" data-log-event="home"><span class="svgIcon svgIcon--logoNew svgIcon--45px is-flushLeft"><svg class="svgIcon-use" width="45" height="45"  viewBox="-17 18 45 45" data-multipart="true"><path d="M11.525 28.078c-.472-.225-.858.002-.858.506v20.044l8.616 4.113c.948.46 1.717.14 1.717-.7v-19.3a.22.22 0 0 0-.124-.19l-9.35-4.46v-.01z"/><path d="M.333 43.696l9.83-15.247c.278-.43.89-.6 1.36-.38l9.364 4.47c.06.03.082.1.047.15L10.666 48.63.333 43.698v-.002z"/><path d="M-8.57 28.35c-.786-.375-1.053-.096-.592.62L.333 43.696l10.333 4.932L.356 32.635a.156.156 0 0 0-.06-.054l-8.866-4.23z"/><path d="M.333 52.033c0 .84-.643 1.22-1.43.844l-8.045-3.84c-.472-.224-.858-.82-.858-1.325V28.89c0-.672.515-.976 1.145-.675l9.133 4.36a.092.092 0 0 1 .055.084v19.37z"/></svg></span><span class="u-textScreenReader">Homepage</span></a></div><div class="metabar-block u-floatRight u-xs-absolute u-xs-textAlignRight u-xs-right0 u-xs-marginRight20 u-height65 u-xs-height56"><div class="buttonSet"><a class="button button--primary button--chromeless u-accentColor--buttonNormal is-inSiteNavBar u-lineHeight30 u-height32"  href="https://medium.com/m/signin?redirect=https%3A%2F%2Fmedium.com%2F%40paularmstrong%2Ftwitter-lite-and-high-performance-react-progressive-web-apps-at-scale-d28a00e780a3" data-action="sign-in-prompt" data-redirect="https://medium.com/@paularmstrong/twitter-lite-and-high-performance-react-progressive-web-apps-at-scale-d28a00e780a3" data-action-source="nav_signup">Sign in / Sign up</a></div></div></div></div><div class="metabar metabar--spacer js-metabarSpacer u-height65 u-xs-height56"></div><main role="main"><article class=" u-sizeViewHeightMin100 u-overflowHidden postArticle postArticle--full u-marginBottom40"  lang="en"><header class="container u-maxWidth740"><div class="postMetaHeader u-paddingBottom10 row"><div class="col u-size12of12 js-postMetaLockup"><div class="postMetaLockup postMetaLockup--authorWithBio u-flex js-postMetaLockup"><div class="u-flex0"><a class="link avatar u-baseColor--link"  href="https://medium.com/@paularmstrong?source=post_header_lockup" data-action="show-user-card" data-action-source="post_header_lockup" data-action-value="b97642f6668f" data-action-type="hover" data-user-id="b97642f6668f" dir="auto"><img  src="https://cdn-images-1.medium.com/fit/c/60/60/1*dgq6_20nGwOd_-UZeUXbQA.jpeg" class="avatar-image avatar-image--small" alt="Go to the profile of Paul Armstrong"></a></div><div class="u-flex1 u-paddingLeft15 u-overflowHidden"><a class="link link link--darken link--darker u-baseColor--link"  href="https://medium.com/@paularmstrong?source=post_header_lockup" data-action="show-user-card" data-action-source="post_header_lockup" data-action-value="b97642f6668f" data-action-type="hover" data-user-id="b97642f6668f" dir="auto">Paul Armstrong</a><span class="followState js-followState buttonSet-inner" data-user-id="b97642f6668f"><button class="button u-paddingLeft10 u-paddingRight10 u-height19 u-lineHeight13 u-verticalAlignMiddle u-fontSize12 u-uiTextMedium u-noUserSelect button--withChrome u-baseColor--buttonNormal button--withHover button--unblock js-unblockButton u-marginLeft10 u-marginTopNegative2 u-xs-hide"  data-action="sign-in-prompt" data-sign-in-action="toggle-block-user" data-requires-token="true" data-action-source="post_header_lockup"><span class="button-label  button-defaultState">Blocked</span><span class="button-label button-hoverState">Unblock</span></button><button class="button button--primary u-paddingLeft10 u-paddingRight10 u-height19 u-lineHeight13 u-verticalAlignMiddle u-fontSize12 u-uiTextMedium u-noUserSelect button--withChrome u-accentColor--buttonNormal button--follow js-followButton u-marginLeft10 u-marginTopNegative2 u-xs-hide"  data-action="sign-in-prompt" data-sign-in-action="toggle-subscribe-user" data-requires-token="true" data-redirect="https://medium.com/_/subscribe/user/b97642f6668f" data-action-source="post_header_lockup_follow"><span class="button-label  button-defaultState js-buttonLabel">Follow</span><span class="button-label button-activeState">Following</span></button></span><div class="postMetaInline u-noWrapWithEllipsis u-xs-normalWrap u-xs-lineClamp2">Writing React.js on @Twitter Lite.</div><div class="postMetaInline js-testPostMetaInlineSupplemental"><time datetime="2017-04-11T15:11:09.313Z">Apr 11</time><span class="middotDivider u-fontSize12"></span><span class="readingTime" title="13 min read"></span></div></div></div></div></div></header><div class="postArticle-content js-postField js-notesSource js-trackedPost"  data-post-id="d28a00e780a3" data-source="post_page" data-tracking-context="postPage"><section name="be28" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h1 name="19d3" id="19d3" class="graf graf--h3 graf--leading graf--title">Twitter Lite and High Performance React Progressive Web Apps at Scale</h1><blockquote name="5ca1" id="5ca1" class="graf graf--blockquote graf-after--h3">A look into removing common and uncommon performance bottlenecks in one of the worlds largest React.js PWAs, <a href="https://mobile.twitter.com" data-href="https://mobile.twitter.com" class="markup--anchor markup--blockquote-anchor" rel="noopener nofollow" target="_blank">Twitter Lite</a>.</blockquote><p name="1b1f" id="1b1f" class="graf graf--p graf-after--blockquote">Creating a fast web application involves many cycles of measuring where time is wasted, understanding why it’s happening, and applying potential solutions. Unfortunately, there’s never just one quick fix. Performance is a continuous game of watching and measuring for areas to improve. With Twitter Lite, we made small improvements across many areas: from initial load times, to React component rendering (and prevention re-rendering), to image loading, and much more. Most changes tend to be small, but they add up, and the end result is that we have one of the largest and fastest <a href="https://developers.google.com/web/progressive-web-apps/" data-href="https://developers.google.com/web/progressive-web-apps/" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank"><em class="markup--em markup--p-em">progressive web applications</em></a>.</p></div><div class="section-inner sectionLayout--outsetColumn"><figure name="ed62" id="ed62" class="graf graf--figure graf--layoutOutsetCenter graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1000px; max-height: 257px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 25.7%;"></div><img class="graf-image" data-image-id="1*6f1XFtCP9Ki04onTv-QEHw.png" data-width="5114" data-height="1314" data-focus-x="24" data-focus-y="53" data-is-featured="true" data-action="zoom" data-action-value="1*6f1XFtCP9Ki04onTv-QEHw.png" src="https://cdn-images-1.medium.com/max/1000/1*6f1XFtCP9Ki04onTv-QEHw.png"></div></figure></div><div class="section-inner sectionLayout--insetColumn"><h4 name="d19a" id="d19a" class="graf graf--h4 graf-after--figure">Before Reading On:</h4><p name="54b6" id="54b6" class="graf graf--p graf-after--h4">If you’re just starting to measure and work toward increasing the performance of your web application, I highly recommend <a href="http://www.brendangregg.com/flamegraphs.html" data-href="http://www.brendangregg.com/flamegraphs.html" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">learning how to read flame graphs</a>, if you don’t know how already.</p><p name="3cc3" id="3cc3" class="graf graf--p graf-after--p">Each section below includes example screenshots of timeline recordings from Chrome’s Developer Tools. To make things more clear, I’ve highlighted each pair of examples with what’s bad (left image) versus what’s good (right image).</p><p name="9749" id="9749" class="graf graf--p graf-after--p graf--trailing"><em class="markup--em markup--p-em">Special note regarding timelines and flame graphs: Since we target a very large range of mobile devices, we typically record these in a simulated environment: 5x slower CPU and 3G network connection. This is not only more realistic, but makes problems much more apparent. These may also be further skewed if we’re using </em><a href="https://facebook.github.io/react/blog/2016/11/16/react-v15.4.0.html#profiling-components-with-chrome-timeline" data-href="https://facebook.github.io/react/blog/2016/11/16/react-v15.4.0.html#profiling-components-with-chrome-timeline" class="markup--anchor markup--p-anchor" rel="noopener nofollow" target="_blank"><em class="markup--em markup--p-em">React v15.4.0’s component profiling</em></a><em class="markup--em markup--p-em">. Actual values on desktop performance timelines will tend to be much faster than what’s illustrated here.</em></p></div></div></section><section name="db97" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="0c70" id="0c70" class="graf graf--h3 graf--leading">Optimizing for the Browser</h3><h4 name="2811" id="2811" class="graf graf--h4 graf-after--h3">Use Route-Based Code Splitting</h4><p name="e026" id="e026" class="graf graf--p graf-after--h4">Webpack is powerful but difficult to learn. For some time, we had issues with the <a href="https://webpack.js.org/plugins/commons-chunk-plugin/" data-href="https://webpack.js.org/plugins/commons-chunk-plugin/" class="markup--anchor markup--p-anchor" rel="noopener nofollow" target="_blank">CommonsChunkPlugin</a> and the way it worked with some of our circular code dependencies. Because of that, we ended up with only 3 JavaScript asset files, totaling over 1MB in size (420KB gzip transfer size).</p><p name="143b" id="143b" class="graf graf--p graf-after--p">Loading a single, or even just a few very large JavaScript files in order to run a site is a huge bottleneck for mobile users to see and interact with a website. Not only does the amount of time it takes for your scripts to transfer over a network increase with their size, but the time it takes for the browser to parse increases as well.</p><p name="6aed" id="6aed" class="graf graf--p graf-after--p">After much wrangling, we were finally able to break up common areas by routes into separate chunks (example below). The day finally came when this code review dropped into our inboxes:</p><figure name="6030" id="6030" class="graf graf--figure graf--iframe graf-after--p"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 35.699999999999996%;"></div><div class="iframeContainer"><IFRAME width="700" height="250" src="/media/9d7ab92337ff626422046a847288418d?postId=d28a00e780a3" data-media-id="9d7ab92337ff626422046a847288418d" data-thumbnail="https://i.embed.ly/1/image?url=https%3A%2F%2Favatars2.githubusercontent.com%2Fu%2F33297%3Fv%3D3%26s%3D400&amp;key=4fce0568f2ce49e8b54624ef71a8a5bd" allowfullscreen frameborder="0"></IFRAME></div></div></figure><blockquote name="4995" id="4995" class="graf graf--blockquote graf-after--figure">Adds granular, route-based code-splitting. Faster initial and HomeTimeline render is traded for greater overall app size, which is spread over 40 on-demand chunks and amortized over the length of the session. — <a href="https://medium.com/@necolas" data-href="https://medium.com/@necolas" data-anchor-type="2" data-user-id="852b96450d4c" data-action-value="852b96450d4c" data-action="show-user-card" data-action-type="hover" class="markup--user markup--blockquote-user" target="_blank">Nicolas Gallagher</a></blockquote></div><div class="section-inner sectionLayout--outsetRow" data-paragraph-count="2"><figure name="c0bb" id="c0bb" class="graf graf--figure graf--layoutOutsetRow is-partialWidth graf-after--blockquote" style="width: 50%;"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 59%;"></div><img class="graf-image" data-image-id="1*tFwdkkLP_ta2vYklWzezOg.png" data-width="2784" data-height="1642" data-action="zoom" data-action-value="1*tFwdkkLP_ta2vYklWzezOg.png" src="https://cdn-images-1.medium.com/max/600/1*tFwdkkLP_ta2vYklWzezOg.png"></div></figure><figure name="31ea" id="31ea" class="graf graf--figure graf--layoutOutsetRowContinue is-partialWidth graf-after--figure" style="width: 50%;"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 59%;"></div><img class="graf-image" data-image-id="1*qHvcFPwD-rAVgSmE6LUzFQ.png" data-width="2784" data-height="1642" data-action="zoom" data-action-value="1*qHvcFPwD-rAVgSmE6LUzFQ.png" src="https://cdn-images-1.medium.com/max/600/1*qHvcFPwD-rAVgSmE6LUzFQ.png"></div><figcaption class="imageCaption" style="width: 200%; left: -100%;">Timelines from before (left) and after (right) code splitting. Click or tap to zoom.</figcaption></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="f9bd" id="f9bd" class="graf graf--p graf-after--figure">Our original setup (above left) took over 5 seconds to load our main bundle, while after splitting out code by routes and common chunks (above right), it takes barely 3 seconds (on a simulated 3G network).</p><p name="a013" id="a013" class="graf graf--p graf-after--p">This was done early on in our performance focus sprints, but this single change made a huge difference when running Google’s <a href="https://developers.google.com/web/tools/lighthouse/" data-href="https://developers.google.com/web/tools/lighthouse/" class="markup--anchor markup--p-anchor" rel="noopener nofollow" target="_blank">Lighthouse</a> web application auditing tool:</p></div><div class="section-inner sectionLayout--outsetColumn"><figure name="d331" id="d331" class="graf graf--figure graf--layoutOutsetCenter graf-after--p graf--trailing"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1000px; max-height: 241px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 24.099999999999998%;"></div><img class="graf-image" data-image-id="1*9S6T2vjlp0cC52CTKQIM9w.png" data-width="2900" data-height="700" data-action="zoom" data-action-value="1*9S6T2vjlp0cC52CTKQIM9w.png" src="https://cdn-images-1.medium.com/max/1000/1*9S6T2vjlp0cC52CTKQIM9w.png"></div><figcaption class="imageCaption">We also ran the site before (left) and after (right) through Google’s “Lighthouse” web application auditing tool.</figcaption></figure></div></div></section><section name="a8a1" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h4 name="3bf2" id="3bf2" class="graf graf--h4 graf--leading">Avoid Functions that Cause Jank</h4><p name="80b7" id="80b7" class="graf graf--p graf-after--h4">Over many iterations of our <a href="http://itsze.ro/blog/2017/04/09/infinite-list-and-react.html" data-href="http://itsze.ro/blog/2017/04/09/infinite-list-and-react.html" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">infinite scrolling timelines</a>, we used different ways to calculate your scroll position and direction to determine if we needed to ask the API for more Tweets to display. Up until recently, we were using <a href="https://github.com/brigade/react-waypoint" data-href="https://github.com/brigade/react-waypoint" class="markup--anchor markup--p-anchor" rel="noopener nofollow" target="_blank">react-waypoint</a>, which worked well for us. However, in chasing the best possible performance for one of the main underlying components of our application, it just wasn’t fast enough.</p><p name="e114" id="e114" class="graf graf--p graf-after--p">Waypoints work by calculating many different heights, widths, and positions of elements in order to determine your current scroll position, how far from each end you are, and which direction you’re going. All of this information is useful, but since it’s done on every scroll event it comes at a cost: making those calculations causes jank–and lots of it.</p><p name="2531" id="2531" class="graf graf--p graf-after--p">But first, we have to understand what the developer tools mean when they tell us that there is “jank”.</p><blockquote name="cbfd" id="cbfd" class="graf graf--pullquote graf-after--p">Most devices today refresh their screens 60 times a second. If there’s an animation or transition running, or the user is scrolling the pages, the browser needs to match the device’s refresh rate and put up 1 new picture, or frame, for each of those screen refreshes.</blockquote><blockquote name="1fe5" id="1fe5" class="graf graf--pullquote graf-after--pullquote">Each of those frames has a budget of just over 16ms (1 second / 60 = 16.66ms). In reality, however, the browser has housekeeping work to do, so all of your work needs to be completed inside 10ms. When you fail to meet this budget the frame rate drops, and the content judders on screen. This is often referred to as jank, and it negatively impacts the user’s experience. — <a href="https://developers.google.com/web/fundamentals/performance/rendering/" data-href="https://developers.google.com/web/fundamentals/performance/rendering/" class="markup--anchor markup--pullquote-anchor" rel="nofollow noopener" target="_blank">Paul Lewis on Rendering Performance</a></blockquote><p name="3ce6" id="3ce6" class="graf graf--p graf-after--pullquote">Over time, we developed a new infinite scrolling component called <em class="markup--em markup--p-em">VirtualScroller</em>. With this new component, we know exactly what slice of Tweets are being rendered into a timeline at any given time, avoiding the need to make expensive calculations as to where we are visually.</p></div><div class="section-inner sectionLayout--outsetRow" data-paragraph-count="2"><figure name="ef1d" id="ef1d" class="graf graf--figure graf--layoutOutsetRow is-partialWidth graf-after--p" style="width: 50%;"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 59%;"></div><img class="graf-image" data-image-id="1*RwUKe8QRCKciqkOzlAv6uw.png" data-width="2784" data-height="1642" data-action="zoom" data-action-value="1*RwUKe8QRCKciqkOzlAv6uw.png" src="https://cdn-images-1.medium.com/max/600/1*RwUKe8QRCKciqkOzlAv6uw.png"></div></figure><figure name="6bf9" id="6bf9" class="graf graf--figure graf--layoutOutsetRowContinue is-partialWidth graf-after--figure" style="width: 50%;"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 59%;"></div><img class="graf-image" data-image-id="1*w_f0IMKu1DdJ36QvzX05Ug.png" data-width="2784" data-height="1642" data-action="zoom" data-action-value="1*w_f0IMKu1DdJ36QvzX05Ug.png" src="https://cdn-images-1.medium.com/max/600/1*w_f0IMKu1DdJ36QvzX05Ug.png"></div><figcaption class="imageCaption" style="width: 200%; left: -100%;">It may not look like much, but before (left) while scrolling, we would cause render jank by trying to calculate the height of various elements. After (right) we cause no jank and reduce the stuttering while scrolling timelines at fast speeds. Click or tap to zoom.</figcaption></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="a679" id="a679" class="graf graf--p graf-after--figure graf--trailing">By avoiding function calls that cause extra jank, scrolling a timeline of Tweets looks and feels more seamless, giving us a much more rich, almost native experience. While it can always be better, this change makes a noticeable improvement to the smoothness of scrolling timelines. It was a good reminder that every little bit counts when looking at performance.</p></div></div></section><section name="f146" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h4 name="0153" id="0153" class="graf graf--h4 graf--leading">Use Smaller Images</h4><p name="a4a4" id="a4a4" class="graf graf--p graf-after--h4">We first started pushing to use less bandwidth on Twitter Lite by working with multiple teams to get new and smaller sizes of images available from our <a href="https://en.wikipedia.org/wiki/Content_delivery_network" data-href="https://en.wikipedia.org/wiki/Content_delivery_network" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">CDNs</a>. It turns out, that by reducing the size of the images we were rendering to be only what we absolutely needed (both in terms of dimensions and quality), we found that not only did we reduce bandwidth usage, but that we were also able to increase performance in the browser, especially while scrolling through image-heavy timelines of Tweets.</p><p name="9b95" id="9b95" class="graf graf--p graf-after--p">In order to determine how much better smaller images are for performance, we can look at the <em class="markup--em markup--p-em">Raster </em>timeline in Chrome Developer Tools. Before we reduced the size of images, it could take 300ms or more just to decode a single image, as shown in the timeline recording below on the left. This is the processing time after an image has been downloaded, but before it can be displayed on the page.</p><p name="466c" id="466c" class="graf graf--p graf-after--p">When you’re scrolling a page and aiming for the 60 frame-per-second rendering standard, we want to keep as much processing as possible under 16.667ms (1 frame). It’s taking us nearly 18 frames just to get a single image rendered into the viewport, which is too many. One other thing to note in the timeline: you can see that the <em class="markup--em markup--p-em">Main</em> timeline is mostly blocked from continuing until this image has finished decoding (as shown by the whitespace). This means we’ve got quite a performance bottleneck here!</p></div><div class="section-inner sectionLayout--outsetRow" data-paragraph-count="2"><figure name="c1f3" id="c1f3" class="graf graf--figure graf--layoutOutsetRow is-partialWidth graf-after--p" style="width: 50%;"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 59%;"></div><img class="graf-image" data-image-id="1*Yp2fdW-mravcdr2h-RfXbg.png" data-width="2784" data-height="1642" data-action="zoom" data-action-value="1*Yp2fdW-mravcdr2h-RfXbg.png" src="https://cdn-images-1.medium.com/max/600/1*Yp2fdW-mravcdr2h-RfXbg.png"></div></figure><figure name="7dbc" id="7dbc" class="graf graf--figure graf--layoutOutsetRowContinue is-partialWidth graf-after--figure" style="width: 50%;"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 59%;"></div><img class="graf-image" data-image-id="1*yLud5u9CJbM16lqaTYlmXg.png" data-width="2784" data-height="1642" data-action="zoom" data-action-value="1*yLud5u9CJbM16lqaTYlmXg.png" src="https://cdn-images-1.medium.com/max/600/1*yLud5u9CJbM16lqaTYlmXg.png"></div><figcaption class="imageCaption" style="width: 200%; left: -100%;">Large images (left) can block the main thread from continuing for 18 frames. Small images (right) take only about 1 frame. Click or tap to zoom.</figcaption></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="de28" id="de28" class="graf graf--p graf-after--figure graf--trailing">Now, after we’ve reduced the size of our images (above, right), we’re looking at just over a single frame to decode our largest images.</p></div></div></section><section name="e3dc" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="1d10" id="1d10" class="graf graf--h3 graf--leading">Optimizing React</h3><h4 name="0947" id="0947" class="graf graf--h4 graf-after--h3">Make use of the <code class="markup--code markup--h4-code">shouldComponentUpdate method</code></h4><p name="50dd" id="50dd" class="graf graf--p graf-after--h4">A common tip for optimizing the performance of React applications is to <a href="https://facebook.github.io/react/docs/optimizing-performance.html#shouldcomponentupdate-in-action" data-href="https://facebook.github.io/react/docs/optimizing-performance.html#shouldcomponentupdate-in-action" class="markup--anchor markup--p-anchor" rel="noopener nofollow" target="_blank">use the </a><code class="markup--code markup--p-code"><a href="https://facebook.github.io/react/docs/optimizing-performance.html#shouldcomponentupdate-in-action" data-href="https://facebook.github.io/react/docs/optimizing-performance.html#shouldcomponentupdate-in-action" class="markup--anchor markup--p-anchor" rel="noopener nofollow" target="_blank">shouldComponentUpdate</a></code><a href="https://facebook.github.io/react/docs/optimizing-performance.html#shouldcomponentupdate-in-action" data-href="https://facebook.github.io/react/docs/optimizing-performance.html#shouldcomponentupdate-in-action" class="markup--anchor markup--p-anchor" rel="noopener nofollow" target="_blank"> method</a>. We try to do this wherever possible, but sometimes things slip through the cracks.</p><figure name="6fef" id="6fef" class="graf graf--figure graf--layoutOutsetLeft graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 251px; max-height: 515px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 205.20000000000002%;"></div><img class="graf-image" data-image-id="1*0u20AaM3kAsB1siq54y27w.gif" data-width="251" data-height="515" src="https://cdn-images-1.medium.com/max/600/1*0u20AaM3kAsB1siq54y27w.gif"></div><figcaption class="imageCaption">Liking the first Tweet caused both it and the entire Conversation below it to re-render!</figcaption></figure><p name="408d" id="408d" class="graf graf--p graf-after--figure">Here’s an example of a component that was always updating: When clicking the heart icon to like a Tweet in the home timeline, any <code class="markup--code markup--p-code">Conversation</code> component on screen would also re-render. In the animated example, you should see green boxes highlighting where the browser has to re-paint because we’re making the entire <code class="markup--code markup--p-code">Conversation</code> component below the Tweet we’re acting on update.</p><p name="e66f" id="e66f" class="graf graf--p graf-after--p">Below, you’ll see two flame graphs of this action. Without <code class="markup--code markup--p-code">shouldComponentUpdate</code> (left), we can see its entire tree updated and re-rendered, just to change the color of a heart somewhere else on the screen. After adding <code class="markup--code markup--p-code">shouldComponentUpdate</code> (right), we prevent the entire tree from updating and prevent wasting more than one-tenth of a second running unnecessary processing.</p></div><div class="section-inner sectionLayout--outsetRow" data-paragraph-count="2"><figure name="f819" id="f819" class="graf graf--figure graf--layoutOutsetRow is-partialWidth graf-after--p" style="width: 50%;"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 59%;"></div><img class="graf-image" data-image-id="1*eJrp7PsLeYw8x-QvTPHBeQ.png" data-width="2784" data-height="1642" data-action="zoom" data-action-value="1*eJrp7PsLeYw8x-QvTPHBeQ.png" src="https://cdn-images-1.medium.com/max/600/1*eJrp7PsLeYw8x-QvTPHBeQ.png"></div></figure><figure name="640e" id="640e" class="graf graf--figure graf--layoutOutsetRowContinue is-partialWidth graf-after--figure graf--trailing" style="width: 50%;"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 59%;"></div><img class="graf-image" data-image-id="1*j5wG547DfE5-mudV5-m51w.png" data-width="2784" data-height="1642" data-action="zoom" data-action-value="1*j5wG547DfE5-mudV5-m51w.png" src="https://cdn-images-1.medium.com/max/600/1*j5wG547DfE5-mudV5-m51w.png"></div><figcaption class="imageCaption" style="width: 200%; left: -100%;">Before (left), when liking an unrelated Tweet, entire Conversations would update and re-render. After adding shouldComponentUpdate logic (right), you can see that the component and its children are prevented from wasting CPU cycles. Click or tap to zoom.</figcaption></figure></div></div></section><section name="7a64" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h4 name="206a" id="206a" class="graf graf--h4 graf--leading">Defer Unnecessary Work until componentDidMount</h4><p name="8e52" id="8e52" class="graf graf--p graf-after--h4">This change may seem like a bit of a no-brainer, but it’s easy to forget about the little things when developing a large application like Twitter Lite.</p><p name="704f" id="704f" class="graf graf--p graf-after--p">We found that we had a lot of places in our code where we were doing expensive calculations for the sake of analytics during the <code class="markup--code markup--p-code"><a href="https://facebook.github.io/react/docs/react-component.html#componentwillmount" data-href="https://facebook.github.io/react/docs/react-component.html#componentwillmount" class="markup--anchor markup--p-anchor" rel="noopener nofollow" target="_blank">componentWillMount</a></code><a href="https://facebook.github.io/react/docs/react-component.html#componentwillmount" data-href="https://facebook.github.io/react/docs/react-component.html#componentwillmount" class="markup--anchor markup--p-anchor" rel="noopener nofollow" target="_blank"> React lifecycle method</a>. Every time we did this, we blocked rendering of components a little more. 20ms here, 90ms there, it all adds up quickly. Originally, we were trying to record which tweets were being rendered to our data analytics service in <code class="markup--code markup--p-code">componentWillMount</code>, before they were actually rendered (timeline below, left).</p></div><div class="section-inner sectionLayout--outsetRow" data-paragraph-count="2"><figure name="f4f1" id="f4f1" class="graf graf--figure graf--layoutOutsetRow is-partialWidth graf-after--p" style="width: 50%;"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 59%;"></div><img class="graf-image" data-image-id="1*-APq7-hYWlb4eYkEgV08JQ.png" data-width="2784" data-height="1642" data-action="zoom" data-action-value="1*-APq7-hYWlb4eYkEgV08JQ.png" src="https://cdn-images-1.medium.com/max/600/1*-APq7-hYWlb4eYkEgV08JQ.png"></div></figure><figure name="43c0" id="43c0" class="graf graf--figure graf--layoutOutsetRowContinue is-partialWidth graf-after--figure" style="width: 50%;"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 59%;"></div><img class="graf-image" data-image-id="1*OqyFUe7PPLjRFK7FV6mDtg.png" data-width="2784" data-height="1642" data-action="zoom" data-action-value="1*OqyFUe7PPLjRFK7FV6mDtg.png" src="https://cdn-images-1.medium.com/max/600/1*OqyFUe7PPLjRFK7FV6mDtg.png"></div><figcaption class="imageCaption" style="width: 200%; left: -100%;">By deferring non-essential code paths from `componentWillMount` to `componentDidMount`, we saved a lot of time to render Tweets to the screen. Click or tap to zoom.</figcaption></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="5dc5" id="5dc5" class="graf graf--p graf-after--figure graf--trailing">By moving that calculation and network call to the React component’s <code class="markup--code markup--p-code">componentDidMount</code> method, we unblocked the main thread and reduced unwanted jank when rendering our components (above right).</p></div></div></section><section name="ad70" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h4 name="3732" id="3732" class="graf graf--h4 graf--leading">Avoid dangerouslySetInnerHTML</h4><p name="f012" id="f012" class="graf graf--p graf-after--h4">In Twitter Lite, we use SVG icons, as they’re the most portable and scalable option available to us. Unfortunately, in older versions of React, most SVG attributes were not supported when creating elements from components. So, when we first started writing the application, we were forced to use <code class="markup--code markup--p-code">dangerouslySetInnerHTML</code> in order to use SVG icons as React components.</p><p name="9398" id="9398" class="graf graf--p graf-after--p">For example, our original HeartIcon looked something like this:</p><figure name="cf27" id="cf27" class="graf graf--figure graf--iframe graf-after--p"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 35.699999999999996%;"></div><div class="iframeContainer"><IFRAME width="700" height="250" src="/media/6e5d6a62effee7cb26d71bbb4d0f7912?postId=d28a00e780a3" data-media-id="6e5d6a62effee7cb26d71bbb4d0f7912" data-thumbnail="https://i.embed.ly/1/image?url=https%3A%2F%2Favatars2.githubusercontent.com%2Fu%2F33297%3Fv%3D3%26s%3D400&amp;key=4fce0568f2ce49e8b54624ef71a8a5bd" allowfullscreen frameborder="0"></IFRAME></div></div></figure><p name="6861" id="6861" class="graf graf--p graf-after--figure">Not only is it <a href="http://reactjs.cn/react/tips/dangerously-set-inner-html.html" data-href="http://reactjs.cn/react/tips/dangerously-set-inner-html.html" class="markup--anchor markup--p-anchor" rel="noopener nofollow" target="_blank">discouraged to use </a><code class="markup--code markup--p-code"><a href="http://reactjs.cn/react/tips/dangerously-set-inner-html.html" data-href="http://reactjs.cn/react/tips/dangerously-set-inner-html.html" class="markup--anchor markup--p-anchor" rel="noopener nofollow" target="_blank">dangerouslySetInnerHTML</a></code>, but it turns out that it’s actually a source of slowness when mounting and rendering.</p></div><div class="section-inner sectionLayout--outsetRow" data-paragraph-count="2"><figure name="9318" id="9318" class="graf graf--figure graf--layoutOutsetRow is-partialWidth graf-after--p" style="width: 50%;"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 59%;"></div><img class="graf-image" data-image-id="1*Vn4m-lma6mkRJ4SbR2HQgg.png" data-width="2784" data-height="1642" data-action="zoom" data-action-value="1*Vn4m-lma6mkRJ4SbR2HQgg.png" src="https://cdn-images-1.medium.com/max/600/1*Vn4m-lma6mkRJ4SbR2HQgg.png"></div></figure><figure name="f30e" id="f30e" class="graf graf--figure graf--layoutOutsetRowContinue is-partialWidth graf-after--figure" style="width: 50%;"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 59%;"></div><img class="graf-image" data-image-id="1*gsvIv0YPsDaE0PRFa9G2oA.png" data-width="2784" data-height="1642" data-action="zoom" data-action-value="1*gsvIv0YPsDaE0PRFa9G2oA.png" src="https://cdn-images-1.medium.com/max/600/1*gsvIv0YPsDaE0PRFa9G2oA.png"></div><figcaption class="imageCaption" style="width: 200%; left: -100%;">Before (left), you’ll see it takes roughly 20ms to mount 4 SVG icons, while after (right) it takes around 8. Click or tap to zoom.</figcaption></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="cff9" id="cff9" class="graf graf--p graf-after--figure">Analyzing the flame graphs above, our original code (left) shows that it takes about 20ms on a slow device to mount the actions at the bottom of a Tweet containing four SVG icons. While this may not seem like much on its own, knowing that we need to render many of these at once, all while scrolling a timeline of infinite Tweets, we realized that this is a huge waste of time.</p><p name="624a" id="624a" class="graf graf--p graf-after--p">Since React v15 added support for most SVG attributes, we went ahead and looked to see what would happen if we avoided <code class="markup--code markup--p-code">dangerouslySetInnerHTML</code>. Checking the patched flame graph (above right), we get about an average of <strong class="markup--strong markup--p-strong">60% savings</strong> each time we need to mount and render one of these sets of icons!</p><p name="3eba" id="3eba" class="graf graf--p graf-after--p">Now, our SVG icons are simple stateless components, don’t use “<em class="markup--em markup--p-em">dangerous”</em> functions, and mount an average of 60% faster. They look like this:</p><figure name="b0ae" id="b0ae" class="graf graf--figure graf--iframe graf-after--p graf--trailing"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 35.699999999999996%;"></div><div class="iframeContainer"><IFRAME width="700" height="250" src="/media/def554b848095d8a129f38a6f36e3000?postId=d28a00e780a3" data-media-id="def554b848095d8a129f38a6f36e3000" data-thumbnail="https://i.embed.ly/1/image?url=https%3A%2F%2Favatars2.githubusercontent.com%2Fu%2F33297%3Fv%3D3%26s%3D400&amp;key=4fce0568f2ce49e8b54624ef71a8a5bd" allowfullscreen frameborder="0"></IFRAME></div></div></figure></div></div></section><section name="631c" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h4 name="b1f2" id="b1f2" class="graf graf--h4 graf--leading">Defer Rendering When Mounting &amp; Unmounting Many Components</h4><p name="0c3b" id="0c3b" class="graf graf--p graf-after--h4">On slower devices, we noticed that it could take a long time for our main navigation bar to appear to respond to taps, often leading us to tap multiple times, thinking that perhaps the first tap didn’t register.</p><p name="66be" id="66be" class="graf graf--p graf-after--p">Notice in the image below how the Home icon takes nearly 2 seconds to update and show that it was tapped:</p></div><div class="section-inner sectionLayout--outsetColumn"><figure name="efec" id="efec" class="graf graf--figure graf--layoutOutsetCenter graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 252px; max-height: 515px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 204.4%;"></div><img class="graf-image" data-image-id="1*mDPjaeBNhCAbEcbKV-IX3Q.gif" data-width="252" data-height="515" src="https://cdn-images-1.medium.com/max/1000/1*mDPjaeBNhCAbEcbKV-IX3Q.gif"></div><figcaption class="imageCaption">Without deferring rendering, the navigation bar takes time to respond.</figcaption></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="3874" id="3874" class="graf graf--p graf-after--figure">No, that wasn’t just the GIF running a slow frame rate. It actually was that slow. But, all of the data for the Home screen was already loaded, so why is it taking so long to show anything?</p><p name="1f10" id="1f10" class="graf graf--p graf-after--p">It turns out that mounting and unmounting large trees of components (like timelines of Tweets) is very expensive in React.</p><p name="9089" id="9089" class="graf graf--p graf-after--p">At the very least, we wanted to remove the perception of the navigation bar not reacting to user input. For that, we created a small higher-order-component:</p><figure name="8644" id="8644" class="graf graf--figure graf--iframe graf-after--p"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 35.699999999999996%;"></div><div class="iframeContainer"><IFRAME width="700" height="250" src="/media/62cd780f6ca315521a65d129ba66a4da?postId=d28a00e780a3" data-media-id="62cd780f6ca315521a65d129ba66a4da" data-thumbnail="https://i.embed.ly/1/image?url=https%3A%2F%2Favatars2.githubusercontent.com%2Fu%2F33297%3Fv%3D3%26s%3D400&amp;key=4fce0568f2ce49e8b54624ef71a8a5bd" allowfullscreen frameborder="0"></IFRAME></div></div><figcaption class="imageCaption">Our HigherOrderComponent, as written by <a href="https://mobile.twitter.com/katiesievert" data-href="https://mobile.twitter.com/katiesievert" class="markup--anchor markup--figure-anchor" rel="noopener nofollow" target="_blank">Katie Sievert</a>.</figcaption></figure><p name="96df" id="96df" class="graf graf--p graf-after--figure">Once applied to our HomeTimeline, we saw near-instant responses of the navigation bar, leading to a <em class="markup--em markup--p-em">perceived</em> improvement overall.</p><pre name="717d" id="717d" class="graf graf--pre graf-after--p">const DeferredTimeline = deferComponentRender(HomeTimeline);<br>render(&lt;DeferredTimeline /&gt;);</pre><figure name="81f3" id="81f3" class="graf graf--figure graf-after--pre graf--trailing"><div class="aspectRatioPlaceholder is-locked" style="max-width: 252px; max-height: 515px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 204.4%;"></div><img class="graf-image" data-image-id="1*xmnXK7YFnPgxlosY7_aZ8w.gif" data-width="252" data-height="515" src="https://cdn-images-1.medium.com/max/800/1*xmnXK7YFnPgxlosY7_aZ8w.gif"></div><figcaption class="imageCaption">After deferring rendering, the navigation bar responds instantly.</figcaption></figure></div></div></section><section name="c40b" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="46e1" id="46e1" class="graf graf--h3 graf--leading">Optimizing Redux</h3><h4 name="29e1" id="29e1" class="graf graf--h4 graf-after--h3">Avoid Storing State Too Often</h4><p name="2c9b" id="2c9b" class="graf graf--p graf-after--h4">While <a href="https://facebook.github.io/react/docs/forms.html#controlled-components" data-href="https://facebook.github.io/react/docs/forms.html#controlled-components" class="markup--anchor markup--p-anchor" rel="noopener nofollow" target="_blank">controlled components</a> seem to be the recommended approach, making inputs controlled means that they have to update and re-render for every keypress.</p><p name="87c5" id="87c5" class="graf graf--p graf-after--p">While this is not very taxing on a 3GHz desktop computer, a small mobile device with very limited CPU will notice significant lag while typing–especially when deleting many characters from the input.</p><p name="a5a4" id="a5a4" class="graf graf--p graf-after--p">In order to persist the value of composing Tweets, as well as calculating the number of characters remaining, we were using a controlled component and <em class="markup--em markup--p-em">also </em>passing the current value of the input to our Redux state at each keypress.</p><p name="00b0" id="00b0" class="graf graf--p graf-after--p">Below (left), on a typical Android 5 device, every keypress leading to a change could cause nearly 200ms of overhead. Compound this by a fast typist, and we ended up in a really bad state, with users often reporting that their character insertion point was moving all over the place, resulting in jumbled sentences.</p></div><div class="section-inner sectionLayout--outsetRow" data-paragraph-count="2"><figure name="2cdd" id="2cdd" class="graf graf--figure graf--layoutOutsetRow is-partialWidth graf-after--p" style="width: 50%;"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 59%;"></div><img class="graf-image" data-image-id="1*tClsk9W3EZCdAvv-fdD-tQ.png" data-width="2784" data-height="1642" data-action="zoom" data-action-value="1*tClsk9W3EZCdAvv-fdD-tQ.png" src="https://cdn-images-1.medium.com/max/600/1*tClsk9W3EZCdAvv-fdD-tQ.png"></div></figure><figure name="987c" id="987c" class="graf graf--figure graf--layoutOutsetRowContinue is-partialWidth graf-after--figure" style="width: 50%;"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 59%;"></div><img class="graf-image" data-image-id="1*pLqxpsHk7H0dIqqxzAbxlA.png" data-width="2784" data-height="1642" data-action="zoom" data-action-value="1*pLqxpsHk7H0dIqqxzAbxlA.png" src="https://cdn-images-1.medium.com/max/600/1*pLqxpsHk7H0dIqqxzAbxlA.png"></div><figcaption class="imageCaption" style="width: 200%; left: -100%;">Comparisons of the amount of time it takes to update after each keypress while dispatching the change to Redux and when not. Click or tap to zoom.</figcaption></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="c295" id="c295" class="graf graf--p graf-after--figure graf--trailing">By removing the draft Tweet state from updating the main Redux state on every keypress and keeping things local in the React component’s state, we were able to reduce the overhead by over 50% (above, right).</p></div></div></section><section name="c81e" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h4 name="e674" id="e674" class="graf graf--h4 graf--leading">Batch Actions into a Single Dispatch</h4><p name="d5fc" id="d5fc" class="graf graf--p graf-after--h4">In Twitter Lite, we’re using <a href="http://redux.js.org/" data-href="http://redux.js.org/" class="markup--anchor markup--p-anchor" rel="noopener nofollow" target="_blank">redux</a> with <a href="http://redux.js.org/docs/basics/UsageWithReact.html" data-href="http://redux.js.org/docs/basics/UsageWithReact.html" class="markup--anchor markup--p-anchor" rel="noopener nofollow" target="_blank">react-redux</a> to subscribe our components to data state changes. We’ve optimized our data into separate areas of a larger store with <a href="https://github.com/paularmstrong/normalizr" data-href="https://github.com/paularmstrong/normalizr" class="markup--anchor markup--p-anchor" rel="noopener nofollow" target="_blank">Normalizr</a> and <a href="http://redux.js.org/docs/api/combineReducers.html" data-href="http://redux.js.org/docs/api/combineReducers.html" class="markup--anchor markup--p-anchor" rel="noopener nofollow" target="_blank">combineReducers</a>. This all works wonderfully to prevent duplication of data and keep our stores small. However, each time we get new data, we have to dispatch multiple actions in order to add it to the appropriate stores.</p><p name="0136" id="0136" class="graf graf--p graf-after--p">With the way that react-redux works, this means that every action dispatched will cause our connected components (called Containers) to recalculate changes and possibly re-render.</p><p name="4cf6" id="4cf6" class="graf graf--p graf-after--p">While we use a custom middleware, there are <a href="https://www.npmjs.com/package/redux-batched-actions" data-href="https://www.npmjs.com/package/redux-batched-actions" class="markup--anchor markup--p-anchor" rel="noopener nofollow" target="_blank">other</a> <a href="https://www.npmjs.com/package/redux-batch-middleware" data-href="https://www.npmjs.com/package/redux-batch-middleware" class="markup--anchor markup--p-anchor" rel="noopener nofollow" target="_blank">batch</a> <a href="https://www.npmjs.com/package/redux-batch-enhancer" data-href="https://www.npmjs.com/package/redux-batch-enhancer" class="markup--anchor markup--p-anchor" rel="noopener nofollow" target="_blank">middleware</a> <a href="https://www.npmjs.com/package/redux-batch-actions" data-href="https://www.npmjs.com/package/redux-batch-actions" class="markup--anchor markup--p-anchor" rel="noopener nofollow" target="_blank">available</a>. Choose the one that’s right for you, or write your own.</p><p name="861f" id="861f" class="graf graf--p graf-after--p">The best way to illustrate the benefits of batching actions is by using the <a href="https://github.com/crysislinux/chrome-react-perf" data-href="https://github.com/crysislinux/chrome-react-perf" class="markup--anchor markup--p-anchor" rel="noopener nofollow" target="_blank">Chrome React Perf Extension</a>. After the initial load, we pre-cache and calculate unread DMs in the background. When that happens we add a lot of various entities (conversations, users, message entries, etc). <em class="markup--em markup--p-em">Without batching</em> (below left), you can see that we end up with double the number of times we render each component (~16) versus <em class="markup--em markup--p-em">with batching</em> (~8) (below right).</p></div><div class="section-inner sectionLayout--outsetRow" data-paragraph-count="2"><figure name="b650" id="b650" class="graf graf--figure graf--layoutOutsetRow is-partialWidth graf-after--p" style="width: 50%;"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 109.89999999999999%;"></div><img class="graf-image" data-image-id="1*o745G2ux9ZMLx3-rVWECBQ.png" data-width="2784" data-height="3060" data-action="zoom" data-action-value="1*o745G2ux9ZMLx3-rVWECBQ.png" src="https://cdn-images-1.medium.com/max/600/1*o745G2ux9ZMLx3-rVWECBQ.png"></div></figure><figure name="ffb5" id="ffb5" class="graf graf--figure graf--layoutOutsetRowContinue is-partialWidth graf-after--figure graf--trailing" style="width: 50%;"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 109.89999999999999%;"></div><img class="graf-image" data-image-id="1*XBFV8VKRE16bSrBixvBc7g.png" data-width="2784" data-height="3060" data-action="zoom" data-action-value="1*XBFV8VKRE16bSrBixvBc7g.png" src="https://cdn-images-1.medium.com/max/600/1*XBFV8VKRE16bSrBixvBc7g.png"></div><figcaption class="imageCaption" style="width: 200%; left: -100%;">A comparison using the React Perf extension for Chrome without batch-dispatch in Redux (left) vs with batch-dispatch (right). Click or tap to zoom.</figcaption></figure></div></div></section><section name="b527" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="dd75" id="dd75" class="graf graf--h3 graf--leading">Service Workers</h3><p name="12f2" id="12f2" class="graf graf--p graf-after--h3">While Service Workers aren’t available in all browsers yet, they’re an invaluable part of Twitter Lite. When available, we use ours for push notifications, to pre-cache application assets, and more. Unfortunately, being a fairly new technology, there’s still a lot to learn around performance.</p><h4 name="8255" id="8255" class="graf graf--h4 graf-after--p">Pre-Cache Assets</h4><p name="d6e3" id="d6e3" class="graf graf--p graf-after--h4">Like most products, Twitter Lite is by no means done. We’re still actively developing it, adding features, fixing bugs, and making it faster. This means we frequently need to deploy new versions of our JavaScript assets.</p><p name="88bf" id="88bf" class="graf graf--p graf-after--p">Unfortunately, this can be a burden when users come back to the application and need to re-download a bunch of script files just to view a single Tweet.</p><p name="e496" id="e496" class="graf graf--p graf-after--p">In ServiceWorker-enabled browsers, we get the benefit of being able to have the worker automatically update, download, and cache any changed files in the background, on its own, before you come back.</p><p name="c11e" id="c11e" class="graf graf--p graf-after--p">So what does this mean for the user? Near instant subsequent application loads, even after we’ve deployed a new version!</p></div><div class="section-inner sectionLayout--outsetRow" data-paragraph-count="2"><figure name="9f11" id="9f11" class="graf graf--figure graf--layoutOutsetRow is-partialWidth graf-after--p" style="width: 50%;"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 59%;"></div><img class="graf-image" data-image-id="1*nHge71VwyFkxbgDUOROeqQ.png" data-width="2784" data-height="1642" data-action="zoom" data-action-value="1*nHge71VwyFkxbgDUOROeqQ.png" src="https://cdn-images-1.medium.com/max/600/1*nHge71VwyFkxbgDUOROeqQ.png"></div></figure><figure name="4eca" id="4eca" class="graf graf--figure graf--layoutOutsetRowContinue is-partialWidth graf-after--figure" style="width: 50%;"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 59%;"></div><img class="graf-image" data-image-id="1*r51dWgMIwA8-jFKno0_RcQ.png" data-width="2784" data-height="1642" data-action="zoom" data-action-value="1*r51dWgMIwA8-jFKno0_RcQ.png" src="https://cdn-images-1.medium.com/max/600/1*r51dWgMIwA8-jFKno0_RcQ.png"></div><figcaption class="imageCaption" style="width: 200%; left: -100%;">Network asset load times without ServiceWorker pre-caching (left) vs with pre-caching (right). Click or tap to zoom.</figcaption></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="8647" id="8647" class="graf graf--p graf-after--figure graf--trailing">As illustrated above (left) without ServiceWorker pre-caching, every asset for the current view is forced to load from the network when returning to the application. It takes about 6 seconds on a good 3G network to finish loading. However, when the assets are pre-cached by the ServiceWorker (above right), the same 3G network takes less than 1.5 seconds before the page is finished loading. A 75% improvement!</p></div></div></section><section name="3c99" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h4 name="c8cf" id="c8cf" class="graf graf--h4 graf--leading">Delay ServiceWorker Registration</h4><p name="ace2" id="ace2" class="graf graf--p graf-after--h4">In many applications, it’s safe to register a ServiceWorker immediately on page load:</p><pre name="3fa0" id="3fa0" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">&lt;script&gt;<br>window.navigator.serviceWorker.register(&#39;/sw.js&#39;);<br>&lt;/script&gt;</code></pre><p name="a032" id="a032" class="graf graf--p graf-after--pre">While we try to send as much data to the browser as possible to render a complete-looking page, in Twitter Lite this isn’t always possible. We may not have sent enough data, or the page you’re landing on may not support data pre-filled from the server. Because of this and various other limitations, we need to make some API requests immediately after the initial page load.</p><p name="498f" id="498f" class="graf graf--p graf-after--p">Normally, this isn’t a problem. However, if the browser hasn’t installed the current version of our ServiceWorker yet, we need to tell it to install–and with that comes about 50 requests to pre-cache various JS, CSS, and image assets.</p><p name="3225" id="3225" class="graf graf--p graf-after--p">When we were using the simple approach of registering our ServiceWorker immediately, we could see the network contention happening within the browser, maxing out our parallel request limit (below left).</p></div><div class="section-inner sectionLayout--outsetRow" data-paragraph-count="2"><figure name="4e57" id="4e57" class="graf graf--figure graf--layoutOutsetRow is-partialWidth graf-after--p" style="width: 49.982%;"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 73.7%;"></div><img class="graf-image" data-image-id="1*jLT8J20RRfKY_oxcsAiswQ.png" data-width="2784" data-height="2052" data-action="zoom" data-action-value="1*jLT8J20RRfKY_oxcsAiswQ.png" src="https://cdn-images-1.medium.com/max/600/1*jLT8J20RRfKY_oxcsAiswQ.png"></div></figure><figure name="e947" id="e947" class="graf graf--figure graf--layoutOutsetRowContinue is-partialWidth graf-after--figure" style="width: 50.018%;"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 73.6%;"></div><img class="graf-image" data-image-id="1*poli81EjMdim8__g1HMioQ.png" data-width="2784" data-height="2050" data-action="zoom" data-action-value="1*poli81EjMdim8__g1HMioQ.png" src="https://cdn-images-1.medium.com/max/600/1*poli81EjMdim8__g1HMioQ.png"></div><figcaption class="imageCaption" style="width: 199.928%; left: -99.928%;">Notice how when registering your service worker immediately, it can block all other network requests (left). Deferring the service worker (right) allows your initial page load to make required network requests without getting blocked by the concurrent connection limit of the browser. Click or tap to zoom.</figcaption></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="fe69" id="fe69" class="graf graf--p graf-after--figure graf--trailing">By delaying the ServiceWorker registration until we’ve finished loading extra API requests, CSS and image assets, we allow the page to finish rendering and be responsive, as illustrated in the after screenshot (above right).</p></div></div></section><section name="819c" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="f30f" id="f30f" class="graf graf--p graf--leading graf--trailing">Overall, this is a list of just some of the many improvements that we’ve made over time to <a href="https://mobile.twitter.com" data-href="https://mobile.twitter.com" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">Twitter Lite</a>. There are certainly more to come and we hope to continue sharing the problems we find and the ways that we work to overcome them. For more about what’s going on in real-time and more React &amp; PWA insights, follow <a href="https://mobile.twitter.com/paularmstrong" data-href="https://mobile.twitter.com/paularmstrong" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">me</a> and <a href="https://mobile.twitter.com/paularmstrong/lists/twitter-lite/members" data-href="https://mobile.twitter.com/paularmstrong/lists/twitter-lite/members" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">the team</a> on Twitter.</p></div></div></section></div><footer class="u-paddingTop10"><div class="container u-maxWidth740"><div class="row"><div class="col u-size12of12"><div class="postMetaInline postMetaInline--acknowledgments u-paddingTop5 u-paddingBottom20 js-postMetaAcknowledgments"><span data-tooltip="The following people helped the author by providing feedback before the story was published.">Thanks to</span> <span><a class="link u-baseColor--link"  href="https://medium.com/@necolas?source=post_page" data-action="show-user-card" data-action-source="post_page" data-action-value="852b96450d4c" data-action-type="hover" data-user-id="852b96450d4c" dir="auto">Nicolas Gallagher</a>, </span><span><a class="link u-baseColor--link"  href="https://medium.com/@jondkoon?source=post_page" data-action="show-user-card" data-action-source="post_page" data-action-value="82c9e373c053" data-action-type="hover" data-user-id="82c9e373c053" dir="auto">Jon Koon</a>, </span><span><a class="link u-baseColor--link"  href="https://medium.com/@jqnbox?source=post_page" data-action="show-user-card" data-action-source="post_page" data-action-value="4f89e3965db7" data-action-type="hover" data-user-id="4f89e3965db7" dir="auto">Jan Castor</a>, and </span><span><a class="link u-baseColor--link"  href="https://medium.com/@itszero?source=post_page" data-action="show-user-card" data-action-source="post_page" data-action-value="a45c7adc4f45" data-action-type="hover" data-user-id="a45c7adc4f45" dir="auto">Zero Cho</a></span>. </div></div></div><div class="row"><div class="col u-size12of12 js-postTags"><div class="u-paddingBottom10"><ul class="tags tags--postTags tags--borderless"><li><a class="link u-baseColor--link"  href="https://medium.com/tag/javascript?source=post" data-action-source="post">JavaScript</a></li><li><a class="link u-baseColor--link"  href="https://medium.com/tag/web-development?source=post" data-action-source="post">Web Development</a></li><li><a class="link u-baseColor--link"  href="https://medium.com/tag/reactjs?source=post" data-action-source="post">Reactjs</a></li><li><a class="link u-baseColor--link"  href="https://medium.com/tag/twitter?source=post" data-action-source="post">Twitter</a></li><li><a class="link u-baseColor--link"  href="https://medium.com/tag/progressive-web-app?source=post" data-action-source="post">Progressive Web App</a></li></ul></div></div></div><div class="row js-postActionsFooter"><div class="postActions col u-size12of12"><div class="u-floatLeft buttonSet buttonSet--withLabels"><div class="buttonSet-inner"><div class="js-actionRecommend" data-post-id="d28a00e780a3" data-is-icon-29px="true" data-has-recommend-list="true" data-source="post_actions_footer"><button class="button button--primary button--large button--chromeless is-touchIconFadeInPulse u-accentColor--buttonNormal button--withIcon button--withSvgIcon u-accentColor--iconLight js-actionRecommendButton"  title="Recommend to share this article with your followers and let the author know you liked it" aria-label="Recommend to share this article with your followers and let the author know you liked it" data-action="sign-in-prompt" data-sign-in-action="upvote" data-requires-token="true" data-redirect="https://medium.com/_/vote/p/d28a00e780a3" data-action-source="post_actions_footer"><span class="button-defaultState"><span class="svgIcon svgIcon--heart svgIcon--29px"><svg class="svgIcon-use" width="29" height="29" viewBox="0 0 29 29" ><path d="M16.215 23.716c-.348.288-.984.826-1.376 1.158a.526.526 0 0 1-.68 0c-.36-.307-.92-.78-1.22-1.03C9.22 20.734 3 15.527 3 10.734 3 7.02 5.916 4 9.5 4c1.948 0 3.77.898 5 2.434C15.73 4.898 17.552 4 19.5 4c3.584 0 6.5 3.02 6.5 6.734 0 4.9-6.125 9.96-9.785 12.982zM19.5 5.2c-1.774 0-3.423.923-4.41 2.468a.699.699 0 0 1-.59.323.706.706 0 0 1-.59-.32c-.988-1.54-2.637-2.47-4.41-2.47-2.922 0-5.3 2.49-5.3 5.54 0 4.23 6.19 9.41 9.517 12.19.217.18.566.48.783.66l.952-.79c3.496-2.88 9.348-7.72 9.348-12.05 0-3.05-2.378-5.53-5.3-5.53z"/></svg></span></span><span class="button-activeState"><span class="svgIcon svgIcon--heartFilled svgIcon--29px"><svg class="svgIcon-use" width="29" height="29" viewBox="0 0 29 29" ><path d="M19.5 4c-1.948 0-3.77.898-5 2.434C13.27 4.898 11.448 4 9.5 4 5.916 4 3 7.02 3 10.734c0 4.793 6.227 10 9.95 13.11.296.25.853.723 1.212 1.03.196.166.48.166.677 0 .39-.332 1.02-.87 1.37-1.158 3.66-3.022 9.79-8.08 9.79-12.982C26 7.02 23.08 4 19.5 4z" fill-rule="evenodd"/></svg></span></span></button><button class="button button--chromeless u-baseColor--buttonNormal"  data-action="show-recommends" data-action-value="d28a00e780a3">1K</button></div></div><div class="buttonSet-inner"><button class="button button--large button--dark button--chromeless is-touchIconBlackPulse u-baseColor--buttonDark button--withIcon button--withSvgIcon"  data-action="scroll-to-responses" data-action-source="post_actions_footer"><span class="svgIcon svgIcon--response svgIcon--29px"><svg class="svgIcon-use" width="29" height="29" viewBox="0 0 29 29" ><path d="M21.27 20.058c1.89-1.826 2.754-4.17 2.754-6.674C24.024 8.21 19.67 4 14.1 4 8.53 4 4 8.21 4 13.384c0 5.175 4.53 9.385 10.1 9.385 1.007 0 2-.14 2.95-.41.285.25.592.49.918.7 1.306.87 2.716 1.31 4.19 1.31.276-.01.494-.14.6-.36a.625.625 0 0 0-.052-.65c-.61-.84-1.042-1.71-1.282-2.58a5.417 5.417 0 0 1-.154-.75zm-3.85 1.324l-.083-.28-.388.12a9.72 9.72 0 0 1-2.85.424c-4.96 0-8.99-3.706-8.99-8.262 0-4.556 4.03-8.263 8.99-8.263 4.95 0 8.77 3.71 8.77 8.27 0 2.25-.75 4.35-2.5 5.92l-.24.21v.32c0 .07 0 .19.02.37.03.29.1.6.19.92.19.7.49 1.4.89 2.08-.93-.14-1.83-.49-2.67-1.06-.34-.22-.88-.48-1.16-.74z"/></svg></span></button><button class="button button--chromeless u-baseColor--buttonNormal"  data-action="scroll-to-responses">14</button></div></div><div class="u-floatRight buttonSet buttonSet--narrow"><button class="button button--large button--dark button--chromeless is-touchIconBlackPulse u-baseColor--buttonDark button--withIcon button--withSvgIcon"  title="Share on Twitter" aria-label="Share on Twitter" data-action="share-on-twitter" data-action-source="post_actions_footer"><span class="svgIcon svgIcon--twitter svgIcon--29px"><svg class="svgIcon-use" width="29" height="29" viewBox="0 0 29 29" ><path d="M21.967 11.8c.018 5.93-4.607 11.18-11.177 11.18-2.172 0-4.25-.62-6.047-1.76l-.268.422-.038.5.186.013.168.012c.3.02.44.032.6.046 2.06-.026 3.95-.686 5.49-1.86l1.12-.85-1.4-.048c-1.57-.055-2.92-1.08-3.36-2.51l-.48.146-.05.5c.22.03.48.05.75.08.48-.02.87-.07 1.25-.15l2.33-.49-2.32-.49c-1.68-.35-2.91-1.83-2.91-3.55 0-.05 0-.01-.01.03l-.49-.1-.25.44c.63.36 1.35.57 2.07.58l1.7.04L7.4 13c-.978-.662-1.59-1.79-1.618-3.047a4.08 4.08 0 0 1 .524-1.8l-.825.07a12.188 12.188 0 0 0 8.81 4.515l.59.033-.06-.59v-.02c-.05-.43-.06-.63-.06-.87a3.617 3.617 0 0 1 6.27-2.45l.2.21.28-.06c1.01-.22 1.94-.59 2.73-1.09l-.75-.56c-.1.36-.04.89.12 1.36.23.68.58 1.13 1.17.85l-.21-.45-.42-.27c-.52.8-1.17 1.48-1.92 2L22 11l.016.28c.013.2.014.35 0 .52v.04zm.998.038c.018-.22.017-.417 0-.66l-.498.034.284.41a8.183 8.183 0 0 0 2.2-2.267l.97-1.48-1.6.755c.17-.08.3-.02.34.03a.914.914 0 0 1-.13-.292c-.1-.297-.13-.64-.1-.766l.36-1.254-1.1.695c-.69.438-1.51.764-2.41.963l.48.15a4.574 4.574 0 0 0-3.38-1.484 4.616 4.616 0 0 0-4.61 4.613c0 .29.02.51.08.984l.01.02.5-.06.03-.5c-3.17-.18-6.1-1.7-8.08-4.15l-.48-.56-.36.64c-.39.69-.62 1.48-.65 2.28.04 1.61.81 3.04 2.06 3.88l.3-.92c-.55-.02-1.11-.17-1.6-.45l-.59-.34-.14.67c-.02.08-.02.16 0 .24-.01 2.12 1.55 4.01 3.69 4.46l.1-.49-.1-.49c-.33.07-.67.12-1.03.14-.18-.02-.43-.05-.64-.07l-.76-.09.23.73c.57 1.84 2.29 3.14 4.28 3.21l-.28-.89a8.252 8.252 0 0 1-4.85 1.66c-.12-.01-.26-.02-.56-.05l-.17-.01-.18-.01L2.53 21l1.694 1.07a12.233 12.233 0 0 0 6.58 1.917c7.156 0 12.2-5.73 12.18-12.18l-.002.04z"/></svg></span></button><button class="button button--large button--dark button--chromeless is-touchIconBlackPulse u-baseColor--buttonDark button--withIcon button--withSvgIcon"  title="Share on Facebook" aria-label="Share on Facebook" data-action="share-on-facebook" data-action-source="post_actions_footer"><span class="svgIcon svgIcon--facebook svgIcon--29px"><svg class="svgIcon-use" width="29" height="29" viewBox="0 0 29 29" ><path d="M16.39 23.61v-5.808h1.846a.55.55 0 0 0 .546-.48l.36-2.797a.551.551 0 0 0-.547-.62H16.39V12.67c0-.67.12-.813.828-.813h1.474a.55.55 0 0 0 .55-.55V8.803a.55.55 0 0 0-.477-.545c-.436-.06-1.36-.116-2.22-.116-2.5 0-4.13 1.62-4.13 4.248v1.513H10.56a.551.551 0 0 0-.55.55v2.797c0 .304.248.55.55.55h1.855v5.76c-4.172-.96-7.215-4.7-7.215-9.1 0-5.17 4.17-9.36 9.31-9.36 5.14 0 9.31 4.19 9.31 9.36 0 4.48-3.155 8.27-7.43 9.15M14.51 4C8.76 4 4.1 8.684 4.1 14.46c0 5.162 3.75 9.523 8.778 10.32a.55.55 0 0 0 .637-.543v-6.985a.551.551 0 0 0-.55-.55H11.11v-1.697h1.855a.55.55 0 0 0 .55-.55v-2.063c0-2.02 1.136-3.148 3.03-3.148.567 0 1.156.027 1.597.06v1.453h-.924c-1.363 0-1.93.675-1.93 1.912v1.78c0 .3.247.55.55.55h2.132l-.218 1.69H15.84c-.305 0-.55.24-.55.55v7.02c0 .33.293.59.623.54 5.135-.7 9.007-5.11 9.007-10.36C24.92 8.68 20.26 4 14.51 4"/></svg></span></button></div></div></div></div><div class="js-postPromotionWrapper postPromotionWrapper" data-location-id="footer_above_post_attribution"></div><div class="container u-maxWidth740 js-postAttributionFooterContainer u-paddingTop20 u-paddingBottom20 u-marginTop10 u-borderTopLightest u-xs-paddingTop10 u-xs-paddingBottom10"><div class="row js-postFooterInfo"><div class="col u-size12of12"><li class="u-block u-paddingBottom18 js-cardUser"><div class="u-marginLeft20 u-floatRight"><span class="followState js-followState buttonSet-inner" data-user-id="b97642f6668f"><button class="button button--small u-noUserSelect button--withChrome u-baseColor--buttonNormal button--withHover button--unblock js-unblockButton"  data-action="sign-in-prompt" data-sign-in-action="toggle-block-user" data-requires-token="true" data-action-source="footer_card"><span class="button-label  button-defaultState">Blocked</span><span class="button-label button-hoverState">Unblock</span></button><button class="button button--primary button--small u-noUserSelect button--withChrome u-accentColor--buttonNormal button--follow js-followButton"  data-action="sign-in-prompt" data-sign-in-action="toggle-subscribe-user" data-requires-token="true" data-redirect="https://medium.com/_/subscribe/user/b97642f6668f" data-action-source="footer_card_follow"><span class="button-label  button-defaultState js-buttonLabel">Follow</span><span class="button-label button-activeState">Following</span></button></span></div><div class="u-tableCell "><a class="link avatar u-baseColor--link"  href="https://medium.com/@paularmstrong?source=footer_card" title="Go to the profile of Paul Armstrong" aria-label="Go to the profile of Paul Armstrong" data-action-source="footer_card" data-user-id="b97642f6668f" dir="auto"><img  src="https://cdn-images-1.medium.com/fit/c/60/60/1*dgq6_20nGwOd_-UZeUXbQA.jpeg" class="avatar-image avatar-image--small" alt="Go to the profile of Paul Armstrong"></a></div><div class="u-tableCell u-verticalAlignMiddle u-breakWord u-paddingLeft15"><h3 class="u-fontSize18 u-lineHeightTighter u-marginBottom4"><a class="link link--primary u-accentColor--hoverTextNormal"  href="https://medium.com/@paularmstrong" property="cc:attributionName" title="Go to the profile of Paul Armstrong" aria-label="Go to the profile of Paul Armstrong" rel="author cc:attributionUrl" data-user-id="b97642f6668f" dir="auto">Paul Armstrong</a></h3><p class="u-fontSize14 u-lineHeightBaseSans u-textColorDark u-marginBottom4">Writing React.js on <a href="http://twitter.com/Twitter" target="_blank" title="Twitter profile for @Twitter">@Twitter</a> Lite.</p></div></li></div></div></div><div class="js-postFooterPlacements"></div><div class="u-padding0 u-clearfix u-backgroundGrayLightest u-print-hide supplementalPostContent js-responsesWrapper"></div><div class="supplementalPostContent js-readNext"></div><div class="supplementalPostContent js-heroPromo"></div></footer></article></main><div class="u-marginAuto u-maxWidth1000"><div class="js-postShareWidget u-foreground u-sm-hide u-transition--fadeOut300 u-fixed"><ul><li class="u-uiTextSemibold u-textAlignCenter u-textColorNormal u-fontSize12 u-textUppercase">Share</li><li class="u-textAlignCenter"><div class="js-actionRecommend" data-post-id="d28a00e780a3" data-is-icon-29px="true" data-is-vertical="true" data-has-recommend-list="true" data-source="post_share_widget"><button class="button button--primary button--large button--chromeless is-touchIconFadeInPulse u-accentColor--buttonNormal button--withIcon button--withSvgIcon u-accentColor--iconLight js-actionRecommendButton"  title="Recommend to share this article with your followers and let the author know you liked it" aria-label="Recommend to share this article with your followers and let the author know you liked it" data-action="sign-in-prompt" data-sign-in-action="upvote" data-requires-token="true" data-redirect="https://medium.com/_/vote/p/d28a00e780a3" data-action-source="post_share_widget"><span class="button-defaultState"><span class="svgIcon svgIcon--heart svgIcon--29px"><svg class="svgIcon-use" width="29" height="29" viewBox="0 0 29 29" ><path d="M16.215 23.716c-.348.288-.984.826-1.376 1.158a.526.526 0 0 1-.68 0c-.36-.307-.92-.78-1.22-1.03C9.22 20.734 3 15.527 3 10.734 3 7.02 5.916 4 9.5 4c1.948 0 3.77.898 5 2.434C15.73 4.898 17.552 4 19.5 4c3.584 0 6.5 3.02 6.5 6.734 0 4.9-6.125 9.96-9.785 12.982zM19.5 5.2c-1.774 0-3.423.923-4.41 2.468a.699.699 0 0 1-.59.323.706.706 0 0 1-.59-.32c-.988-1.54-2.637-2.47-4.41-2.47-2.922 0-5.3 2.49-5.3 5.54 0 4.23 6.19 9.41 9.517 12.19.217.18.566.48.783.66l.952-.79c3.496-2.88 9.348-7.72 9.348-12.05 0-3.05-2.378-5.53-5.3-5.53z"/></svg></span></span><span class="button-activeState"><span class="svgIcon svgIcon--heartFilled svgIcon--29px"><svg class="svgIcon-use" width="29" height="29" viewBox="0 0 29 29" ><path d="M19.5 4c-1.948 0-3.77.898-5 2.434C13.27 4.898 11.448 4 9.5 4 5.916 4 3 7.02 3 10.734c0 4.793 6.227 10 9.95 13.11.296.25.853.723 1.212 1.03.196.166.48.166.677 0 .39-.332 1.02-.87 1.37-1.158 3.66-3.022 9.79-8.08 9.79-12.982C26 7.02 23.08 4 19.5 4z" fill-rule="evenodd"/></svg></span></span></button><button class="button button--chromeless u-baseColor--buttonNormal  u-block u-marginAuto u-marginTopNegative5"  data-action="show-recommends" data-action-value="d28a00e780a3">1K</button></div></li><li class="u-textAlignCenter"><button class="button button--large button--dark button--chromeless is-touchIconBlackPulse u-baseColor--buttonDark button--withIcon button--withSvgIcon"  title="Share on Twitter" aria-label="Share on Twitter" data-action="share-on-twitter" data-action-source="post_share_widget"><span class="svgIcon svgIcon--twitter svgIcon--29px"><svg class="svgIcon-use" width="29" height="29" viewBox="0 0 29 29" ><path d="M21.967 11.8c.018 5.93-4.607 11.18-11.177 11.18-2.172 0-4.25-.62-6.047-1.76l-.268.422-.038.5.186.013.168.012c.3.02.44.032.6.046 2.06-.026 3.95-.686 5.49-1.86l1.12-.85-1.4-.048c-1.57-.055-2.92-1.08-3.36-2.51l-.48.146-.05.5c.22.03.48.05.75.08.48-.02.87-.07 1.25-.15l2.33-.49-2.32-.49c-1.68-.35-2.91-1.83-2.91-3.55 0-.05 0-.01-.01.03l-.49-.1-.25.44c.63.36 1.35.57 2.07.58l1.7.04L7.4 13c-.978-.662-1.59-1.79-1.618-3.047a4.08 4.08 0 0 1 .524-1.8l-.825.07a12.188 12.188 0 0 0 8.81 4.515l.59.033-.06-.59v-.02c-.05-.43-.06-.63-.06-.87a3.617 3.617 0 0 1 6.27-2.45l.2.21.28-.06c1.01-.22 1.94-.59 2.73-1.09l-.75-.56c-.1.36-.04.89.12 1.36.23.68.58 1.13 1.17.85l-.21-.45-.42-.27c-.52.8-1.17 1.48-1.92 2L22 11l.016.28c.013.2.014.35 0 .52v.04zm.998.038c.018-.22.017-.417 0-.66l-.498.034.284.41a8.183 8.183 0 0 0 2.2-2.267l.97-1.48-1.6.755c.17-.08.3-.02.34.03a.914.914 0 0 1-.13-.292c-.1-.297-.13-.64-.1-.766l.36-1.254-1.1.695c-.69.438-1.51.764-2.41.963l.48.15a4.574 4.574 0 0 0-3.38-1.484 4.616 4.616 0 0 0-4.61 4.613c0 .29.02.51.08.984l.01.02.5-.06.03-.5c-3.17-.18-6.1-1.7-8.08-4.15l-.48-.56-.36.64c-.39.69-.62 1.48-.65 2.28.04 1.61.81 3.04 2.06 3.88l.3-.92c-.55-.02-1.11-.17-1.6-.45l-.59-.34-.14.67c-.02.08-.02.16 0 .24-.01 2.12 1.55 4.01 3.69 4.46l.1-.49-.1-.49c-.33.07-.67.12-1.03.14-.18-.02-.43-.05-.64-.07l-.76-.09.23.73c.57 1.84 2.29 3.14 4.28 3.21l-.28-.89a8.252 8.252 0 0 1-4.85 1.66c-.12-.01-.26-.02-.56-.05l-.17-.01-.18-.01L2.53 21l1.694 1.07a12.233 12.233 0 0 0 6.58 1.917c7.156 0 12.2-5.73 12.18-12.18l-.002.04z"/></svg></span></button></li><li class="u-textAlignCenter"><button class="button button--large button--dark button--chromeless is-touchIconBlackPulse u-baseColor--buttonDark button--withIcon button--withSvgIcon"  title="Share on Facebook" aria-label="Share on Facebook" data-action="share-on-facebook" data-action-source="post_share_widget"><span class="svgIcon svgIcon--facebook svgIcon--29px"><svg class="svgIcon-use" width="29" height="29" viewBox="0 0 29 29" ><path d="M16.39 23.61v-5.808h1.846a.55.55 0 0 0 .546-.48l.36-2.797a.551.551 0 0 0-.547-.62H16.39V12.67c0-.67.12-.813.828-.813h1.474a.55.55 0 0 0 .55-.55V8.803a.55.55 0 0 0-.477-.545c-.436-.06-1.36-.116-2.22-.116-2.5 0-4.13 1.62-4.13 4.248v1.513H10.56a.551.551 0 0 0-.55.55v2.797c0 .304.248.55.55.55h1.855v5.76c-4.172-.96-7.215-4.7-7.215-9.1 0-5.17 4.17-9.36 9.31-9.36 5.14 0 9.31 4.19 9.31 9.36 0 4.48-3.155 8.27-7.43 9.15M14.51 4C8.76 4 4.1 8.684 4.1 14.46c0 5.162 3.75 9.523 8.778 10.32a.55.55 0 0 0 .637-.543v-6.985a.551.551 0 0 0-.55-.55H11.11v-1.697h1.855a.55.55 0 0 0 .55-.55v-2.063c0-2.02 1.136-3.148 3.03-3.148.567 0 1.156.027 1.597.06v1.453h-.924c-1.363 0-1.93.675-1.93 1.912v1.78c0 .3.247.55.55.55h2.132l-.218 1.69H15.84c-.305 0-.55.24-.55.55v7.02c0 .33.293.59.623.54 5.135-.7 9.007-5.11 9.007-10.36C24.92 8.68 20.26 4 14.51 4"/></svg></span></button></li><li class="u-textAlignCenter"><button class="button button--large button--dark button--chromeless is-touchIconFadeInPulse u-baseColor--buttonDark button--withIcon button--withSvgIcon button--bookmark js-bookmarkButton"  title="Bookmark this story to read later" aria-label="Bookmark this story to read later" data-action="sign-in-prompt" data-sign-in-action="add-to-bookmarks" data-requires-token="true" data-redirect="https://medium.com/_/bookmark/p/d28a00e780a3"><span class="button-defaultState"><span class="svgIcon svgIcon--bookmark svgIcon--29px"><svg class="svgIcon-use" width="29" height="29" viewBox="0 0 29 29" ><path d="M19.385 4h-9.77A2.623 2.623 0 0 0 7 6.615V23.01a1.022 1.022 0 0 0 1.595.847l5.905-4.004 5.905 4.004A1.022 1.022 0 0 0 22 23.011V6.62A2.625 2.625 0 0 0 19.385 4zM21 23l-5.91-3.955-.148-.107a.751.751 0 0 0-.884 0l-.147.107L8 23V6.615C8 5.725 8.725 5 9.615 5h9.77C20.275 5 21 5.725 21 6.615V23z" fill-rule="evenodd"/></svg></span></span><span class="button-activeState"><span class="svgIcon svgIcon--bookmarkFilled svgIcon--29px"><svg class="svgIcon-use" width="29" height="29" viewBox="0 0 29 29" ><path d="M19.385 4h-9.77A2.623 2.623 0 0 0 7 6.615V23.01a1.022 1.022 0 0 0 1.595.847l5.905-4.004 5.905 4.004A1.022 1.022 0 0 0 22 23.011V6.62A2.625 2.625 0 0 0 19.385 4z" fill-rule="evenodd"/></svg></span></span></button></li></ul></div></div><div class="u-fixed u-bottom0 u-sizeFullWidth u-backgroundWhite u-boxShadowTop u-borderBox u-paddingTop10 u-paddingBottom10 u-zIndexMetabar u-xs-paddingLeft10 u-xs-paddingRight10 js-stickyFooter"><div class="u-maxWidth700 u-marginAuto u-flexCenter"><div class="u-fontSize16 u-flex1 u-flexCenter"><div class="u-flex0 u-inlineBlock u-paddingRight20 u-xs-paddingRight10"><a class="link avatar u-inline u-baseColor--link"  href="https://medium.com/@paularmstrong" data-action="show-user-card" data-action-value="b97642f6668f" data-action-type="hover" data-user-id="b97642f6668f" dir="auto"><img  src="https://cdn-images-1.medium.com/fit/c/40/40/1*dgq6_20nGwOd_-UZeUXbQA.jpeg" class="avatar-image avatar-image--smaller" alt="Go to the profile of Paul Armstrong"></a></div><div class="u-flex1 u-inlineBlock"><div class="u-xs-hide">Never miss a story from<strong> Paul Armstrong</strong>, when you sign up for Medium. <a class="link link--accent u-accentColor--textNormal u-accentColor--textDarken u-baseColor--link"  href="https://medium.com/@Medium/personalize-your-medium-experience-with-users-publications-tags-26a41ab1ee0c#.hx4zuv3mg" data-action-source="sticky_footer">Learn more</a></div><div class="u-xs-show">Never miss a story from<strong> Paul Armstrong</strong></div></div></div><div class="u-marginLeft50 u-xs-marginAuto"><span class="followState js-followState buttonSet-inner" data-user-id="b97642f6668f"><button class="button u-noUserSelect button--withChrome u-baseColor--buttonNormal button--withHover button--unblock js-unblockButton u-uiTextSemibold u-textUppercase u-fontSize12"  data-action="sign-in-prompt" data-sign-in-action="toggle-block-user" data-requires-token="true" data-action-source="sticky_footer"><span class="button-label  button-defaultState">Blocked</span><span class="button-label button-hoverState">Unblock</span></button><button class="button button--primary is-active u-noUserSelect button--withChrome u-accentColor--buttonNormal button--follow js-followButton u-uiTextSemibold u-textUppercase u-fontSize12"  data-action="sign-in-prompt" data-sign-in-action="toggle-subscribe-user" data-requires-token="true" data-redirect="https://medium.com/_/subscribe/user/b97642f6668f" data-action-source="sticky_footer_follow"><span class="button-label  button-defaultState js-buttonLabel">Follow</span><span class="button-label button-activeState">Get updates</span></button></span></div></div></div></div></div></div><div class="loadingBar"></div><script>// <![CDATA[
window["obvInit"] = function (opt_embedded) {window["obvInit"]["embedded"] = opt_embedded; window["obvInit"]["ready"] = true;}
// ]]></script><script>// <![CDATA[
var GLOBALS = {"audioUrl":"https://d1fcbxp97j4nb2.cloudfront.net","baseUrl":"https://medium.com","buildLabel":"28586-6143d83","currentUser":{"userId":"lo_35dda2a5c966","isVerified":false,"subscriberEmail":""},"currentUserHasUnverifiedEmail":false,"isAuthenticated":false,"isCurrentUserVerified":false,"mediumTwitterScreenName":"medium","miroUrl":"https://cdn-images-1.medium.com","moduleUrls":{"base":"https://cdn-static-1.medium.com/_/fp/gen-js/main-base.bundle.2nXtJ8XknWJqOjh2ZNHRVw.js","notes":"https://cdn-static-1.medium.com/_/fp/gen-js/main-notes.bundle.AouowiblLn4SBKZF6cWDtA.js","posters":"https://cdn-static-1.medium.com/_/fp/gen-js/main-posters.bundle.4rYp3nph7xNXmlmak5XWxQ.js","common-async":"https://cdn-static-1.medium.com/_/fp/gen-js/main-common-async.bundle.R35emyz9xZL7YdHbIl-SvQ.js","stats":"https://cdn-static-1.medium.com/_/fp/gen-js/main-stats.bundle.XUyD-cfC9DG2nc9iq5x7GA.js","home-screens":"https://cdn-static-1.medium.com/_/fp/gen-js/main-home-screens.bundle.0oM8iNH9LgWeJY00O_ao2Q.js","misc-screens":"https://cdn-static-1.medium.com/_/fp/gen-js/main-misc-screens.bundle.caQfKUCZ18Wg2IbFBoaXiA.js"},"previewConfig":{"weightThreshold":1,"weightImageParagraph":0.51,"weightIframeParagraph":0.8,"weightTextParagraph":0.08,"weightEmptyParagraph":0,"weightP":0.003,"weightH":0.005,"weightBq":0.003,"minPTextLength":60,"truncateBoundaryChars":20,"detectTitle":true,"detectTitleLevThreshold":0.15},"productName":"Medium","supportsEdit":false,"termsUrl":"//medium.com/policy/9db0094a1e0f","textshotHost":"textshot.medium.com","transactionId":"1492370939314:67da5198ad04","useragent":{"browser":"python requests","family":"","os":"","version":2.2,"supportsDesktopEdit":false,"supportsInteract":false,"supportsView":true,"isMobile":false,"isTablet":false,"isNative":false,"supportsFileAPI":false,"isTier1":false,"clientVersion":"","unknownParagraphsBad":false,"clientChannel":"","supportsRealScrollEvents":false,"supportsVhUnits":false,"ruinsViewportSections":false,"supportsHtml5Video":false,"supportsMagicUnderlines":false,"isWebView":false,"isFacebookWebView":false,"supportsProgressiveMedia":false,"supportsPromotedPosts":true,"isBot":false,"isNativeIphone":false,"supportsCssVariables":false,"supportsScrollableMetabar":false},"variants":{"allow_access":true,"allow_signup":true,"allow_test_auth":"disallow","signin_services":"twitter,facebook,google,email,google-fastidv","signup_services":"twitter,facebook,google,email,google-fastidv","android_rating_prompt_recommend_threshold":5,"google_sign_in_android":true,"enable_onboarding":true,"ios_custom_miro_url":"https://cdn-images-1.medium.com","reengagement_notification_duration":3,"enable_adsnative_integration":true,"browsable_stream_config_bucket":"curated-topics","ios_small_post_preview_truncation_length":5.5,"ios_large_post_preview_truncation_length":5.5,"disable_ios_catalog_badging":true,"enable_series_creation":true,"enable_your_series_pages":true,"enable_productionized_series":true,"enable_dedicated_series_tab_api_ios":true,"enable_clap_milestone_notifications":true,"enable_series_stats_page":true,"enable_prepublish_share_settings":true,"enable_direct_auth_connect":true,"enable_post_import":true,"enable_sponsored_post_labelling":true,"enable_logged_in_follow_on_collection_post":true,"promoted_story_placement_locations":"POST_PAGE_FOOTER","show_topics":true,"enable_search_collection_by_tag_recency_filter":true,"search_collection_by_tag_filter_min_votes":10,"enable_sms_app_promo":true,"enable_export_members":true,"enable_series_card_background_creation":true,"can_see_subscription_branding":true,"enable_subscriptions_landing_page":true,"enable_partner_program_landing_page":true,"enable_hide_broken_links":true,"enable_pay_for_custom_domain":true,"enable_promos_from_dynamo":true,"enable_promos_in_placement":true,"enable_series_promo_in_email":true,"enable_sms":true,"enable_series_in_user_profiles":true,"enable_new_logged_out_bento_operation":true,"enable_topic_brief_relations":true},"xsrfToken":"","iosAppId":"828256236","supportEmail":"yourfriends@medium.com","teamName":"Team Medium","fp":{"/icons/favicon.svg":"https://cdn-static-1.medium.com/_/fp/icons/favicon.KjTfUJo7yJH_fCoUzzH3cg.svg","/icons/favicon-dev-editor.ico":"https://cdn-static-1.medium.com/_/fp/icons/favicon-dev-editor.YKKRxBO8EMvIqhyCwIiJeQ.ico","/icons/favicon-hatch-editor.ico":"https://cdn-static-1.medium.com/_/fp/icons/favicon-hatch-editor.BuEyHIqlyh2s_XEk4Rl32Q.ico","/icons/favicon-medium-editor.ico":"https://cdn-static-1.medium.com/_/fp/icons/favicon-medium-editor.PiakrZWB7Yb80quUVQWM6g.ico"},"authBaseUrl":"https://medium.com","imageUploadSizeMb":25,"isAuthDomainRequest":true,"algoliaApiEndpoint":"https://MQ57UUUQZ2-dsn.algolia.net","algoliaAppId":"MQ57UUUQZ2","algoliaSearchOnlyApiKey":"394474ced050e3911ae2249ecc774921","iosAppStoreUrl":"https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8","iosAppLinkBaseUrl":"medium:","algoliaIndexPrefix":"medium_","androidPlayStoreUrl":"https://play.google.com/store/apps/details?id=com.medium.reader","googleClientId":"216296035834-k1k6qe060s2tp2a2jam4ljdcms00sttg.apps.googleusercontent.com","androidPackage":"com.medium.reader","androidPlayStoreMarketScheme":"market://details?id=com.medium.reader","googleAuthUri":"https://accounts.google.com/o/oauth2/auth","androidScheme":"medium","layoutData":{"useDynamicScripts":false,"googleAnalyticsTrackingCode":"UA-24232453-2","jsShivUrl":"https://cdn-static-1.medium.com/_/fp/js/shiv.RI2ePTZ5gFmMgLzG5bEVAA.js","useDynamicCss":false,"faviconUrl":"https://cdn-static-1.medium.com/_/fp/icons/favicon-medium.TAS6uQ-Y7kcKgi0xjcYHXw.ico","faviconImageId":"1*W0nmth_X8nFKjn6BZ388UQ.png","fontSets":[{"id":1,"url":"https://cdn-static-1.medium.com/_/fp/css/fonts-base.by5Oi_VbnwEIvhnWIsuUjA.css"},{"id":4,"url":"https://cdn-static-1.medium.com/_/fp/css/fonts-lazy-base.g08Jj5TZPAiuPWj5YNUsSg.css"},{"id":6,"url":"https://cdn-static-1.medium.com/_/fp/css/fonts-latin-base.141WxxXgxGxNcfeza73H7Q.css"},{"id":7,"url":"https://cdn-static-1.medium.com/_/fp/css/fonts-lazy-latin-base.jMU532QDmysQMOINr-cr2A.css"}],"editorFaviconUrl":"https://cdn-static-1.medium.com/_/fp/icons/favicon-medium-editor.PiakrZWB7Yb80quUVQWM6g.ico"},"authBaseUrlRev":"moc.muidem//:sptth","isDnt":false,"stripePublishableKey":"pk_live_7FReX44VnNIInZwrIIx6ghjl","archiveUploadSizeMb":100,"paymentData":{"currencies":{"1":{"label":"US Dollar","external":"usd"}},"countries":{"1":{"label":"United States of America","external":"US"}},"accountTypes":{"1":{"label":"Individual","external":"individual"},"2":{"label":"Company","external":"company"}}},"previewConfig2":{"weightThreshold":1,"weightImageParagraph":0.05,"raiseImage":true,"enforceHeaderHierarchy":true,"isImageInsetRight":true},"isAmp":false,"iosScheme":"medium","isSwBoot":false,"lightstep":{"accessToken":"ce5be895bef60919541332990ac9fef2","carrier":"{\"ot-tracer-spanid\":\"1eabf55a05b7d096\",\"ot-tracer-traceid\":\"62d0eb534c34fdd4\",\"ot-tracer-sampled\":\"true\"}","host":"collector-medium.lightstep.com"},"facebook":{"key":"542599432471018","secret":"c14df7146e9052a1131f3c900c1f0644","token":"542599432471018|1JqjIwxSfY9jOt_KwjWEl1R7T6I","namespace":"medium-com","scope":{"default":["public_profile","email","user_friends"],"connect":["public_profile","email","user_friends"],"login":["public_profile","email","user_friends"],"share":["public_profile","email","user_friends","publish_actions"]},"smartPublishWhitelistedPublications":["bcc38c8f6edf","f3726e2a5878","828a270689e","81c7d351c056","f30e42fd7ff8","8bf1d7d3081b","d16afa0ae7c","d8f3f6ad9c31","e74de0cedea9","15f753907972","c8c6a6b01ebd","3412b9729488","2ce4bbcf83bb","544c7006046e","7bfcdbc6b30a","a268fd916824","458a773bccd2"],"instantArticles":{"published":true,"developmentMode":false}},"mailingListArchiveUploadSizeMb":2,"availableMembershipPlans":[],"editorsPicksTopicId":"3985d2a191c5","popularOnMediumTopicId":"9d34e48ecf94","memberContentTopicId":"13d7efd82fb2","isDoNotAuth":false,"goldfinchUrl":"https://goldfinch.medium.com"}
// ]]></script><script charset="UTF-8" src="https://cdn-static-1.medium.com/_/fp/gen-js/main-base.bundle.2nXtJ8XknWJqOjh2ZNHRVw.js" async></script><script>// <![CDATA[
window["obvInit"]({"value":{"id":"d28a00e780a3","versionId":"9d8ebfe6f28c","creatorId":"b97642f6668f","creator":{"userId":"b97642f6668f","name":"Paul Armstrong","username":"paularmstrong","createdAt":1356715290527,"lastPostCreatedAt":1492208310971,"imageId":"1*dgq6_20nGwOd_-UZeUXbQA.jpeg","backgroundImageId":"","bio":"Writing React.js on @Twitter Lite.","twitterScreenName":"paularmstrong","socialStats":{"userId":"b97642f6668f","usersFollowedCount":57,"usersFollowedByCount":795,"type":"SocialStats"},"social":{"userId":"lo_ca790359e5ee","targetUserId":"b97642f6668f","type":"Social"},"facebookAccountId":"","allowNotes":1,"type":"User"},"homeCollectionId":"","title":"Twitter Lite and High Performance React Progressive Web Apps at Scale","detectedLanguage":"en","latestVersion":"9d8ebfe6f28c","latestPublishedVersion":"9d8ebfe6f28c","hasUnpublishedEdits":false,"latestRev":847,"createdAt":1491518153985,"updatedAt":1492100739383,"acceptedAt":0,"firstPublishedAt":1491923469313,"latestPublishedAt":1492100739383,"vote":false,"experimentalCss":"","displayAuthor":"","content":{"subtitle":"A look into removing common and uncommon performance bottlenecks in one of the worlds largest React.js PWAs, Twitter Lite.","bodyModel":{"paragraphs":[{"name":"19d3","type":3,"text":"Twitter Lite and High Performance React Progressive Web Apps at Scale","markups":[]},{"name":"5ca1","type":6,"text":"A look into removing common and uncommon performance bottlenecks in one of the worlds largest React.js PWAs, Twitter Lite.","markups":[{"type":3,"start":109,"end":121,"href":"https://mobile.twitter.com","title":"","rel":"noopener","anchorType":0}]},{"name":"1b1f","type":1,"text":"Creating a fast web application involves many cycles of measuring where time is wasted, understanding why it’s happening, and applying potential solutions. Unfortunately, there’s never just one quick fix. Performance is a continuous game of watching and measuring for areas to improve. With Twitter Lite, we made small improvements across many areas: from initial load times, to React component rendering (and prevention re-rendering), to image loading, and much more. Most changes tend to be small, but they add up, and the end result is that we have one of the largest and fastest progressive web applications.","markups":[{"type":3,"start":583,"end":611,"href":"https://developers.google.com/web/progressive-web-apps/","title":"","rel":"","anchorType":0},{"type":2,"start":583,"end":611}]},{"name":"ed62","type":4,"text":"","markups":[],"layout":3,"metadata":{"id":"1*6f1XFtCP9Ki04onTv-QEHw.png","originalWidth":5114,"originalHeight":1314,"isFeatured":true,"focusPercentX":24,"focusPercentY":53}},{"name":"d19a","type":13,"text":"Before Reading On:","markups":[]},{"name":"54b6","type":1,"text":"If you’re just starting to measure and work toward increasing the performance of your web application, I highly recommend learning how to read flame graphs, if you don’t know how already.","markups":[{"type":3,"start":122,"end":155,"href":"http://www.brendangregg.com/flamegraphs.html","title":"","rel":"","anchorType":0}]},{"name":"3cc3","type":1,"text":"Each section below includes example screenshots of timeline recordings from Chrome’s Developer Tools. To make things more clear, I’ve highlighted each pair of examples with what’s bad (left image) versus what’s good (right image).","markups":[]},{"name":"9749","type":1,"text":"Special note regarding timelines and flame graphs: Since we target a very large range of mobile devices, we typically record these in a simulated environment: 5x slower CPU and 3G network connection. This is not only more realistic, but makes problems much more apparent. These may also be further skewed if we’re using React v15.4.0’s component profiling. Actual values on desktop performance timelines will tend to be much faster than what’s illustrated here.","markups":[{"type":3,"start":320,"end":355,"href":"https://facebook.github.io/react/blog/2016/11/16/react-v15.4.0.html#profiling-components-with-chrome-timeline","title":"","rel":"noopener","anchorType":0},{"type":2,"start":0,"end":461}]},{"name":"0c70","type":3,"text":"Optimizing for the Browser","markups":[]},{"name":"2811","type":13,"text":"Use Route-Based Code Splitting","markups":[]},{"name":"e026","type":1,"text":"Webpack is powerful but difficult to learn. For some time, we had issues with the CommonsChunkPlugin and the way it worked with some of our circular code dependencies. Because of that, we ended up with only 3 JavaScript asset files, totaling over 1MB in size (420KB gzip transfer size).","markups":[{"type":3,"start":82,"end":100,"href":"https://webpack.js.org/plugins/commons-chunk-plugin/","title":"","rel":"noopener","anchorType":0}]},{"name":"143b","type":1,"text":"Loading a single, or even just a few very large JavaScript files in order to run a site is a huge bottleneck for mobile users to see and interact with a website. Not only does the amount of time it takes for your scripts to transfer over a network increase with their size, but the time it takes for the browser to parse increases as well.","markups":[]},{"name":"6aed","type":1,"text":"After much wrangling, we were finally able to break up common areas by routes into separate chunks (example below). The day finally came when this code review dropped into our inboxes:","markups":[]},{"name":"6030","type":11,"text":"","markups":[],"layout":1,"iframe":{"mediaResourceId":"9d7ab92337ff626422046a847288418d","thumbnailUrl":"https://i.embed.ly/1/image?url=https%3A%2F%2Favatars2.githubusercontent.com%2Fu%2F33297%3Fv%3D3%26s%3D400&key=4fce0568f2ce49e8b54624ef71a8a5bd"}},{"name":"4995","type":6,"text":"Adds granular, route-based code-splitting. Faster initial and HomeTimeline render is traded for greater overall app size, which is spread over 40 on-demand chunks and amortized over the length of the session. — Nicolas Gallagher","markups":[{"type":3,"start":211,"end":228,"anchorType":2,"userId":"852b96450d4c"}]},{"name":"c0bb","type":4,"text":"","markups":[],"layout":6,"metadata":{"id":"1*tFwdkkLP_ta2vYklWzezOg.png","originalWidth":2784,"originalHeight":1642}},{"name":"31ea","type":4,"text":"Timelines from before (left) and after (right) code splitting. Click or tap to zoom.","markups":[],"layout":7,"metadata":{"id":"1*qHvcFPwD-rAVgSmE6LUzFQ.png","originalWidth":2784,"originalHeight":1642}},{"name":"f9bd","type":1,"text":"Our original setup (above left) took over 5 seconds to load our main bundle, while after splitting out code by routes and common chunks (above right), it takes barely 3 seconds (on a simulated 3G network).","markups":[]},{"name":"a013","type":1,"text":"This was done early on in our performance focus sprints, but this single change made a huge difference when running Google’s Lighthouse web application auditing tool:","markups":[{"type":3,"start":125,"end":135,"href":"https://developers.google.com/web/tools/lighthouse/","title":"","rel":"noopener","anchorType":0}]},{"name":"d331","type":4,"text":"We also ran the site before (left) and after (right) through Google’s “Lighthouse” web application auditing tool.","markups":[],"layout":3,"metadata":{"id":"1*9S6T2vjlp0cC52CTKQIM9w.png","originalWidth":2900,"originalHeight":700}},{"name":"3bf2","type":13,"text":"Avoid Functions that Cause Jank","markups":[]},{"name":"80b7","type":1,"text":"Over many iterations of our infinite scrolling timelines, we used different ways to calculate your scroll position and direction to determine if we needed to ask the API for more Tweets to display. Up until recently, we were using react-waypoint, which worked well for us. However, in chasing the best possible performance for one of the main underlying components of our application, it just wasn’t fast enough.","markups":[{"type":3,"start":28,"end":56,"href":"http://itsze.ro/blog/2017/04/09/infinite-list-and-react.html","title":"","rel":"","anchorType":0},{"type":3,"start":231,"end":245,"href":"https://github.com/brigade/react-waypoint","title":"","rel":"noopener","anchorType":0}]},{"name":"e114","type":1,"text":"Waypoints work by calculating many different heights, widths, and positions of elements in order to determine your current scroll position, how far from each end you are, and which direction you’re going. All of this information is useful, but since it’s done on every scroll event it comes at a cost: making those calculations causes jank–and lots of it.","markups":[]},{"name":"2531","type":1,"text":"But first, we have to understand what the developer tools mean when they tell us that there is “jank”.","markups":[]},{"name":"cbfd","type":7,"text":"Most devices today refresh their screens 60 times a second. If there’s an animation or transition running, or the user is scrolling the pages, the browser needs to match the device’s refresh rate and put up 1 new picture, or frame, for each of those screen refreshes.","markups":[]},{"name":"1fe5","type":7,"text":"Each of those frames has a budget of just over 16ms (1 second / 60 = 16.66ms). In reality, however, the browser has housekeeping work to do, so all of your work needs to be completed inside 10ms. When you fail to meet this budget the frame rate drops, and the content judders on screen. This is often referred to as jank, and it negatively impacts the user’s experience. — Paul Lewis on Rendering Performance","markups":[{"type":3,"start":373,"end":408,"href":"https://developers.google.com/web/fundamentals/performance/rendering/","title":"","rel":"","anchorType":0}]},{"name":"3ce6","type":1,"text":"Over time, we developed a new infinite scrolling component called VirtualScroller. With this new component, we know exactly what slice of Tweets are being rendered into a timeline at any given time, avoiding the need to make expensive calculations as to where we are visually.","markups":[{"type":2,"start":66,"end":81}]},{"name":"ef1d","type":4,"text":"","markups":[],"layout":6,"metadata":{"id":"1*RwUKe8QRCKciqkOzlAv6uw.png","originalWidth":2784,"originalHeight":1642}},{"name":"6bf9","type":4,"text":"It may not look like much, but before (left) while scrolling, we would cause render jank by trying to calculate the height of various elements. After (right) we cause no jank and reduce the stuttering while scrolling timelines at fast speeds. Click or tap to zoom.","markups":[],"layout":7,"metadata":{"id":"1*w_f0IMKu1DdJ36QvzX05Ug.png","originalWidth":2784,"originalHeight":1642}},{"name":"a679","type":1,"text":"By avoiding function calls that cause extra jank, scrolling a timeline of Tweets looks and feels more seamless, giving us a much more rich, almost native experience. While it can always be better, this change makes a noticeable improvement to the smoothness of scrolling timelines. It was a good reminder that every little bit counts when looking at performance.","markups":[]},{"name":"0153","type":13,"text":"Use Smaller Images","markups":[]},{"name":"a4a4","type":1,"text":"We first started pushing to use less bandwidth on Twitter Lite by working with multiple teams to get new and smaller sizes of images available from our CDNs. It turns out, that by reducing the size of the images we were rendering to be only what we absolutely needed (both in terms of dimensions and quality), we found that not only did we reduce bandwidth usage, but that we were also able to increase performance in the browser, especially while scrolling through image-heavy timelines of Tweets.","markups":[{"type":3,"start":152,"end":156,"href":"https://en.wikipedia.org/wiki/Content_delivery_network","title":"","rel":"","anchorType":0}]},{"name":"9b95","type":1,"text":"In order to determine how much better smaller images are for performance, we can look at the Raster timeline in Chrome Developer Tools. Before we reduced the size of images, it could take 300ms or more just to decode a single image, as shown in the timeline recording below on the left. This is the processing time after an image has been downloaded, but before it can be displayed on the page.","markups":[{"type":2,"start":93,"end":100}]},{"name":"466c","type":1,"text":"When you’re scrolling a page and aiming for the 60 frame-per-second rendering standard, we want to keep as much processing as possible under 16.667ms (1 frame). It’s taking us nearly 18 frames just to get a single image rendered into the viewport, which is too many. One other thing to note in the timeline: you can see that the Main timeline is mostly blocked from continuing until this image has finished decoding (as shown by the whitespace). This means we’ve got quite a performance bottleneck here!","markups":[{"type":2,"start":329,"end":333}]},{"name":"c1f3","type":4,"text":"","markups":[],"layout":6,"metadata":{"id":"1*Yp2fdW-mravcdr2h-RfXbg.png","originalWidth":2784,"originalHeight":1642}},{"name":"7dbc","type":4,"text":"Large images (left) can block the main thread from continuing for 18 frames. Small images (right) take only about 1 frame. Click or tap to zoom.","markups":[],"layout":7,"metadata":{"id":"1*yLud5u9CJbM16lqaTYlmXg.png","originalWidth":2784,"originalHeight":1642}},{"name":"de28","type":1,"text":"Now, after we’ve reduced the size of our images (above, right), we’re looking at just over a single frame to decode our largest images.","markups":[]},{"name":"1d10","type":3,"text":"Optimizing React","markups":[]},{"name":"0947","type":13,"text":"Make use of the shouldComponentUpdate method","markups":[{"type":10,"start":16,"end":44}]},{"name":"50dd","type":1,"text":"A common tip for optimizing the performance of React applications is to use the shouldComponentUpdate method. We try to do this wherever possible, but sometimes things slip through the cracks.","markups":[{"type":10,"start":80,"end":101},{"type":3,"start":72,"end":108,"href":"https://facebook.github.io/react/docs/optimizing-performance.html#shouldcomponentupdate-in-action","title":"","rel":"noopener","anchorType":0}]},{"name":"6fef","type":4,"text":"Liking the first Tweet caused both it and the entire Conversation below it to re-render!","markups":[],"layout":4,"metadata":{"id":"1*0u20AaM3kAsB1siq54y27w.gif","originalWidth":251,"originalHeight":515}},{"name":"408d","type":1,"text":"Here’s an example of a component that was always updating: When clicking the heart icon to like a Tweet in the home timeline, any Conversation component on screen would also re-render. In the animated example, you should see green boxes highlighting where the browser has to re-paint because we’re making the entire Conversation component below the Tweet we’re acting on update.","markups":[{"type":10,"start":130,"end":142},{"type":10,"start":316,"end":328}]},{"name":"e66f","type":1,"text":"Below, you’ll see two flame graphs of this action. Without shouldComponentUpdate (left), we can see its entire tree updated and re-rendered, just to change the color of a heart somewhere else on the screen. After adding shouldComponentUpdate (right), we prevent the entire tree from updating and prevent wasting more than one-tenth of a second running unnecessary processing.","markups":[{"type":10,"start":59,"end":80},{"type":10,"start":220,"end":241}]},{"name":"f819","type":4,"text":"","markups":[],"layout":6,"metadata":{"id":"1*eJrp7PsLeYw8x-QvTPHBeQ.png","originalWidth":2784,"originalHeight":1642}},{"name":"640e","type":4,"text":"Before (left), when liking an unrelated Tweet, entire Conversations would update and re-render. After adding shouldComponentUpdate logic (right), you can see that the component and its children are prevented from wasting CPU cycles. Click or tap to zoom.","markups":[],"layout":7,"metadata":{"id":"1*j5wG547DfE5-mudV5-m51w.png","originalWidth":2784,"originalHeight":1642}},{"name":"206a","type":13,"text":"Defer Unnecessary Work until componentDidMount","markups":[]},{"name":"8e52","type":1,"text":"This change may seem like a bit of a no-brainer, but it’s easy to forget about the little things when developing a large application like Twitter Lite.","markups":[]},{"name":"704f","type":1,"text":"We found that we had a lot of places in our code where we were doing expensive calculations for the sake of analytics during the componentWillMount React lifecycle method. Every time we did this, we blocked rendering of components a little more. 20ms here, 90ms there, it all adds up quickly. Originally, we were trying to record which tweets were being rendered to our data analytics service in componentWillMount, before they were actually rendered (timeline below, left).","markups":[{"type":10,"start":129,"end":147},{"type":10,"start":396,"end":414},{"type":3,"start":129,"end":170,"href":"https://facebook.github.io/react/docs/react-component.html#componentwillmount","title":"","rel":"noopener","anchorType":0}]},{"name":"f4f1","type":4,"text":"","markups":[],"layout":6,"metadata":{"id":"1*-APq7-hYWlb4eYkEgV08JQ.png","originalWidth":2784,"originalHeight":1642}},{"name":"43c0","type":4,"text":"By deferring non-essential code paths from `componentWillMount` to `componentDidMount`, we saved a lot of time to render Tweets to the screen. Click or tap to zoom.","markups":[],"layout":7,"metadata":{"id":"1*OqyFUe7PPLjRFK7FV6mDtg.png","originalWidth":2784,"originalHeight":1642}},{"name":"5dc5","type":1,"text":"By moving that calculation and network call to the React component’s componentDidMount method, we unblocked the main thread and reduced unwanted jank when rendering our components (above right).","markups":[{"type":10,"start":69,"end":86}]},{"name":"3732","type":13,"text":"Avoid dangerouslySetInnerHTML","markups":[]},{"name":"f012","type":1,"text":"In Twitter Lite, we use SVG icons, as they’re the most portable and scalable option available to us. Unfortunately, in older versions of React, most SVG attributes were not supported when creating elements from components. So, when we first started writing the application, we were forced to use dangerouslySetInnerHTML in order to use SVG icons as React components.","markups":[{"type":10,"start":296,"end":319}]},{"name":"9398","type":1,"text":"For example, our original HeartIcon looked something like this:","markups":[]},{"name":"cf27","type":11,"text":"","markups":[],"layout":1,"iframe":{"mediaResourceId":"6e5d6a62effee7cb26d71bbb4d0f7912","thumbnailUrl":"https://i.embed.ly/1/image?url=https%3A%2F%2Favatars2.githubusercontent.com%2Fu%2F33297%3Fv%3D3%26s%3D400&key=4fce0568f2ce49e8b54624ef71a8a5bd"}},{"name":"6861","type":1,"text":"Not only is it discouraged to use dangerouslySetInnerHTML, but it turns out that it’s actually a source of slowness when mounting and rendering.","markups":[{"type":10,"start":34,"end":57},{"type":3,"start":15,"end":57,"href":"http://reactjs.cn/react/tips/dangerously-set-inner-html.html","title":"","rel":"noopener","anchorType":0}]},{"name":"9318","type":4,"text":"","markups":[],"layout":6,"metadata":{"id":"1*Vn4m-lma6mkRJ4SbR2HQgg.png","originalWidth":2784,"originalHeight":1642}},{"name":"f30e","type":4,"text":"Before (left), you’ll see it takes roughly 20ms to mount 4 SVG icons, while after (right) it takes around 8. Click or tap to zoom.","markups":[],"layout":7,"metadata":{"id":"1*gsvIv0YPsDaE0PRFa9G2oA.png","originalWidth":2784,"originalHeight":1642}},{"name":"cff9","type":1,"text":"Analyzing the flame graphs above, our original code (left) shows that it takes about 20ms on a slow device to mount the actions at the bottom of a Tweet containing four SVG icons. While this may not seem like much on its own, knowing that we need to render many of these at once, all while scrolling a timeline of infinite Tweets, we realized that this is a huge waste of time.","markups":[]},{"name":"624a","type":1,"text":"Since React v15 added support for most SVG attributes, we went ahead and looked to see what would happen if we avoided dangerouslySetInnerHTML. Checking the patched flame graph (above right), we get about an average of 60% savings each time we need to mount and render one of these sets of icons!","markups":[{"type":10,"start":119,"end":142},{"type":1,"start":219,"end":230}]},{"name":"3eba","type":1,"text":"Now, our SVG icons are simple stateless components, don’t use “dangerous” functions, and mount an average of 60% faster. They look like this:","markups":[{"type":2,"start":63,"end":73}]},{"name":"b0ae","type":11,"text":"","markups":[],"layout":1,"iframe":{"mediaResourceId":"def554b848095d8a129f38a6f36e3000","thumbnailUrl":"https://i.embed.ly/1/image?url=https%3A%2F%2Favatars2.githubusercontent.com%2Fu%2F33297%3Fv%3D3%26s%3D400&key=4fce0568f2ce49e8b54624ef71a8a5bd"}},{"name":"b1f2","type":13,"text":"Defer Rendering When Mounting & Unmounting Many Components","markups":[]},{"name":"0c3b","type":1,"text":"On slower devices, we noticed that it could take a long time for our main navigation bar to appear to respond to taps, often leading us to tap multiple times, thinking that perhaps the first tap didn’t register.","markups":[]},{"name":"66be","type":1,"text":"Notice in the image below how the Home icon takes nearly 2 seconds to update and show that it was tapped:","markups":[]},{"name":"efec","type":4,"text":"Without deferring rendering, the navigation bar takes time to respond.","markups":[],"layout":3,"metadata":{"id":"1*mDPjaeBNhCAbEcbKV-IX3Q.gif","originalWidth":252,"originalHeight":515}},{"name":"3874","type":1,"text":"No, that wasn’t just the GIF running a slow frame rate. It actually was that slow. But, all of the data for the Home screen was already loaded, so why is it taking so long to show anything?","markups":[]},{"name":"1f10","type":1,"text":"It turns out that mounting and unmounting large trees of components (like timelines of Tweets) is very expensive in React.","markups":[]},{"name":"9089","type":1,"text":"At the very least, we wanted to remove the perception of the navigation bar not reacting to user input. For that, we created a small higher-order-component:","markups":[]},{"name":"8644","type":11,"text":"Our HigherOrderComponent, as written by Katie Sievert.","markups":[{"type":3,"start":40,"end":53,"href":"https://mobile.twitter.com/katiesievert","title":"","rel":"noopener","anchorType":0}],"layout":1,"iframe":{"mediaResourceId":"62cd780f6ca315521a65d129ba66a4da","thumbnailUrl":"https://i.embed.ly/1/image?url=https%3A%2F%2Favatars2.githubusercontent.com%2Fu%2F33297%3Fv%3D3%26s%3D400&key=4fce0568f2ce49e8b54624ef71a8a5bd"}},{"name":"96df","type":1,"text":"Once applied to our HomeTimeline, we saw near-instant responses of the navigation bar, leading to a perceived improvement overall.","markups":[{"type":2,"start":100,"end":109}]},{"name":"717d","type":8,"text":"const DeferredTimeline = deferComponentRender(HomeTimeline);\nrender(\x3cDeferredTimeline /\x3e);","markups":[]},{"name":"81f3","type":4,"text":"After deferring rendering, the navigation bar responds instantly.","markups":[],"layout":1,"metadata":{"id":"1*xmnXK7YFnPgxlosY7_aZ8w.gif","originalWidth":252,"originalHeight":515}},{"name":"46e1","type":3,"text":"Optimizing Redux","markups":[]},{"name":"29e1","type":13,"text":"Avoid Storing State Too Often","markups":[]},{"name":"2c9b","type":1,"text":"While controlled components seem to be the recommended approach, making inputs controlled means that they have to update and re-render for every keypress.","markups":[{"type":3,"start":6,"end":27,"href":"https://facebook.github.io/react/docs/forms.html#controlled-components","title":"","rel":"noopener","anchorType":0}]},{"name":"87c5","type":1,"text":"While this is not very taxing on a 3GHz desktop computer, a small mobile device with very limited CPU will notice significant lag while typing–especially when deleting many characters from the input.","markups":[]},{"name":"a5a4","type":1,"text":"In order to persist the value of composing Tweets, as well as calculating the number of characters remaining, we were using a controlled component and also passing the current value of the input to our Redux state at each keypress.","markups":[{"type":2,"start":151,"end":156}]},{"name":"00b0","type":1,"text":"Below (left), on a typical Android 5 device, every keypress leading to a change could cause nearly 200ms of overhead. Compound this by a fast typist, and we ended up in a really bad state, with users often reporting that their character insertion point was moving all over the place, resulting in jumbled sentences.","markups":[]},{"name":"2cdd","type":4,"text":"","markups":[],"layout":6,"metadata":{"id":"1*tClsk9W3EZCdAvv-fdD-tQ.png","originalWidth":2784,"originalHeight":1642}},{"name":"987c","type":4,"text":"Comparisons of the amount of time it takes to update after each keypress while dispatching the change to Redux and when not. Click or tap to zoom.","markups":[],"layout":7,"metadata":{"id":"1*pLqxpsHk7H0dIqqxzAbxlA.png","originalWidth":2784,"originalHeight":1642}},{"name":"c295","type":1,"text":"By removing the draft Tweet state from updating the main Redux state on every keypress and keeping things local in the React component’s state, we were able to reduce the overhead by over 50% (above, right).","markups":[]},{"name":"e674","type":13,"text":"Batch Actions into a Single Dispatch","markups":[]},{"name":"d5fc","type":1,"text":"In Twitter Lite, we’re using redux with react-redux to subscribe our components to data state changes. We’ve optimized our data into separate areas of a larger store with Normalizr and combineReducers. This all works wonderfully to prevent duplication of data and keep our stores small. However, each time we get new data, we have to dispatch multiple actions in order to add it to the appropriate stores.","markups":[{"type":3,"start":29,"end":34,"href":"http://redux.js.org/","title":"","rel":"noopener","anchorType":0},{"type":3,"start":40,"end":51,"href":"http://redux.js.org/docs/basics/UsageWithReact.html","title":"","rel":"noopener","anchorType":0},{"type":3,"start":171,"end":180,"href":"https://github.com/paularmstrong/normalizr","title":"","rel":"noopener","anchorType":0},{"type":3,"start":185,"end":200,"href":"http://redux.js.org/docs/api/combineReducers.html","title":"","rel":"noopener","anchorType":0}]},{"name":"0136","type":1,"text":"With the way that react-redux works, this means that every action dispatched will cause our connected components (called Containers) to recalculate changes and possibly re-render.","markups":[]},{"name":"4cf6","type":1,"text":"While we use a custom middleware, there are other batch middleware available. Choose the one that’s right for you, or write your own.","markups":[{"type":3,"start":44,"end":49,"href":"https://www.npmjs.com/package/redux-batched-actions","title":"","rel":"noopener","anchorType":0},{"type":3,"start":50,"end":55,"href":"https://www.npmjs.com/package/redux-batch-middleware","title":"","rel":"noopener","anchorType":0},{"type":3,"start":56,"end":66,"href":"https://www.npmjs.com/package/redux-batch-enhancer","title":"","rel":"noopener","anchorType":0},{"type":3,"start":67,"end":76,"href":"https://www.npmjs.com/package/redux-batch-actions","title":"","rel":"noopener","anchorType":0}]},{"name":"861f","type":1,"text":"The best way to illustrate the benefits of batching actions is by using the Chrome React Perf Extension. After the initial load, we pre-cache and calculate unread DMs in the background. When that happens we add a lot of various entities (conversations, users, message entries, etc). Without batching (below left), you can see that we end up with double the number of times we render each component (~16) versus with batching (~8) (below right).","markups":[{"type":3,"start":76,"end":103,"href":"https://github.com/crysislinux/chrome-react-perf","title":"","rel":"noopener","anchorType":0},{"type":2,"start":283,"end":299},{"type":2,"start":411,"end":424}]},{"name":"b650","type":4,"text":"","markups":[],"layout":6,"metadata":{"id":"1*o745G2ux9ZMLx3-rVWECBQ.png","originalWidth":2784,"originalHeight":3060}},{"name":"ffb5","type":4,"text":"A comparison using the React Perf extension for Chrome without batch-dispatch in Redux (left) vs with batch-dispatch (right). Click or tap to zoom.","markups":[],"layout":7,"metadata":{"id":"1*XBFV8VKRE16bSrBixvBc7g.png","originalWidth":2784,"originalHeight":3060}},{"name":"dd75","type":3,"text":"Service Workers","markups":[]},{"name":"12f2","type":1,"text":"While Service Workers aren’t available in all browsers yet, they’re an invaluable part of Twitter Lite. When available, we use ours for push notifications, to pre-cache application assets, and more. Unfortunately, being a fairly new technology, there’s still a lot to learn around performance.","markups":[]},{"name":"8255","type":13,"text":"Pre-Cache Assets","markups":[]},{"name":"d6e3","type":1,"text":"Like most products, Twitter Lite is by no means done. We’re still actively developing it, adding features, fixing bugs, and making it faster. This means we frequently need to deploy new versions of our JavaScript assets.","markups":[]},{"name":"88bf","type":1,"text":"Unfortunately, this can be a burden when users come back to the application and need to re-download a bunch of script files just to view a single Tweet.","markups":[]},{"name":"e496","type":1,"text":"In ServiceWorker-enabled browsers, we get the benefit of being able to have the worker automatically update, download, and cache any changed files in the background, on its own, before you come back.","markups":[]},{"name":"c11e","type":1,"text":"So what does this mean for the user? Near instant subsequent application loads, even after we’ve deployed a new version!","markups":[]},{"name":"9f11","type":4,"text":"","markups":[],"layout":6,"metadata":{"id":"1*nHge71VwyFkxbgDUOROeqQ.png","originalWidth":2784,"originalHeight":1642}},{"name":"4eca","type":4,"text":"Network asset load times without ServiceWorker pre-caching (left) vs with pre-caching (right). Click or tap to zoom.","markups":[],"layout":7,"metadata":{"id":"1*r51dWgMIwA8-jFKno0_RcQ.png","originalWidth":2784,"originalHeight":1642}},{"name":"8647","type":1,"text":"As illustrated above (left) without ServiceWorker pre-caching, every asset for the current view is forced to load from the network when returning to the application. It takes about 6 seconds on a good 3G network to finish loading. However, when the assets are pre-cached by the ServiceWorker (above right), the same 3G network takes less than 1.5 seconds before the page is finished loading. A 75% improvement!","markups":[]},{"name":"c8cf","type":13,"text":"Delay ServiceWorker Registration","markups":[]},{"name":"ace2","type":1,"text":"In many applications, it’s safe to register a ServiceWorker immediately on page load:","markups":[]},{"name":"3fa0","type":8,"text":"\x3cscript\x3e\nwindow.navigator.serviceWorker.register('/sw.js');\n\x3c/script\x3e","markups":[{"type":10,"start":0,"end":69}]},{"name":"a032","type":1,"text":"While we try to send as much data to the browser as possible to render a complete-looking page, in Twitter Lite this isn’t always possible. We may not have sent enough data, or the page you’re landing on may not support data pre-filled from the server. Because of this and various other limitations, we need to make some API requests immediately after the initial page load.","markups":[]},{"name":"498f","type":1,"text":"Normally, this isn’t a problem. However, if the browser hasn’t installed the current version of our ServiceWorker yet, we need to tell it to install–and with that comes about 50 requests to pre-cache various JS, CSS, and image assets.","markups":[]},{"name":"3225","type":1,"text":"When we were using the simple approach of registering our ServiceWorker immediately, we could see the network contention happening within the browser, maxing out our parallel request limit (below left).","markups":[]},{"name":"4e57","type":4,"text":"","markups":[],"layout":6,"metadata":{"id":"1*jLT8J20RRfKY_oxcsAiswQ.png","originalWidth":2784,"originalHeight":2052}},{"name":"e947","type":4,"text":"Notice how when registering your service worker immediately, it can block all other network requests (left). Deferring the service worker (right) allows your initial page load to make required network requests without getting blocked by the concurrent connection limit of the browser. Click or tap to zoom.","markups":[],"layout":7,"metadata":{"id":"1*poli81EjMdim8__g1HMioQ.png","originalWidth":2784,"originalHeight":2050}},{"name":"fe69","type":1,"text":"By delaying the ServiceWorker registration until we’ve finished loading extra API requests, CSS and image assets, we allow the page to finish rendering and be responsive, as illustrated in the after screenshot (above right).","markups":[]},{"name":"f30f","type":1,"text":"Overall, this is a list of just some of the many improvements that we’ve made over time to Twitter Lite. There are certainly more to come and we hope to continue sharing the problems we find and the ways that we work to overcome them. For more about what’s going on in real-time and more React & PWA insights, follow me and the team on Twitter.","markups":[{"type":3,"start":91,"end":103,"href":"https://mobile.twitter.com","title":"","rel":"","anchorType":0},{"type":3,"start":317,"end":319,"href":"https://mobile.twitter.com/paularmstrong","title":"","rel":"","anchorType":0},{"type":3,"start":324,"end":332,"href":"https://mobile.twitter.com/paularmstrong/lists/twitter-lite/members","title":"","rel":"","anchorType":0}]}],"sections":[{"name":"be28","startIndex":0},{"name":"db97","startIndex":8},{"name":"a8a1","startIndex":20},{"name":"f146","startIndex":30},{"name":"e3dc","startIndex":37},{"name":"7a64","startIndex":45},{"name":"ad70","startIndex":51},{"name":"631c","startIndex":62},{"name":"c40b","startIndex":73},{"name":"c81e","startIndex":82},{"name":"b527","startIndex":89},{"name":"3c99","startIndex":99},{"name":"819c","startIndex":108}]},"postDisplay":{"coverless":true}},"virtuals":{"allowNotes":true,"previewImage":{"imageId":"1*6f1XFtCP9Ki04onTv-QEHw.png","filter":"","backgroundSize":"","originalWidth":5114,"originalHeight":1314,"strategy":"resample","height":0,"width":0,"focusPercentX":24,"focusPercentY":53},"wordCount":2776,"imageCount":25,"readingTime":12.475471698113207,"subtitle":"A look into removing common and uncommon performance bottlenecks in one of the worlds largest React.js PWAs, Twitter Lite.","usersBySocialRecommends":[],"recommends":1021,"socialRecommends":[],"isBookmarked":false,"tags":[{"slug":"javascript","name":"JavaScript","postCount":29556,"virtuals":{"isFollowing":false},"metadata":{"followerCount":32185,"postCount":29556,"coverImage":{"id":"1*mR7_k1mHMlsfc01qz-ZPiQ.png","originalWidth":8844,"originalHeight":4235}},"type":"Tag"},{"slug":"web-development","name":"Web Development","postCount":39958,"virtuals":{"isFollowing":false},"metadata":{"followerCount":35711,"postCount":39958,"coverImage":{"id":"1*BVoyx8ImTwpRv36xVy6RyQ.png","originalWidth":3540,"originalHeight":2346,"isFeatured":true}},"type":"Tag"},{"slug":"reactjs","name":"Reactjs","postCount":718,"virtuals":{"isFollowing":false},"metadata":{"followerCount":3748,"postCount":718,"coverImage":{"id":"1*6f1XFtCP9Ki04onTv-QEHw.png","originalWidth":5114,"originalHeight":1314,"isFeatured":true,"focusPercentX":24,"focusPercentY":53}},"type":"Tag"},{"slug":"twitter","name":"Twitter","postCount":35074,"virtuals":{"isFollowing":false},"metadata":{"followerCount":25149,"postCount":35074,"coverImage":{"id":"1*6f1XFtCP9Ki04onTv-QEHw.png","originalWidth":5114,"originalHeight":1314,"isFeatured":true,"focusPercentX":24,"focusPercentY":53}},"type":"Tag"},{"slug":"progressive-web-app","name":"Progressive Web App","postCount":273,"virtuals":{"isFollowing":false},"metadata":{"followerCount":742,"postCount":273,"coverImage":{"id":"1*6f1XFtCP9Ki04onTv-QEHw.png","originalWidth":5114,"originalHeight":1314,"isFeatured":true,"focusPercentX":24,"focusPercentY":53}},"type":"Tag"}],"socialRecommendsCount":0,"responsesCreatedCount":14,"links":{"entries":[],"version":"0.3","generatedAt":1492100742961},"isLockedPreviewOnly":false,"takeoverId":"","metaDescription":"","totalClapCount":0},"coverless":true,"slug":"twitter-lite-and-high-performance-react-progressive-web-apps-at-scale","translationSourcePostId":"","translationSourceCreatorId":"","isApprovedTranslation":false,"inResponseToPostId":"","inResponseToRemovedAt":0,"isTitleSynthesized":true,"allowResponses":true,"importedUrl":"","importedPublishedAt":0,"visibility":0,"uniqueSlug":"twitter-lite-and-high-performance-react-progressive-web-apps-at-scale-d28a00e780a3","previewContent":{"bodyModel":{"paragraphs":[{"name":"previewImage","type":4,"text":"","layout":10,"metadata":{"id":"1*6f1XFtCP9Ki04onTv-QEHw.png","originalWidth":5114,"originalHeight":1314,"isFeatured":true,"focusPercentX":24,"focusPercentY":53}},{"name":"19d3","type":3,"text":"Twitter Lite and High Performance React Progressive Web Apps at Scale","markups":[],"alignment":1},{"name":"5ca1","type":6,"text":"A look into removing common and uncommon…","markups":[],"alignment":1}],"sections":[{"startIndex":0}]},"isFullContent":false},"license":0,"inResponseToMediaResourceId":"","canonicalUrl":"https://medium.com/@paularmstrong/twitter-lite-and-high-performance-react-progressive-web-apps-at-scale-d28a00e780a3","approvedHomeCollectionId":"","newsletterId":"","webCanonicalUrl":"https://medium.com/@paularmstrong/twitter-lite-and-high-performance-react-progressive-web-apps-at-scale-d28a00e780a3","mediumUrl":"https://medium.com/@paularmstrong/twitter-lite-and-high-performance-react-progressive-web-apps-at-scale-d28a00e780a3","migrationId":"","notifyFollowers":true,"notifyTwitter":false,"isSponsored":false,"isRequestToPubDisabled":true,"notifyFacebook":false,"responseHiddenOnParentPostAt":0,"isSeries":false,"isSubscriptionLocked":false,"seriesLastAppendedAt":0,"type":"Post"},"mentionedUsers":[{"userId":"852b96450d4c","name":"Nicolas Gallagher","username":"necolas","createdAt":1376890265460,"lastPostCreatedAt":1460160361554,"imageId":"1*xbDcVWJrCCQ2gdEDZz0bZg.jpeg","backgroundImageId":"","bio":"Does things at @twitter","twitterScreenName":"necolas","facebookAccountId":"","allowNotes":0,"mediumMemberAt":0,"mediumMemberWaitlistedAt":0,"type":"User"}],"collaborators":[{"user":{"userId":"852b96450d4c","name":"Nicolas Gallagher","username":"necolas","createdAt":1376890265460,"lastPostCreatedAt":1460160361554,"imageId":"1*xbDcVWJrCCQ2gdEDZz0bZg.jpeg","backgroundImageId":"","bio":"Does things at @twitter","twitterScreenName":"necolas","facebookAccountId":"","allowNotes":0,"mediumMemberAt":0,"mediumMemberWaitlistedAt":0,"type":"User"},"state":"visible"},{"user":{"userId":"82c9e373c053","name":"Jon Koon","username":"jondkoon","createdAt":1345214100068,"lastPostCreatedAt":1438732535327,"imageId":"0*KzH2bCIksJ7BxB2g.png","backgroundImageId":"","bio":"","twitterScreenName":"jondkoon","facebookAccountId":"","allowNotes":1,"mediumMemberAt":0,"mediumMemberWaitlistedAt":0,"type":"User"},"state":"visible"},{"user":{"userId":"4f89e3965db7","name":"Jan Castor","username":"jqnbox","createdAt":1472545710113,"lastPostCreatedAt":0,"imageId":"0*_KoI1ZIQUqrxM1wh.jpg","backgroundImageId":"","bio":"","twitterScreenName":"jqnbox","facebookAccountId":"","allowNotes":1,"mediumMemberAt":0,"mediumMemberWaitlistedAt":0,"type":"User"},"state":"visible"},{"user":{"userId":"a45c7adc4f45","name":"Zero Cho","username":"itszero","createdAt":1370230520379,"lastPostCreatedAt":1491943054432,"imageId":"1*Gr9fB1cQZTnZuUEKLGp-eA.jpeg","backgroundImageId":"","bio":"#TaiwanNo1! Proud Twitter Lite eng @twitter. Learning a bit of everything. Motorcyclist.","twitterScreenName":"itszero","facebookAccountId":"10154292996241019","allowNotes":1,"mediumMemberAt":0,"mediumMemberWaitlistedAt":0,"type":"User"},"state":"visible"}],"membershipPlans":[],"collectionUserRelations":[],"mode":null,"references":{"User":{"b97642f6668f":{"userId":"b97642f6668f","name":"Paul Armstrong","username":"paularmstrong","createdAt":1356715290527,"lastPostCreatedAt":1492208310971,"imageId":"1*dgq6_20nGwOd_-UZeUXbQA.jpeg","backgroundImageId":"","bio":"Writing React.js on @Twitter Lite.","twitterScreenName":"paularmstrong","socialStats":{"userId":"b97642f6668f","usersFollowedCount":57,"usersFollowedByCount":795,"type":"SocialStats"},"social":{"userId":"lo_ca790359e5ee","targetUserId":"b97642f6668f","type":"Social"},"facebookAccountId":"","allowNotes":1,"type":"User"}},"Social":{"b97642f6668f":{"userId":"lo_ca790359e5ee","targetUserId":"b97642f6668f","type":"Social"}},"SocialStats":{"b97642f6668f":{"userId":"b97642f6668f","usersFollowedCount":57,"usersFollowedByCount":795,"type":"SocialStats"}}}})
// ]]></script></body></html>